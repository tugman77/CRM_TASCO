<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CRM ê³ ê°ê´€ë¦¬</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #22263a;
    --border: #2d3250;
    --accent: #4f7cff;
    --accent2: #ff6b6b;
    --accent3: #43e97b;
    --accent4: #f7971e;
    --text: #e8eaf6;
    --muted: #7986cb;
    --danger: #ef5350;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Noto Sans KR', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; }

  /* â”€â”€ SIDEBAR (PC) â”€â”€ */
  .sidebar {
    width: 220px; min-height: 100vh; background: var(--surface);
    border-right: 1px solid var(--border); display: flex; flex-direction: column;
    padding: 20px 0; position: fixed; left: 0; top: 0; bottom: 0; z-index: 200;
    transition: transform 0.25s ease;
  }
  .logo { padding: 0 20px 16px; border-bottom: 1px solid var(--border); margin-bottom: 10px; }
  .logo h1 { font-size: 18px; font-weight: 700; color: var(--accent); }
  .logo span { font-size: 11px; color: var(--muted); font-family: 'IBM Plex Mono', monospace; }
  .sidebar-btn {
    margin: 2px 10px; padding: 9px 14px; border-radius: 8px; border: none;
    background: transparent; color: var(--text); font-family: 'Noto Sans KR', sans-serif;
    font-size: 13px; cursor: pointer; text-align: left; transition: all 0.15s;
    display: flex; align-items: center; gap: 9px; width: calc(100% - 20px);
  }
  .sidebar-btn:hover { background: var(--surface2); }
  .sidebar-btn.active { background: var(--accent); color: #fff; }
  .today-badge {
    margin-left: auto; background: #ff6b6b; color: #fff;
    font-size: 10px; font-weight: 700; font-family: 'IBM Plex Mono', monospace;
    padding: 1px 6px; border-radius: 10px; min-width: 18px; text-align: center;
    line-height: 16px; height: 16px; display: inline-block; flex-shrink: 0;
  }
  .sidebar-btn.active .today-badge { background: rgba(255,255,255,0.3); color: #fff; }
  .sidebar-stats { margin-top: auto; padding: 14px 20px; border-top: 1px solid var(--border); font-size: 11px; color: var(--muted); font-family: 'IBM Plex Mono', monospace; }
  .stat-row { display: flex; justify-content: space-between; margin: 3px 0; }
  .stat-row span:last-child { color: var(--accent); }

  /* â”€â”€ MAIN (PC) â”€â”€ */
  .main { margin-left: 220px; flex: 1; display: flex; flex-direction: column; min-height: 100vh; }
  .topbar { padding: 12px 20px; border-bottom: 1px solid var(--border); background: var(--surface); display: flex; align-items: center; gap: 10px; position: sticky; top: 0; z-index: 100; }
  .search-wrap { position: relative; flex: 1; min-width: 0; }
  .search-wrap input { width: 100%; padding: 8px 12px 8px 34px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 13px; font-family: 'Noto Sans KR', sans-serif; outline: none; transition: border-color 0.2s; }
  .search-wrap input:focus { border-color: var(--accent); }
  .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--muted); font-size: 14px; }
  .view-toggle { display: flex; gap: 3px; flex-shrink: 0; }
  .toggle-btn { padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border); background: transparent; color: var(--muted); cursor: pointer; font-size: 14px; transition: all 0.15s; }
  .toggle-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }
  .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-family: 'Noto Sans KR', sans-serif; font-size: 13px; font-weight: 500; transition: all 0.15s; display: inline-flex; align-items: center; gap: 5px; white-space: nowrap; flex-shrink: 0; }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-primary:hover { background: #3d6bef; }
  .btn-outline { background: transparent; color: var(--text); border: 1px solid var(--border); }
  .btn-outline:hover { background: var(--surface2); }
  .btn-danger { background: var(--danger); color: #fff; }
  .btn-sm { padding: 5px 10px; font-size: 12px; }
  .btn-xs { padding: 3px 7px; font-size: 11px; border-radius: 5px; }

  /* â”€â”€ ëª¨ë°”ì¼ í•˜ë‹¨ íƒ­ë°” â”€â”€ */
  .mobile-tabbar {
    display: none;
    position: fixed; bottom: 0; left: 0; right: 0; z-index: 300;
    background: var(--surface); border-top: 1px solid var(--border);
    padding: 6px 0 calc(6px + env(safe-area-inset-bottom));
    grid-template-columns: repeat(4, 1fr);
  }
  .mobile-tab {
    display: flex; flex-direction: column; align-items: center; gap: 3px;
    padding: 6px 4px; border: none; background: transparent; color: var(--muted);
    font-family: 'Noto Sans KR', sans-serif; font-size: 10px; cursor: pointer;
    position: relative; transition: color 0.15s;
  }
  .mobile-tab .tab-icon { font-size: 20px; line-height: 1; }
  .mobile-tab.active { color: var(--accent); }
  .mobile-tab .today-badge { position: absolute; top: 4px; right: calc(50% - 18px); }

  /* ëª¨ë°”ì¼ í—¤ë” */
  .mobile-header {
    display: none; position: fixed; top: 0; left: 0; right: 0; z-index: 200;
    background: var(--surface); border-bottom: 1px solid var(--border);
    padding: 10px 14px; align-items: center; gap: 10px; height: 52px;
  }
  .mobile-header h1 { font-size: 16px; font-weight: 700; color: var(--accent); flex: 1; }

  .content { padding: 20px 24px; flex: 1; }
  .section-title { font-size: 17px; font-weight: 700; margin-bottom: 4px; }
  .section-sub { font-size: 12px; color: var(--muted); margin-bottom: 12px; }
  .filter-bar { display: flex; gap: 6px; margin-bottom: 16px; flex-wrap: wrap; }
  .filter-chip { padding: 4px 12px; border-radius: 20px; border: 1px solid var(--border); background: transparent; color: var(--muted); font-size: 12px; cursor: pointer; font-family: 'Noto Sans KR', sans-serif; transition: all 0.15s; }
  .filter-chip:hover { border-color: var(--accent); color: var(--text); }
  .filter-chip.active { background: var(--accent); border-color: var(--accent); color: #fff; }
  .filter-bar-label { font-size: 10px; color: var(--muted); font-family: 'IBM Plex Mono', monospace; align-self: center; margin-right: 4px; white-space: nowrap; }
  /* íŒ€ í•„í„°ë°” êµ¬ë¶„ì„  */
  .filter-bar + .filter-bar { padding-top: 8px; border-top: 1px solid var(--border); }

  /* â”€â”€ ëª¨ë°”ì¼ ë°˜ì‘í˜• â”€â”€ */
  @media (max-width: 768px) {
    body { flex-direction: column; }
    .sidebar { display: none !important; }
    .main { margin-left: 0 !important; padding-top: 52px; padding-bottom: 70px; }
    .mobile-header { display: flex; }
    .mobile-tabbar { display: grid; }
    .topbar {
      padding: 8px 12px; gap: 8px;
      position: sticky; top: 52px;
    }
    .pc-only { display: none !important; }
    .content { padding: 14px 12px; }
    .section-title { font-size: 15px; }
    .members-row { grid-template-columns: 1fr !important; }
    .modal { width: 100% !important; max-width: 100vw !important; max-height: 92vh; border-radius: 16px 16px 0 0 !important; margin: auto 0 0 0 !important; }
    .modal-overlay { align-items: flex-end !important; }
    .list-wrap { overflow-x: auto; }
    .shared-bar { flex-wrap: wrap; gap: 6px; }
    .fin-summary { gap: 12px; }
    .view-toggle .toggle-btn { padding: 6px 8px; font-size: 13px; }
  }

  @media (max-width: 480px) {
    .topbar { flex-wrap: wrap; }
    .search-wrap { order: -1; width: 100%; flex-basis: 100%; }
    .view-toggle { gap: 2px; }
  }

  /* Company Group */
  .company-group { background: #12151f; border: 1px solid var(--border); border-radius: 14px; margin-bottom: 18px; overflow: hidden; }
  .company-header { padding: 14px 18px; display: flex; align-items: center; gap: 12px; cursor: pointer; user-select: none; background: var(--surface); border-bottom: 1px solid var(--border); transition: background 0.15s; }
  .company-header:hover { background: var(--surface2); }
  .company-logo { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 17px; font-weight: 700; color: #fff; flex-shrink: 0; }
  .company-info { flex: 1; min-width: 0; }
  .company-name { font-size: 15px; font-weight: 700; }
  .company-meta { font-size: 11px; color: var(--muted); margin-top: 3px; display: flex; gap: 12px; flex-wrap: wrap; }
  .company-badges { display: flex; gap: 5px; flex-wrap: wrap; }
  .company-toggle { color: var(--muted); font-size: 13px; transition: transform 0.2s; flex-shrink: 0; margin-left: 8px; }
  .company-group.collapsed .company-toggle { transform: rotate(-90deg); }
  .company-body { }
  .company-group.collapsed .company-body { display: none; }

  /* Shared bar */
  .shared-bar { padding: 8px 18px; background: rgba(79,124,255,0.06); border-bottom: 1px solid var(--border); display: flex; gap: 16px; flex-wrap: wrap; font-size: 12px; color: var(--muted); align-items: center; }
  .shared-tag { font-family: 'IBM Plex Mono', monospace; font-size: 10px; background: rgba(79,124,255,0.15); color: var(--accent); padding: 1px 6px; border-radius: 4px; }
  .shared-edit-btn { margin-left: auto; background: none; border: 1px solid var(--border); color: var(--muted); border-radius: 5px; padding: 2px 8px; font-size: 11px; cursor: pointer; font-family: 'Noto Sans KR', sans-serif; transition: all 0.15s; }
  .shared-edit-btn:hover { color: var(--text); border-color: var(--accent); }

  /* Members row */
  .members-row { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px; padding: 14px 18px; border-bottom: 1px solid var(--border); }
  .person-card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 12px; cursor: pointer; transition: all 0.15s; position: relative; }
  .person-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; background: var(--accent); border-radius: 10px 0 0 10px; }
  .person-card:hover { border-color: var(--accent); transform: translateY(-1px); box-shadow: 0 4px 14px rgba(79,124,255,0.12); }
  .person-head { display: flex; align-items: center; gap: 9px; margin-bottom: 8px; }
  .avatar { width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 700; color: #fff; flex-shrink: 0; }
  .person-name { font-size: 14px; font-weight: 600; }
  .person-dept { font-size: 11px; color: var(--muted); margin-top: 1px; }
  .person-contacts { font-size: 12px; color: var(--text); line-height: 2; }
  .person-contacts span { display: block; }
  .pc-label { display: inline-block; font-size: 10px; font-family: 'IBM Plex Mono', monospace; color: var(--muted); background: var(--surface2); border: 1px solid var(--border); border-radius: 3px; padding: 0 5px; margin-right: 5px; vertical-align: middle; }
  .person-badges { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 7px; }
  .add-card { background: transparent; border: 1px dashed var(--border); border-radius: 10px; padding: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 7px; color: var(--muted); font-size: 12px; transition: all 0.15s; font-family: 'Noto Sans KR', sans-serif; }
  .add-card:hover { border-color: var(--accent); color: var(--accent); }

  /* Activity badge - dynamically injected via JS */
  .co-timeline-section { padding: 14px 18px; }
  .co-timeline-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
  .co-timeline-label { font-size: 11px; font-family: 'IBM Plex Mono', monospace; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
  .timeline { position: relative; }
  .timeline::before { content: ''; position: absolute; left: 14px; top: 6px; bottom: 6px; width: 1px; background: var(--border); }
  .timeline-item { display: flex; gap: 12px; margin-bottom: 12px; }
  .timeline-dot { width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 12px; position: relative; z-index: 1; }
  .dot-call { background: rgba(79,124,255,0.15); color: var(--accent); border: 1px solid var(--accent); }
  .tl-body { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 9px 12px; flex: 1; }
  .tl-meta { display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px; }
  .tl-type { font-size: 12px; font-weight: 600; }
  .tl-date { font-size: 11px; color: var(--muted); font-family: 'IBM Plex Mono', monospace; }
  .tl-who { font-size: 11px; color: var(--accent); margin-bottom: 3px; cursor: pointer; }
  .tl-who:hover { text-decoration: underline; }
  .tl-text { font-size: 12px; color: var(--muted); line-height: 1.6; }
  .tl-amount { font-size: 11px; color: var(--accent3); font-family: 'IBM Plex Mono', monospace; margin-top: 2px; }
  .show-more-btn { width: 100%; padding: 7px; background: none; border: 1px dashed var(--border); border-radius: 6px; color: var(--muted); font-size: 12px; cursor: pointer; font-family: 'Noto Sans KR', sans-serif; margin-top: 4px; transition: all 0.15s; }
  .show-more-btn:hover { border-color: var(--accent); color: var(--accent); }

  /* Ungrouped */
  .ungrouped-label { font-size: 12px; color: var(--muted); font-family: 'IBM Plex Mono', monospace; margin-bottom: 10px; }
  .ungrouped-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px; }

  /* Modal */
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.72); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
  .modal-overlay.open { display: flex; }
  .modal { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; width: 640px; max-width: 95vw; max-height: 92vh; overflow-y: auto; padding: 26px; position: relative; }
  .modal-title { font-size: 17px; font-weight: 700; margin-bottom: 20px; }
  .modal-close { position: absolute; top: 13px; right: 13px; background: var(--surface2); border: none; color: var(--text); width: 28px; height: 28px; border-radius: 6px; cursor: pointer; font-size: 15px; display: flex; align-items: center; justify-content: center; }
  .modal-close:hover { background: var(--danger); }
  .form-section { margin-bottom: 18px; }
  .form-section-title { font-size: 10px; font-family: 'IBM Plex Mono', monospace; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 9px; padding-bottom: 7px; border-bottom: 1px solid var(--border); }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
  .form-row.three { grid-template-columns: 1fr 1fr 1fr; }
  .form-row.single { grid-template-columns: 1fr; }
  .form-group { display: flex; flex-direction: column; gap: 5px; }
  .form-group label { font-size: 11px; color: var(--muted); }
  .form-group input, .form-group textarea, .form-group select { padding: 8px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 7px; color: var(--text); font-size: 13px; font-family: 'Noto Sans KR', sans-serif; outline: none; transition: border-color 0.2s; width: 100%; }
  .form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color: var(--accent); }
  .form-group select option { background: var(--surface); }
  .form-group textarea { resize: vertical; min-height: 68px; }
  .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 18px; }

  /* Detail view */
  .detail-view { display: none; padding: 24px 28px; }
  .detail-view.open { display: block; }
  .detail-header { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 22px; margin-bottom: 16px; display: flex; align-items: center; gap: 18px; flex-wrap: wrap; }
  .detail-avatar { width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 700; color: #fff; flex-shrink: 0; }
  .detail-name { font-size: 20px; font-weight: 700; }
  .detail-sub { font-size: 13px; color: var(--muted); margin-top: 3px; }
  .detail-actions { margin-left: auto; display: flex; gap: 7px; flex-wrap: wrap; }
  .info-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; margin-bottom: 16px; }
  .info-card { background: var(--surface); border: 1px solid var(--border); border-radius: 9px; padding: 12px; }
  .info-card-label { font-size: 10px; color: var(--muted); font-family: 'IBM Plex Mono', monospace; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px; }
  .info-card-value { font-size: 13px; }
  .acts-section { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 18px; }
  .acts-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
  .acts-title { font-size: 14px; font-weight: 600; }
  .empty-state { text-align: center; padding: 36px 20px; color: var(--muted); }
  .empty-icon { font-size: 36px; margin-bottom: 10px; }

  /* List view */
  .list-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
  .list-table { width: 100%; border-collapse: collapse; }
  .list-table th { text-align: left; padding: 9px 13px; font-size: 10px; color: var(--muted); font-family: 'IBM Plex Mono', monospace; text-transform: uppercase; border-bottom: 1px solid var(--border); background: var(--surface2); white-space: nowrap; }
  .list-table td { padding: 10px 13px; font-size: 13px; border-bottom: 1px solid var(--border); vertical-align: middle; }
  .list-table tr:last-child td { border-bottom: none; }
  .list-table tbody tr:not(.co-row):hover td { background: var(--surface2); }
  .co-row td { background: rgba(79,124,255,0.06); font-weight: 600; font-size: 13px; cursor: pointer; }
  .co-row:hover td { background: rgba(79,124,255,0.12) !important; }

  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* Company tabs */
  .co-tabs { display:flex; gap:4px; margin-bottom:20px; border-bottom:1px solid var(--border); padding-bottom:0; }
  .co-tab { padding:8px 18px; border:none; background:transparent; color:var(--muted); font-family:'Noto Sans KR',sans-serif; font-size:13px; cursor:pointer; border-bottom:2px solid transparent; margin-bottom:-1px; transition:all 0.15s; }
  .co-tab:hover { color:var(--text); }
  .co-tab.active { color:var(--accent); border-bottom-color:var(--accent); font-weight:600; }
  .co-panel { }

  /* Finance table */
  .fin-table { width:100%; border-collapse:collapse; font-size:13px; }
  .fin-table th { text-align:center; padding:8px 6px; font-size:10px; color:var(--muted); font-family:'IBM Plex Mono',monospace; text-transform:uppercase; border-bottom:1px solid var(--border); background:var(--surface2); white-space:nowrap; }
  .fin-table td { padding:5px 4px; border-bottom:1px solid var(--border); vertical-align:middle; }
  .fin-table tr:last-child td { border-bottom:none; }
  .fin-input { width:100%; padding:5px 7px; background:var(--bg); border:1px solid var(--border); border-radius:5px; color:var(--text); font-size:12px; font-family:'IBM Plex Mono',monospace; outline:none; text-align:right; }
  .fin-input:focus { border-color:var(--accent); }
  .fin-year { width:72px; padding:5px 7px; background:var(--bg); border:1px solid var(--border); border-radius:5px; color:var(--accent); font-size:12px; font-family:'IBM Plex Mono',monospace; outline:none; text-align:center; font-weight:600; }
  .fin-year:focus { border-color:var(--accent); }
  .fin-del { background:none; border:none; color:var(--muted); cursor:pointer; font-size:14px; padding:2px 6px; border-radius:4px; transition:all 0.1s; }
  .fin-del:hover { background:var(--danger); color:#fff; }

  /* CEO history */
  .ceo-row { display:grid; grid-template-columns:100px 1fr 1fr 1fr 32px; gap:8px; align-items:center; margin-bottom:8px; }
  .ceo-input { padding:7px 9px; background:var(--bg); border:1px solid var(--border); border-radius:6px; color:var(--text); font-size:13px; font-family:'Noto Sans KR',sans-serif; outline:none; width:100%; }
  .ceo-input:focus { border-color:var(--accent); }
  .ceo-del { background:none; border:none; color:var(--muted); cursor:pointer; font-size:14px; padding:4px 6px; border-radius:4px; transition:all 0.1s; width:32px; }
  .ceo-del:hover { background:var(--danger); color:#fff; }
  .ceo-header { display:grid; grid-template-columns:100px 1fr 1fr 1fr 32px; gap:8px; margin-bottom:6px; font-size:10px; color:var(--muted); font-family:'IBM Plex Mono',monospace; text-transform:uppercase; }

  /* Finance summary in company card */
  .fin-summary { padding:8px 18px; background:rgba(67,233,123,0.04); border-bottom:1px solid var(--border); display:flex; gap:20px; flex-wrap:wrap; font-size:12px; align-items:center; }
  .fin-chip { display:flex; flex-direction:column; gap:1px; }
  .fin-chip-label { font-size:10px; color:var(--muted); font-family:'IBM Plex Mono',monospace; }
  .fin-chip-value { font-size:13px; font-weight:600; font-family:'IBM Plex Mono',monospace; }
  .fin-chip-value.pos { color:var(--accent3); }
  .fin-chip-value.neg { color:var(--accent2); }
  .fin-chip-value.neu { color:var(--text); }

  /* PDF Import */
  .pdf-dropzone {
    border: 2px dashed var(--border); border-radius: 10px; padding: 36px 20px;
    text-align: center; cursor: pointer; transition: all 0.2s;
  }
  .pdf-dropzone:hover, .pdf-dropzone.drag { border-color: var(--accent); background: rgba(79,124,255,0.05); }
  .pdf-drop-icon { font-size: 36px; margin-bottom: 10px; }
  .pdf-drop-text { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
  .pdf-drop-sub { font-size: 12px; color: var(--muted); }
  .pdf-spinner {
    width: 44px; height: 44px; border: 3px solid var(--border);
    border-top-color: var(--accent); border-radius: 50%;
    animation: spin 0.8s linear infinite; margin: 0 auto;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .pdf-contact-card {
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 10px; padding: 14px 16px; margin-bottom: 10px;
  }
  .pdf-contact-card.checked { border-color: var(--accent); }
  .pdf-card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
  .pdf-card-check { width: 18px; height: 18px; accent-color: var(--accent); cursor: pointer; flex-shrink: 0; }
  .pdf-card-name { font-size: 14px; font-weight: 700; flex: 1; }
  .pdf-fields { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .pdf-field { display: flex; flex-direction: column; gap: 3px; }
  .pdf-field label { font-size: 10px; color: var(--muted); font-family: 'IBM Plex Mono', monospace; text-transform: uppercase; }
  .pdf-field input { padding: 6px 9px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 12px; font-family: 'Noto Sans KR', sans-serif; outline: none; }
  .pdf-field input:focus { border-color: var(--accent); }
  .pdf-field.full { grid-column: 1 / -1; }
</style>
</head>
<body>

<!-- â”€â”€ ëª¨ë°”ì¼ í—¤ë” â”€â”€ -->
<header class="mobile-header">
  <h1>â–¸ CRM</h1>
  <div style="display:flex;gap:6px;margin-left:auto;align-items:center">
    <button class="btn btn-outline btn-sm" onclick="openPdfModal()" style="padding:5px 8px;font-size:12px">ğŸ—‚</button>
    <button class="btn btn-primary btn-sm" onclick="openAddContact(null)" style="padding:5px 10px;font-size:12px">ï¼‹</button>
  </div>
</header>

<aside class="sidebar">
  <div class="logo">
    <h1>â–¸ CRM</h1>
    <span>ê³ ê°ê´€ë¦¬ ì‹œìŠ¤í…œ</span>
  </div>
  <button class="sidebar-btn active" id="navContacts" onclick="nav('contacts')"><span>ğŸ¢</span> ì—°ë½ì²˜ <span class="today-badge" id="todayContacts" style="display:none"></span></button>
  <button class="sidebar-btn" id="navActivities" onclick="nav('activities')"><span>ğŸ“‹</span> ì „ì²´ í™œë™ <span class="today-badge" id="todayActivities" style="display:none"></span></button>
  <button class="sidebar-btn" onclick="openTypeModal()"><span>ğŸ·</span> í™œë™ ìœ í˜• ê´€ë¦¬</button>
  <button class="sidebar-btn" onclick="openGsModal()"><span>â˜ï¸</span> Google Sheets ì—°ë™</button>
  <div id="gsSyncStatus" style="font-size:10px;padding:6px 20px;color:var(--muted);font-family:'IBM Plex Mono',monospace;line-height:1.5"></div>
  <div class="sidebar-stats" id="sidebarStats"></div>
</aside>

<main class="main">
  <div class="topbar" id="mainTopbar">
    <div class="search-wrap">
      <span class="search-icon">ğŸ”</span>
      <input type="text" id="searchInput" placeholder="ì´ë¦„, íšŒì‚¬ ê²€ìƒ‰..." oninput="renderContacts()">
    </div>
    <div class="view-toggle">
      <button class="toggle-btn active" id="vBtn-group" title="íšŒì‚¬ë³„ ì¹´ë“œ" onclick="setViewMode('group')">âŠ</button>
      <button class="toggle-btn" id="vBtn-glist" title="íšŒì‚¬ë³„ ëª©ë¡" onclick="setViewMode('glist')">â–¤</button>
      <button class="toggle-btn" id="vBtn-list" title="ì „ì²´ ëª©ë¡" onclick="setViewMode('list')">â˜°</button>
    </div>
    <button class="btn btn-outline pc-only" onclick="openPdfModal()" title="íŒŒì¼ì—ì„œ ì—°ë½ì²˜ ìë™ ì¶”ì¶œ">ğŸ—‚ íŒŒì¼ ê°€ì ¸ì˜¤ê¸°</button>
    <button class="btn btn-primary pc-only" onclick="openAddContact(null)">ï¼‹ ì—°ë½ì²˜</button>
  </div>

  <!-- Contacts View -->
  <div class="content" id="contactsView">
    <div class="section-title">ì—°ë½ì²˜</div>
    <div class="section-sub" id="viewSub"></div>
    <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:14px">
      <div class="filter-bar" id="teamFilterBar"></div>
    </div>
    <div id="mainGrid"></div>
  </div>

  <!-- Detail View -->
  <div id="detailView" class="detail-view">
    <div style="display:flex;gap:8px;margin-bottom:14px">
      <button class="btn btn-outline btn-sm" onclick="backToList()">â† ëª©ë¡ìœ¼ë¡œ</button>
      <button class="btn btn-outline btn-sm" id="detailCoBtn" style="display:none">ğŸ¢ íšŒì‚¬ ë³´ê¸°</button>
    </div>
    <div id="detailContent"></div>
  </div>

  <!-- Activities View -->
  <div class="content" id="activitiesView" style="display:none">
    <div class="section-title">ì „ì²´ í™œë™</div>
    <div class="section-sub" id="actsSub">ëª¨ë“  í™œë™ ë‚´ì—­ (ìµœì‹ ìˆœ)</div>
    <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:16px">
      <div class="filter-bar" id="actFilterBar" style="margin-bottom:0"></div>
      <div class="filter-bar" id="actTeamFilterBar" style="margin-bottom:0"></div>
    </div>
    <div id="allActsContent"></div>
  </div>
</main>

<!-- â”€â”€ ëª¨ë°”ì¼ í•˜ë‹¨ íƒ­ë°” â”€â”€ -->
<nav class="mobile-tabbar">
  <button class="mobile-tab active" id="mTabContacts" onclick="nav('contacts')">
    <span class="tab-icon">ğŸ¢</span>
    <span>ì—°ë½ì²˜</span>
    <span class="today-badge" id="mTodayContacts" style="display:none"></span>
  </button>
  <button class="mobile-tab" id="mTabActivities" onclick="nav('activities')">
    <span class="tab-icon">ğŸ“‹</span>
    <span>í™œë™</span>
    <span class="today-badge" id="mTodayActivities" style="display:none"></span>
  </button>
  <button class="mobile-tab" id="mTabImport" onclick="openPdfModal()">
    <span class="tab-icon">ğŸ—‚</span>
    <span>ê°€ì ¸ì˜¤ê¸°</span>
  </button>
  <button class="mobile-tab" id="mTabType" onclick="openTypeModal()">
    <span class="tab-icon">ğŸ·</span>
    <span>ìœ í˜•ê´€ë¦¬</span>
  </button>
</nav>

<!-- Contact Modal -->
<div class="modal-overlay" id="contactModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('contactModal')">âœ•</button>
    <div class="modal-title" id="cModalTitle">ìƒˆ ì—°ë½ì²˜</div>
    <div class="form-section">
      <div class="form-section-title">ì†Œì† íšŒì‚¬</div>
      <div class="form-row single">
        <div class="form-group">
          <label>íšŒì‚¬ëª… (ê°™ì€ íšŒì‚¬ ì§ì›ì€ ë™ì¼ ì´ë¦„ ì…ë ¥)</label>
          <input type="text" id="f_company" placeholder="(ì£¼)ì˜ˆì‹œê¸°ì—…" list="coSuggestions" oninput="onCompanyInput()">
          <datalist id="coSuggestions"></datalist>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>ë¶€ì„œ</label><input type="text" id="f_dept" placeholder="ì˜ì—…íŒ€"></div>
        <div class="form-group"><label>ì§ì±…</label><input type="text" id="f_position" placeholder="ê³¼ì¥"></div>
      </div>
    </div>
    <div class="form-section">
      <div class="form-section-title">ê°œì¸ ì •ë³´</div>
      <div class="form-row">
        <div class="form-group"><label>ì„± *</label><input type="text" id="f_last" placeholder="ê¹€"></div>
        <div class="form-group"><label>ì´ë¦„ *</label><input type="text" id="f_first" placeholder="ì² ìˆ˜"></div>
      </div>
      <div class="form-row single">
        <div class="form-group"><label>ì´ë©”ì¼</label><input type="email" id="f_email" placeholder="example@email.com"></div>
      </div>
    </div>
    <div class="form-section">
      <div class="form-section-title">ê°œì¸ ì—°ë½ì²˜</div>
      <div class="form-row three">
        <div class="form-group"><label>ì‚¬ë¬´ì‹¤</label><input type="tel" id="f_office" placeholder="02-0000-0000"></div>
        <div class="form-group"><label>íœ´ëŒ€í°</label><input type="tel" id="f_mobile" placeholder="010-0000-0000"></div>
        <div class="form-group"><label>ì¶”ê°€</label><input type="tel" id="f_extra" placeholder="íŒ©ìŠ¤ ë“±"></div>
      </div>
    </div>
    <div class="form-section">
      <div class="form-section-title">ì£¼ì†Œ (íšŒì‚¬ ê³µìœ )</div>
      <div id="addrNotice" style="font-size:11px;color:var(--accent);margin-bottom:7px;display:none">â„¹ ë“±ë¡ëœ íšŒì‚¬ ì£¼ì†Œê°€ ì ìš©ë©ë‹ˆë‹¤. ë³€ê²½í•˜ë©´ íšŒì‚¬ ì „ì²´ì— ë°˜ì˜ë©ë‹ˆë‹¤.</div>
      <div class="form-row single">
        <div class="form-group"><label>ì£¼ì†Œ</label><input type="text" id="f_address" placeholder="ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123"></div>
      </div>
    </div>
    <div class="form-section">
      <div class="form-section-title">ë©”ëª¨</div>
      <div class="form-row single">
        <div class="form-group"><textarea id="f_memo" placeholder="íŠ¹ì´ì‚¬í•­, ê´€ê³„ ë“±"></textarea></div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal('contactModal')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="saveContact()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- Company Modal -->
<div class="modal-overlay" id="companyModal">
  <div class="modal" style="width:680px">
    <button class="modal-close" onclick="closeModal('companyModal')">âœ•</button>
    <div class="modal-title" id="coModalTitle">íšŒì‚¬ ì •ë³´</div>

    <!-- íƒ­ -->
    <div class="co-tabs">
      <button class="co-tab active" id="coTab-basic" onclick="switchCoTab('basic')">ê¸°ë³¸ ì •ë³´</button>
      <button class="co-tab" id="coTab-finance" onclick="switchCoTab('finance')">ì¬ë¬´ í˜„í™©</button>
      <button class="co-tab" id="coTab-ceo" onclick="switchCoTab('ceo')">ëŒ€í‘œì´ì‚¬ ì´ë ¥</button>
    </div>

    <!-- íƒ­: ê¸°ë³¸ ì •ë³´ -->
    <div id="coPanel-basic" class="co-panel">
      <div class="form-section">
        <div class="form-section-title">íšŒì‚¬ëª…</div>
        <div class="form-row single">
          <div class="form-group">
            <label>íšŒì‚¬ëª… (ìˆ˜ì • ì‹œ ì†Œì† ì§ì› ì „ì²´ì— ìë™ ë°˜ì˜)</label>
            <input type="text" id="co_name" placeholder="íšŒì‚¬ëª…">
          </div>
        </div>
      </div>
      <div class="form-section">
        <div class="form-section-title">ìš°ë¦¬ íŒ€ ë‹´ë‹¹ì</div>
        <p style="font-size:11px;color:var(--muted);margin-bottom:8px;line-height:1.6">ì´ íšŒì‚¬ë¥¼ ë‹´ë‹¹í•˜ëŠ” ìš°ë¦¬ íŒ€ ì •ë³´ë¥¼ ê¸°ë¡í•©ë‹ˆë‹¤.</p>
        <div class="form-row">
          <div class="form-group"><label>íŒ€ëª…</label><input type="text" id="co_our_team" placeholder="ì˜ì—…1íŒ€"></div>
          <div class="form-group"><label>ë‹´ë‹¹ì ì´ë¦„</label><input type="text" id="co_our_name" placeholder="í™ê¸¸ë™"></div>
        </div>
        <div class="form-row single">
          <div class="form-group"><label>ë©”ëª¨</label><input type="text" id="co_our_memo" placeholder="ì£¼ë‹´ë‹¹ì / 2024.01 ì¸ìˆ˜ì¸ê³„"></div>
        </div>
      </div>

      <div class="form-section">
        <div class="form-section-title">ë‹¤ë¥¸ íšŒì‚¬ì™€ ë³‘í•©</div>
        <p style="font-size:11px;color:var(--muted);margin-bottom:8px;line-height:1.6">ê°™ì€ íšŒì‚¬ê°€ ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ë“±ë¡ëœ ê²½ìš° ë³‘í•©í•©ë‹ˆë‹¤. ë³‘í•© ëŒ€ìƒì˜ ëª¨ë“  ì§ì›ì´ í˜„ì¬ íšŒì‚¬ë¡œ ì´ë™ë©ë‹ˆë‹¤.</p>
        <div class="form-row single">
          <div class="form-group">
            <label>ë³‘í•©í•  íšŒì‚¬ ì„ íƒ (ì—†ì• ê³  ì‹¶ì€ ìª½)</label>
            <select id="co_merge_target" style="background:var(--bg);border:1px solid var(--border);border-radius:7px;color:var(--text);padding:8px 10px;font-size:13px;font-family:inherit;outline:none;width:100%">
              <option value="">â€” ë³‘í•© ì•ˆ í•¨ â€”</option>
            </select>
          </div>
        </div>
        <div id="co_merge_preview" style="display:none;font-size:12px;color:var(--accent);margin-top:6px;padding:8px 12px;background:rgba(79,124,255,0.08);border-radius:6px;border:1px solid rgba(79,124,255,0.2)"></div>
      </div>
      <div class="form-section">
        <div class="form-section-title">ëŒ€í‘œ ì—°ë½ì²˜</div>
        <div class="form-row">
          <div class="form-group"><label>ëŒ€í‘œ ì „í™”</label><input type="tel" id="co_phone" placeholder="02-0000-0000"></div>
          <div class="form-group"><label>íŒ©ìŠ¤</label><input type="tel" id="co_fax" placeholder="02-0000-0001"></div>
        </div>
      </div>
      <div class="form-section">
        <div class="form-section-title">ì£¼ì†Œ</div>
        <div class="form-row single">
          <div class="form-group"><label>ì£¼ì†Œ</label><input type="text" id="co_address" placeholder="ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123"></div>
        </div>
      </div>
      <div class="form-section">
        <div class="form-section-title">ë©”ëª¨</div>
        <div class="form-row single">
          <div class="form-group"><textarea id="co_memo" placeholder="íšŒì‚¬ ê´€ë ¨ ë©”ëª¨"></textarea></div>
        </div>
      </div>
    </div>

    <!-- íƒ­: ì¬ë¬´ í˜„í™© -->
    <div id="coPanel-finance" class="co-panel" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
        <p style="font-size:12px;color:var(--muted)">ì—°ë„ë³„ ì¬ë¬´ ë°ì´í„°ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ë‹¨ìœ„: ë°±ë§Œì›</p>
        <button class="btn btn-primary btn-sm" onclick="addFinanceRow()">ï¼‹ ì—°ë„ ì¶”ê°€</button>
      </div>
      <div style="overflow-x:auto">
        <table class="fin-table" id="finTable">
          <thead>
            <tr>
              <th style="width:80px">ì—°ë„</th>
              <th>ì¸ì›(ëª…)</th>
              <th>ë§¤ì¶œ</th>
              <th>ì˜ì—…ì´ìµ</th>
              <th>ìˆœì´ìµ</th>
              <th>ìì‚°</th>
              <th>ë¶€ì±„</th>
              <th style="width:36px"></th>
            </tr>
          </thead>
          <tbody id="finBody"></tbody>
        </table>
      </div>
      <p style="font-size:11px;color:var(--muted);margin-top:10px">* ê¸ˆì•¡ ë‹¨ìœ„: ë°±ë§Œì› / ë¹ˆì¹¸ì€ ë¯¸ì…ë ¥ìœ¼ë¡œ ì²˜ë¦¬</p>
    </div>

    <!-- íƒ­: ëŒ€í‘œì´ì‚¬ ì´ë ¥ -->
    <div id="coPanel-ceo" class="co-panel" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
        <p style="font-size:12px;color:var(--muted)">ëŒ€í‘œì´ì‚¬ ë³€ê²½ ì´ë ¥ì„ ìµœì‹ ìˆœìœ¼ë¡œ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
        <button class="btn btn-primary btn-sm" onclick="addCeoRow()">ï¼‹ ì¶”ê°€</button>
      </div>
      <div id="ceoList"></div>
    </div>

    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal('companyModal')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="saveCompany()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- Google Sheets ì—°ë™ Modal -->
<div class="modal-overlay" id="gsModal">
  <div class="modal" style="width:520px">
    <button class="modal-close" onclick="closeModal('gsModal')">âœ•</button>
    <div class="modal-title">â˜ï¸ Google Sheets ì—°ë™</div>

    <div id="gsStep0">
      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:16px;font-size:12px;line-height:2;color:var(--muted)">
        <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:8px">ğŸ“‹ ì„¤ì • ë°©ë²• (ìµœì´ˆ 1íšŒ)</div>
        <div><span style="color:var(--accent);font-weight:600">1.</span> <a href="https://sheets.new" target="_blank" style="color:var(--accent)">sheets.new</a> ì—ì„œ ìƒˆ Google Sheets íŒŒì¼ ìƒì„±</div>
        <div><span style="color:var(--accent);font-weight:600">2.</span> ë©”ë‰´ â†’ <b>í™•ì¥ í”„ë¡œê·¸ë¨</b> â†’ <b>Apps Script</b> í´ë¦­</div>
        <div><span style="color:var(--accent);font-weight:600">3.</span> ê¸°ì¡´ ì½”ë“œ ì „ì²´ ì‚­ì œ í›„ <b>Code.gs ë‚´ìš© ë¶™ì—¬ë„£ê¸°</b></div>
        <div><span style="color:var(--accent);font-weight:600">4.</span> ğŸ’¾ ì €ì¥ â†’ <b>ë°°í¬</b> â†’ <b>ìƒˆ ë°°í¬</b></div>
        <div><span style="color:var(--accent);font-weight:600">5.</span> ìœ í˜•: <b>ì›¹ ì•±</b> Â· ì‹¤í–‰: <b>ë‚˜</b> Â· ì•¡ì„¸ìŠ¤: <b>ëª¨ë“  ì‚¬ìš©ì</b></div>
        <div><span style="color:var(--accent);font-weight:600">6.</span> <b>ë°°í¬</b> í´ë¦­ â†’ ê¶Œí•œ í—ˆìš© â†’ <b>URL ë³µì‚¬</b></div>
        <div><span style="color:var(--accent);font-weight:600">7.</span> ì•„ë˜ì— ë¶™ì—¬ë„£ê¸°</div>
      </div>

      <div class="form-group" style="margin-bottom:12px">
        <label style="font-size:12px;color:var(--muted);margin-bottom:6px;display:block">Apps Script ì›¹ ì•± URL</label>
        <input type="text" id="gsUrlInput" placeholder="https://script.google.com/macros/s/...../exec"
          style="width:100%;padding:10px 12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:12px;font-family:'IBM Plex Mono',monospace;outline:none">
        <div id="gsUrlMsg" style="font-size:11px;margin-top:5px;color:var(--muted)"></div>
      </div>

      <div id="gsCurrentStatus" style="display:none;background:rgba(67,233,123,0.08);border:1px solid rgba(67,233,123,0.25);border-radius:8px;padding:10px 14px;font-size:12px;margin-bottom:12px">
        <div style="color:var(--accent3);font-weight:600;margin-bottom:4px">âœ… í˜„ì¬ ì—°ë™ë¨</div>
        <div id="gsCurrentUrl" style="color:var(--muted);font-family:'IBM Plex Mono',monospace;font-size:10px;word-break:break-all"></div>
        <div id="gsLastSyncInfo" style="color:var(--muted);font-size:11px;margin-top:4px"></div>
      </div>

      <div class="modal-actions" style="flex-wrap:wrap;gap:8px">
        <button class="btn btn-outline btn-sm" onclick="closeModal('gsModal')">ë‹«ê¸°</button>
        <button class="btn btn-outline btn-sm" id="gsDisconnectBtn" style="display:none;color:var(--danger);border-color:var(--danger)" onclick="gsDisconnect()">ì—°ë™ í•´ì œ</button>
        <button class="btn btn-outline btn-sm" onclick="gsManualLoad()">â˜ ì§€ê¸ˆ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button class="btn btn-primary btn-sm" onclick="gsSaveUrl()">ì—°ê²° ì €ì¥</button>
      </div>
    </div>
  </div>
</div>

<!-- Contact Delete Confirm Modal -->
<div class="modal-overlay" id="delContactModal">
  <div class="modal" style="width:380px;text-align:center">
    <div style="font-size:40px;margin-bottom:14px">ğŸ—‘</div>
    <div class="modal-title" style="text-align:center;margin-bottom:8px">ì—°ë½ì²˜ ì‚­ì œ</div>
    <div id="delContactInfo" style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px 16px;margin-bottom:16px;font-size:13px"></div>
    <p style="font-size:12px;color:var(--muted);margin-bottom:20px">ì´ ì—°ë½ì²˜ì™€ ê´€ë ¨ í™œë™ì´ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤. ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
    <div style="display:flex;gap:10px;justify-content:center">
      <button class="btn btn-outline" onclick="closeModal('delContactModal')" style="min-width:100px">ì·¨ì†Œ</button>
      <button class="btn btn-danger" id="delContactConfirmBtn" style="min-width:100px">ì‚­ì œ</button>
    </div>
  </div>
</div>

<!-- Merge Confirm Modal -->
<div class="modal-overlay" id="mergeConfirmModal">
  <div class="modal" style="width:420px;text-align:center">
    <div style="font-size:40px;margin-bottom:14px">ğŸ”€</div>
    <div class="modal-title" style="text-align:center;margin-bottom:8px">íšŒì‚¬ ë³‘í•©</div>
    <div id="mergeConfirmInfo" style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px 16px;margin-bottom:16px;text-align:left;font-size:13px;line-height:2"></div>
    <p style="font-size:12px;color:var(--muted);margin-bottom:20px">ë³‘í•© í›„ì—ëŠ” ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
    <div style="display:flex;gap:10px;justify-content:center">
      <button class="btn btn-outline" onclick="closeModal('mergeConfirmModal')" style="min-width:100px">ì·¨ì†Œ</button>
      <button class="btn btn-primary" id="mergeConfirmBtn" style="min-width:100px">ë³‘í•© ì‹¤í–‰</button>
    </div>
  </div>
</div>

<!-- Activity Modal -->
<div class="modal-overlay" id="activityModal">
  <div class="modal" style="width:480px">
    <button class="modal-close" onclick="closeModal('activityModal')">âœ•</button>
    <div class="modal-title" id="actModalTitle">í™œë™ ì¶”ê°€</div>
    <div class="form-section" id="actWhoSection">
      <div class="form-section-title">ë‹´ë‹¹ì</div>
      <div id="actWho" style="font-size:14px;font-weight:600;color:var(--accent);padding:4px 0"></div>
    </div>
    <div class="form-row single">
      <div class="form-group"><label>ìœ í˜• *</label>
        <select id="a_type"></select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>ë‚ ì§œ *</label><input type="date" id="a_date"></div>
      <div class="form-group"><label>ê¸ˆì•¡</label><input type="text" id="a_amount" placeholder="â‚©"></div>
    </div>
    <div class="form-row single">
      <div class="form-group"><label>ì œëª©</label><input type="text" id="a_title" placeholder="ê°„ë‹¨í•œ ì œëª©"></div>
    </div>
    <div class="form-row single">
      <div class="form-group"><label>ë‚´ìš©</label><textarea id="a_content" placeholder="ìƒì„¸ ë‚´ìš©"></textarea></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal('activityModal')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" id="actSaveBtn" onclick="saveActivity()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- Type Manager Modal -->
<div class="modal-overlay" id="typeModal">
  <div class="modal" style="width:480px">
    <button class="modal-close" onclick="closeModal('typeModal')">âœ•</button>
    <div class="modal-title">í™œë™ ìœ í˜• ê´€ë¦¬</div>
    <p style="font-size:12px;color:var(--muted);margin-bottom:14px;line-height:1.7">ìœ í˜•ì„ ì¶”ê°€í•˜ê±°ë‚˜ ìˆœì„œë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>ê¸°ë³¸ ìœ í˜•(ë°œì£¼Â·ê²¬ì Â·ë°©ë¬¸Â·í†µí™”Â·ê¸°íƒ€)ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
    <div id="typeList"></div>
    <div style="margin-top:14px;padding-top:14px;border-top:1px solid var(--border)">
      <div class="form-section-title" style="margin-bottom:10px">ìƒˆ ìœ í˜• ì¶”ê°€</div>
      <div style="display:grid;grid-template-columns:60px 1fr 120px auto;gap:8px;align-items:center">
        <input id="newTypeEmoji" placeholder="ğŸ”–" maxlength="2" style="padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:7px;color:var(--text);font-size:18px;text-align:center;outline:none;width:100%">
        <input id="newTypeLabel" placeholder="ìœ í˜• ì´ë¦„" style="padding:8px 10px;background:var(--bg);border:1px solid var(--border);border-radius:7px;color:var(--text);font-size:13px;font-family:inherit;outline:none;width:100%">
        <div style="display:flex;align-items:center;gap:6px">
          <input type="color" id="newTypeColor" value="#4f7cff" style="width:32px;height:32px;border:1px solid var(--border);border-radius:6px;background:var(--bg);cursor:pointer;padding:2px">
          <span style="font-size:11px;color:var(--muted)">ìƒ‰ìƒ</span>
        </div>
        <button class="btn btn-primary btn-sm" onclick="addCustomType()">ì¶”ê°€</button>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal('typeModal')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="saveTypes_modal()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- Delete Confirm Modal -->
<div class="modal-overlay" id="delActModal">
  <div class="modal" style="width:400px;text-align:center">
    <div style="font-size:40px;margin-bottom:14px">ğŸ—‘</div>
    <div class="modal-title" style="text-align:center;margin-bottom:8px">í™œë™ ì‚­ì œ</div>
    <div id="delActInfo" style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px 16px;margin-bottom:20px;text-align:left;font-size:13px;line-height:1.8"></div>
    <p style="font-size:13px;color:var(--muted);margin-bottom:20px">ì´ í™œë™ì„ ì‚­ì œí•˜ë©´ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
    <div style="display:flex;gap:10px;justify-content:center">
      <button class="btn btn-outline" onclick="closeModal('delActModal')" style="min-width:100px">ì·¨ì†Œ</button>
      <button class="btn btn-danger" id="delActConfirmBtn" style="min-width:100px">ì‚­ì œ</button>
    </div>
  </div>
</div>

<!-- PDF Import Modal -->
<div class="modal-overlay" id="pdfModal">
  <div class="modal" style="width:640px">
    <button class="modal-close" onclick="closeModal('pdfModal')">âœ•</button>
    <div class="modal-title">ğŸ—‚ íŒŒì¼ì—ì„œ ì—°ë½ì²˜ ìë™ ì¶”ì¶œ</div>

    <!-- Step 1: API Key -->
    <div id="pdfStep0" class="pdf-step">
      <div class="form-section">
        <div class="form-section-title">Claude API í‚¤ ì„¤ì •</div>
        <p style="font-size:12px;color:var(--muted);margin-bottom:10px;line-height:1.7">
          íŒŒì¼ ë¶„ì„ì—ëŠ” Claude APIê°€ ì‚¬ìš©ë©ë‹ˆë‹¤.<br>
          <a href="https://console.anthropic.com" target="_blank" style="color:var(--accent)">console.anthropic.com</a> â†’ API Keys ë©”ë‰´ì—ì„œ ë°œê¸‰í•˜ì„¸ìš”.<br>
          í‚¤ëŠ” ì´ ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë˜ë©° ì™¸ë¶€ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        </p>
        <div class="form-row single">
          <div class="form-group">
            <label>Anthropic API Key <span id="keyPreview" style="font-size:10px;color:var(--accent3);font-family:'IBM Plex Mono',monospace"></span></label>
            <div style="position:relative">
              <input type="password" id="pdfApiKey" placeholder="sk-ant-api03-..."
                style="padding-right:44px"
                oninput="const v=this.value.trim();document.getElementById('pdfKeyValidMsg').textContent=v&&!v.startsWith('sk-')?'âš  sk- ë¡œ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤':''">
              <button onclick="const i=document.getElementById('pdfApiKey');i.type=i.type==='password'?'text':'password'"
                style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--muted);cursor:pointer;font-size:13px">ğŸ‘</button>
            </div>
            <div id="pdfKeyValidMsg" style="font-size:11px;color:var(--accent2);margin-top:4px"></div>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-outline" onclick="closeModal('pdfModal')">ì·¨ì†Œ</button>
        <button class="btn btn-primary" onclick="pdfSaveKey()">ì €ì¥ í›„ ê³„ì†</button>
      </div>
    </div>

    <!-- Step 2: Upload -->
    <div id="pdfStep1" class="pdf-step" style="display:none">
      <div class="form-section">
        <div class="form-section-title">íŒŒì¼ ì—…ë¡œë“œ</div>
        <p style="font-size:12px;color:var(--muted);margin-bottom:12px;line-height:1.8">
          ëª…í•¨ ì‚¬ì§„, PDF, Word, í…ìŠ¤íŠ¸ íŒŒì¼ ë“± ë‹¤ì–‘í•œ í˜•ì‹ì„ ì§€ì›í•©ë‹ˆë‹¤.<br>
          <span style="color:var(--accent)">ğŸ“„ PDF</span> &nbsp;
          <span style="color:var(--accent)">ğŸ–¼ ì‚¬ì§„ (JPGÂ·PNGÂ·WEBP)</span> &nbsp;
          <span style="color:var(--accent)">ğŸ“ í…ìŠ¤íŠ¸ (TXT)</span> &nbsp;
          <span style="color:var(--accent)">ğŸ“‹ CSV/Excel</span>
        </p>
        <div id="pdfDropzone" class="pdf-dropzone" onclick="document.getElementById('pdfFileInput').click()">
          <div class="pdf-drop-icon" id="dropIcon">ğŸ—‚</div>
          <div class="pdf-drop-text">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œ</div>
          <div class="pdf-drop-sub">PDF Â· JPG Â· PNG Â· WEBP Â· TXT Â· CSV (ìµœëŒ€ 10MB)</div>
          <input type="file" id="pdfFileInput"
            accept=".pdf,.jpg,.jpeg,.png,.webp,.txt,.csv,.xls,.xlsx,.doc,.docx"
            style="display:none" onchange="onPdfSelected(this)">
        </div>
        <div id="pdfFileName" style="font-size:12px;color:var(--accent);margin-top:8px;display:none"></div>
        <div id="pdfFileTypeNote" style="font-size:11px;color:var(--muted);margin-top:6px;display:none"></div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-outline" onclick="pdfChangeKey()">ğŸ”‘ í‚¤ ë³€ê²½</button>
        <button class="btn btn-outline" onclick="closeModal('pdfModal')">ì·¨ì†Œ</button>
        <button class="btn btn-primary" id="pdfAnalyzeBtn" onclick="pdfAnalyze()" disabled>ğŸ” ë¶„ì„ ì‹œì‘</button>
      </div>
    </div>

    <!-- Step 3: Loading -->
    <div id="pdfStep2" class="pdf-step" style="display:none">
      <div style="text-align:center;padding:48px 20px">
        <div class="pdf-spinner"></div>
        <div style="font-size:15px;font-weight:600;margin-top:20px" id="pdfLoadingMsg">íŒŒì¼ ë¶„ì„ ì¤‘...</div>
        <div style="font-size:13px;color:var(--muted);margin-top:8px">Claude AIê°€ ì—°ë½ì²˜ ì •ë³´ë¥¼ ì¶”ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤</div>
      </div>
    </div>

    <!-- Step 4: Results -->
    <div id="pdfStep3" class="pdf-step" style="display:none">
      <div class="form-section">
        <div class="form-section-title">ì¶”ì¶œëœ ì—°ë½ì²˜ í™•ì¸ ë° ìˆ˜ì •</div>
        <p style="font-size:12px;color:var(--muted);margin-bottom:12px">ë‚´ìš©ì„ í™•ì¸í•˜ê³  í•„ìš”í•˜ë©´ ìˆ˜ì • í›„ ì €ì¥í•˜ì„¸ìš”. ì²´í¬ëœ í•­ëª©ë§Œ CRMì— ì¶”ê°€ë©ë‹ˆë‹¤.</p>
      </div>
      <div id="pdfResults"></div>
      <div class="modal-actions" style="margin-top:16px">
        <button class="btn btn-outline" onclick="pdfRetry()">â† ë‹¤ì‹œ ì—…ë¡œë“œ</button>
        <button class="btn btn-primary" onclick="pdfImportAll()">âœ… ì„ íƒ í•­ëª© ëª¨ë‘ ì €ì¥</button>
      </div>
    </div>

    <!-- Step 5: Error -->
    <div id="pdfStep4" class="pdf-step" style="display:none">
      <div style="text-align:center;padding:40px 20px">
        <div style="font-size:40px;margin-bottom:16px">âš ï¸</div>
        <div style="font-size:15px;font-weight:600;margin-bottom:8px">ë¶„ì„ ì‹¤íŒ¨</div>
        <div id="pdfErrorMsg" style="font-size:13px;color:var(--muted);line-height:1.7"></div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-outline" onclick="pdfRetry()">â† ë‹¤ì‹œ ì‹œë„</button>
        <button class="btn btn-outline" onclick="closeModal('pdfModal')">ë‹«ê¸°</button>
      </div>
    </div>

  </div>
</div>

<script>
// â”€â”€ DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let contacts  = JSON.parse(localStorage.getItem('crm_contacts')  || '[]');
let activities= JSON.parse(localStorage.getItem('crm_activities')|| '[]');
let companies = JSON.parse(localStorage.getItem('crm_companies') || '{}');

// â”€â”€ GOOGLE SHEETS ì—°ë™ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let gsUrl = localStorage.getItem('crm_gs_url') || '';
let gsSyncing = false;
let gsPendingSave = false;
let gsLastSync = localStorage.getItem('crm_gs_last_sync') || '';

function gsIsConnected(){ return !!gsUrl; }

// ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
function gsUpdateStatus(state, msg){
  const el = document.getElementById('gsSyncStatus');
  if(!el) return;
  const icons = { ok:'âœ…', syncing:'ğŸ”„', error:'âš ï¸', offline:'ğŸ’¾' };
  const colors = { ok:'var(--accent3)', syncing:'var(--accent4)', error:'var(--accent2)', offline:'var(--muted)' };
  el.innerHTML = `<span style="color:${colors[state]}">${icons[state]} ${msg}</span>`;
}

// ì „ì²´ ë°ì´í„° Sheetsì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
async function gsLoad(){
  if(!gsIsConnected()) return;
  gsUpdateStatus('syncing','ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
  try {
    const res = await fetch(gsUrl + '?action=load', {method:'GET'});
    const data = await res.json();
    if(!data.ok) throw new Error(data.error||'ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');

    // ë°ì´í„° ë³‘í•© (Sheets ìš°ì„ , ë‹¨ ë¹„ì–´ìˆìœ¼ë©´ ë¡œì»¬ ìœ ì§€)
    if(data.contacts   && data.contacts.length)   contacts   = data.contacts;
    if(data.activities && data.activities.length) activities = data.activities;
    if(data.companies  && Object.keys(data.companies).length) companies = data.companies;
    if(data.types      && data.types.length){
      actTypes = data.types;
      localStorage.setItem('crm_types', JSON.stringify(actTypes));
      rebuildTypeMaps(); injectTypeStyles(); refreshTypeSelect(); refreshFilterBar();
    }

    // ë¡œì»¬ì—ë„ ìºì‹œ
    localStorage.setItem('crm_contacts',  JSON.stringify(contacts));
    localStorage.setItem('crm_activities',JSON.stringify(activities));
    localStorage.setItem('crm_companies', JSON.stringify(companies));
    gsLastSync = new Date().toLocaleString('ko-KR');
    localStorage.setItem('crm_gs_last_sync', gsLastSync);
    gsUpdateStatus('ok', 'ë™ê¸°í™” ì™„ë£Œ Â· ' + gsLastSync);
    renderStats(); renderContacts(); refreshTeamFilterBars();
  } catch(err){
    gsUpdateStatus('error', 'ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + err.message);
  }
}

// ì „ì²´ ë°ì´í„° Sheetsì— ì €ì¥
async function gsSave(){
  if(!gsIsConnected()){ localPersist(); return; }
  if(gsSyncing){ gsPendingSave = true; return; }
  gsSyncing = true;
  gsUpdateStatus('syncing','ì €ì¥ ì¤‘...');
  localPersist(); // ë¡œì»¬ì—ë„ í•­ìƒ ì €ì¥
  try {
    const res = await fetch(gsUrl, {
      method: 'POST',
      body: JSON.stringify({
        action: 'save',
        contacts, activities, companies,
        types: actTypes
      })
    });
    const data = await res.json();
    if(!data.ok) throw new Error(data.error||'ì €ì¥ ì‹¤íŒ¨');
    gsLastSync = new Date().toLocaleString('ko-KR');
    localStorage.setItem('crm_gs_last_sync', gsLastSync);
    gsUpdateStatus('ok', 'ì €ì¥ë¨ Â· ' + gsLastSync);
  } catch(err){
    gsUpdateStatus('error', 'ì €ì¥ ì‹¤íŒ¨ (ë¡œì»¬ ë°±ì—…ë¨): ' + err.message);
  } finally {
    gsSyncing = false;
    if(gsPendingSave){ gsPendingSave = false; gsSave(); }
  }
}

// ë¡œì»¬ ì €ì¥ (ê¸°ì¡´ persist ì—­í• )
function localPersist(){
  localStorage.setItem('crm_contacts',  JSON.stringify(contacts));
  localStorage.setItem('crm_activities',JSON.stringify(activities));
  localStorage.setItem('crm_companies', JSON.stringify(companies));
}

function persist(){
  localPersist();
  renderStats();
  refreshTeamFilterBars();
  if(gsIsConnected()) gsSave();
}

let editCid = null;       // editing contact id
let editCoName = null;    // editing company name
let actCid = null;        // activity target contact id
let currentCid = null;    // currently viewed contact

let viewMode = 'group';
let expanded = new Set();

// â”€â”€ í™œë™ ìœ í˜• (ì‚¬ìš©ì ì •ì˜ ê°€ëŠ¥) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEFAULT_TYPES = [
  {id:'order', label:'ë°œì£¼', emoji:'ğŸ“¦', color:'#43e97b'},
  {id:'quote', label:'ê²¬ì ', emoji:'ğŸ“„', color:'#f7971e'},
  {id:'visit', label:'ë°©ë¬¸', emoji:'ğŸ¤', color:'#ff6b6b'},
  {id:'call',  label:'í†µí™”', emoji:'ğŸ“', color:'#4f7cff'},
  {id:'other', label:'ê¸°íƒ€', emoji:'ğŸ“Œ', color:'#7986cb'},
];

function loadTypes(){
  try { return JSON.parse(localStorage.getItem('crm_types')) || DEFAULT_TYPES; }
  catch(e){ return DEFAULT_TYPES; }
}
function saveTypes(types){ localStorage.setItem('crm_types',JSON.stringify(types)); }

let actTypes = loadTypes();

function buildTypeMaps(){
  const TL={}, TE={}, TB={}, TD={};
  actTypes.forEach(t=>{
    TL[t.id] = t.label;
    TE[t.id] = t.emoji;
    TB[t.id] = 'badge-type-'+t.id;
    TD[t.id] = 'dot-type-'+t.id;
  });
  return {TL,TE,TB,TD};
}
let {TL,TE,TB,TD} = buildTypeMaps();

function rebuildTypeMaps(){
  const maps = buildTypeMaps();
  Object.assign(TL, maps.TL); Object.keys(TL).forEach(k=>{ if(!maps.TL[k]) delete TL[k]; });
  Object.assign(TE, maps.TE); Object.keys(TE).forEach(k=>{ if(!maps.TE[k]) delete TE[k]; });
  Object.assign(TB, maps.TB); Object.keys(TB).forEach(k=>{ if(!maps.TB[k]) delete TB[k]; });
  Object.assign(TD, maps.TD); Object.keys(TD).forEach(k=>{ if(!maps.TD[k]) delete TD[k]; });
}

function injectTypeStyles(){
  let s = document.getElementById('dynamicTypeStyles');
  if(!s){ s=document.createElement('style'); s.id='dynamicTypeStyles'; document.head.appendChild(s); }
  s.textContent = actTypes.map(t=>{
    const hex = t.color||'#7986cb';
    const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16);
    return `.badge-type-${t.id}{background:rgba(${r},${g},${b},0.15);color:${hex}}
.dot-type-${t.id}{background:rgba(${r},${g},${b},0.15);color:${hex};border:1px solid ${hex}}`;
  }).join('\n');
}

function uid() { return Date.now().toString(36)+Math.random().toString(36).slice(2); }
function esc(s){ return (s||'').replace(/\\/g,'\\\\').replace(/'/g,"\\'"); }
function ac(s){ // avatar color
  const c=['#4f7cff','#ff6b6b','#43e97b','#f7971e','#a855f7','#06b6d4','#f43f5e','#84cc16'];
  let h=0; for(let ch of (s||''))h=(h*31+ch.charCodeAt(0))%c.length; return c[h];
}
function fmtMoney(s){ return Number((s||'').toString().replace(/[^0-9]/g,'')||0).toLocaleString(); }

// â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function nav(p){
  document.getElementById('contactsView').style.display   = p==='contacts'   ? '' : 'none';
  document.getElementById('activitiesView').style.display = p==='activities' ? '' : 'none';
  document.getElementById('detailView').classList.remove('open');
  // PC ì‚¬ì´ë“œë°”
  document.getElementById('navContacts').classList.toggle('active', p==='contacts');
  document.getElementById('navActivities').classList.toggle('active', p==='activities');
  // ëª¨ë°”ì¼ íƒ­ë°”
  document.getElementById('mTabContacts').classList.toggle('active', p==='contacts');
  document.getElementById('mTabActivities').classList.toggle('active', p==='activities');
  // ì—°ë½ì²˜ íƒ­ì¼ ë•Œë§Œ ê²€ìƒ‰/ë·°í† ê¸€ topbar í‘œì‹œ
  const topbar = document.getElementById('mainTopbar');
  if(topbar) topbar.style.display = p==='contacts' ? '' : 'none';

  currentCid = null;
  if(p==='contacts')   renderContacts();
  if(p==='activities') renderAllActs();
}
function backToList(){
  document.getElementById('detailView').classList.remove('open');
  document.getElementById('contactsView').style.display='';
  currentCid=null; renderContacts();
}
function setViewMode(m){
  viewMode=m;
  document.querySelectorAll('.toggle-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('vBtn-'+m).classList.add('active');
  renderContacts();
}
let actFilter = 'all';   // í™œë™ ìœ í˜• í•„í„°
let teamFilter = 'all';  // ì—°ë½ì²˜ íŒ€ í•„í„°
let actTeamFilter = 'all'; // í™œë™ íŒ€ í•„í„°

// íŒ€ ëª©ë¡ ì¶”ì¶œ (companiesì—ì„œ ourTeam ê°’ë“¤)
function getTeamList(){
  return [...new Set(
    Object.values(companies)
      .map(c=>c.ourTeam||'')
      .filter(Boolean)
  )].sort();
}

// íŒ€ í•„í„°ê°€ ì ìš©ë  íšŒì‚¬ ëª©ë¡ ë°˜í™˜
function getCosByTeam(team){
  if(team==='all') return null; // null = í•„í„° ì—†ìŒ
  return Object.entries(companies)
    .filter(([,ci])=>(ci.ourTeam||'')=== team)
    .map(([name])=>name);
}

function setActFilter(f, btn){
  actFilter = f;
  document.querySelectorAll('#actFilterBar .filter-chip').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderAllActs();
}

function setTeamFilter(f, btn){
  teamFilter = f;
  document.querySelectorAll('#teamFilterBar .filter-chip').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderContacts();
}

function setActTeamFilter(f, btn){
  actTeamFilter = f;
  document.querySelectorAll('#actTeamFilterBar .filter-chip').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderAllActs();
}

function refreshTeamFilterBars(){
  const teams = getTeamList();
  const makeChips = (barId, curVal, fnName) => {
    const bar = document.getElementById(barId);
    if(!bar) return;
    if(!teams.length){
      bar.style.display='';
      bar.innerHTML = `<span style="font-size:11px;color:var(--muted);padding:2px 6px">íŒ€ ë¯¸ë“±ë¡ â€” íšŒì‚¬ ìˆ˜ì •ì—ì„œ ìš°ë¦¬ íŒ€ ë‹´ë‹¹ìë¥¼ ì…ë ¥í•˜ë©´ í•„í„°ê°€ ìƒê¹ë‹ˆë‹¤</span>`;
      return;
    }
    bar.style.display='';
    bar.innerHTML = `<span style="font-size:10px;color:var(--muted);font-family:'IBM Plex Mono',monospace;align-self:center;margin-right:4px;white-space:nowrap">ğŸ‘¥ íŒ€</span>`
      + `<button class="filter-chip${curVal==='all'?' active':''}" onclick="${fnName}('all',this)">ì „ì²´</button>`
      + teams.map(t=>`<button class="filter-chip${curVal===t?' active':''}" onclick="${fnName}('${t.replace(/'/g,"\\'")}',this)">ğŸ‘¥ ${t}</button>`).join('');
  };
  makeChips('teamFilterBar',    teamFilter,    'setTeamFilter');
  makeChips('actTeamFilterBar', actTeamFilter, 'setActTeamFilter');
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function coActivities(coName){
  const ids = contacts.filter(c=>(c.company||'').trim()===coName).map(c=>c.id);
  return activities.filter(a=>ids.includes(a.contactId)).sort((a,b)=>b.date.localeCompare(a.date));
}
function contactActivities(cid){ return activities.filter(a=>a.contactId===cid).sort((a,b)=>b.date.localeCompare(a.date)); }

// â”€â”€ RENDER CONTACTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderContacts(){
  const q = document.getElementById('searchInput').value.toLowerCase();
  let list = contacts.filter(c=>{
    const s=(c.company+c.last+c.first+c.email+c.mobile+c.office).toLowerCase();
    return s.includes(q);
  });
  // íŒ€ í•„í„°
  if(teamFilter !== 'all'){
    const cos = getCosByTeam(teamFilter);
    if(cos) list = list.filter(c => cos.includes(c.company||''));
  }
  document.getElementById('viewSub').textContent = `ì´ ${list.length}ëª…`;
  if(viewMode==='list')  { renderFlatList(list); return; }
  if(viewMode==='glist') { renderGroupList(list); return; }
  renderGroupView(list);
}

function renderGroupView(list){
  const groups={};
  for(const c of list){ const k=(c.company||'').trim()||'__none__'; (groups[k]=groups[k]||[]).push(c); }
  const named = Object.keys(groups).filter(k=>k!=='__none__').sort();
  const none  = groups['__none__']||[];
  let html='';

  for(const co of named){
    const members = groups[co];
    const ci = companies[co]||{};
    const coActs = coActivities(co);
    const types = [...new Set(coActs.map(a=>a.type))];
    const isExp = expanded.has(co);
    const col = ac(co);
    const preview = coActs.slice(0,5);

    html+=`
    <div class="company-group${isExp?'':' collapsed'}" id="cg-${CSS.escape(co)}">
      <div class="company-header" onclick="toggleCo('${esc(co)}')">
        <div class="company-logo" style="background:linear-gradient(135deg,${col},${col}bb)">${co[0]}</div>
        <div class="company-info">
          <div class="company-name">${co}</div>
          <div class="company-meta">
            <span>ğŸ‘¤ ${members.length}ëª…</span>
            ${ci.phone?`<span>â˜ ${ci.phone}</span>`:''}
            ${coActs.length?`<span>ğŸ“‹ ${coActs.length}ê±´</span>`:''}
          </div>
        </div>
        <div class="company-badges">${types.map(t=>`<span class="activity-badge ${TB[t]}">${TE[t]} ${coActs.filter(a=>a.type===t).length}</span>`).join('')}</div>
        <span class="company-toggle">â–¾</span>
      </div>
      <div class="company-body">
        <!-- shared bar -->
        <div class="shared-bar">
          <span class="shared-tag">ê³µí†µ</span>
          ${ci.phone?`<span>â˜ ${ci.phone}</span>`:'<span style="opacity:.4">ëŒ€í‘œì „í™” ì—†ìŒ</span>'}
          ${ci.fax?`<span>ğŸ“  ${ci.fax}</span>`:''}
          ${ci.address?`<span>ğŸ“ ${ci.address}</span>`:'<span style="opacity:.4">ì£¼ì†Œ ì—†ìŒ</span>'}
          ${(()=>{const ceos=ci.ceoHistory||[];const cur=ceos.find(c=>!c.to||c.to==='í˜„ì¬')||ceos[0];return cur?`<span>ğŸ‘” ëŒ€í‘œ ${cur.name}${cur.from?' ('+cur.from+'~'+(cur.to&&cur.to!=='í˜„ì¬'?cur.to:'í˜„ì¬')+')':''}</span>`:''})()}
          ${ci.ourName?`<span style="color:var(--accent3)">ğŸ‘¤ ë‹´ë‹¹ ${ci.ourTeam?ci.ourTeam+' ':''}<strong>${ci.ourName}</strong></span>`:''}
          <button class="shared-edit-btn" onclick="openCompanyModal('${esc(co)}')">âœ ìˆ˜ì •</button>
        </div>
        <!-- finance summary (ìµœì‹  ì—°ë„) -->
        ${(()=>{
          const fin=(ci.finance||[]).sort((a,b)=>Number(b.year)-Number(a.year));
          if(!fin.length) return '';
          const r=fin[0];
          const fmtFin=v=>v?(Number(v.toString().replace(/[^0-9.-]/g,''))||0).toLocaleString()+'ë°±ë§Œ':'â€”';
          const profitVal=Number((r.net_profit||'').toString().replace(/[^0-9.-]/g,'')||0);
          return `<div class="fin-summary">
            <span style="font-size:11px;color:var(--muted);font-family:'IBM Plex Mono',monospace">${r.year}ë…„</span>
            ${r.headcount?`<div class="fin-chip"><span class="fin-chip-label">ì¸ì›</span><span class="fin-chip-value neu">${r.headcount}ëª…</span></div>`:''}
            ${r.revenue?`<div class="fin-chip"><span class="fin-chip-label">ë§¤ì¶œ</span><span class="fin-chip-value neu">${fmtFin(r.revenue)}</span></div>`:''}
            ${r.op_profit?`<div class="fin-chip"><span class="fin-chip-label">ì˜ì—…ì´ìµ</span><span class="fin-chip-value ${Number((r.op_profit||'').toString().replace(/[^0-9.-]/g,''))||0 >= 0?'pos':'neg'}">${fmtFin(r.op_profit)}</span></div>`:''}
            ${r.net_profit?`<div class="fin-chip"><span class="fin-chip-label">ìˆœì´ìµ</span><span class="fin-chip-value ${profitVal>=0?'pos':'neg'}">${fmtFin(r.net_profit)}</span></div>`:''}
            ${r.assets?`<div class="fin-chip"><span class="fin-chip-label">ìì‚°</span><span class="fin-chip-value neu">${fmtFin(r.assets)}</span></div>`:''}
            ${r.liabilities?`<div class="fin-chip"><span class="fin-chip-label">ë¶€ì±„</span><span class="fin-chip-value neg">${fmtFin(r.liabilities)}</span></div>`:''}
            ${fin.length>1?`<span style="font-size:11px;color:var(--muted)">ì™¸ ${fin.length-1}ë…„ ë°ì´í„°</span>`:''}
          </div>`;
        })()}
        <!-- members -->
        <div class="members-row">
          ${members.map(c=>personCard(c)).join('')}
          <button class="add-card" onclick="openAddContact('${esc(co)}')">ï¼‹ ë‹´ë‹¹ì ì¶”ê°€</button>
        </div>
        <!-- timeline -->
        <div class="co-timeline-section">
          <div class="co-timeline-head">
            <span class="co-timeline-label">ğŸ“‹ íšŒì‚¬ ì „ì²´ í™œë™ (${coActs.length}ê±´)</span>
            <button class="btn btn-primary btn-xs" onclick="openActModal_co('${esc(co)}')">ï¼‹ ì¶”ê°€</button>
          </div>
          ${coActs.length===0
            ? `<div style="font-size:12px;color:var(--muted);text-align:center;padding:12px">í™œë™ ì—†ìŒ</div>`
            : `<div class="timeline" id="tl-${CSS.escape(co)}">
                ${preview.map(a=>tlItem(a,co)).join('')}
               </div>
               ${coActs.length>5?`<button class="show-more-btn" onclick="showAll('${esc(co)}')">+ ${coActs.length-5}ê±´ ë” ë³´ê¸°</button>`:''}`
          }
        </div>
      </div>
    </div>`;
  }

  if(none.length){
    html+=`<div style="margin-top:16px">
      <div class="ungrouped-label">â”€â”€ íšŒì‚¬ ë¯¸ì§€ì • (${none.length}ëª…)</div>
      <div class="ungrouped-grid">${none.map(c=>personCard(c,true)).join('')}</div>
    </div>`;
  }

  if(!named.length&&!none.length) html=`<div class="empty-state"><div class="empty-icon">ğŸ‘¥</div><p>ì—°ë½ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>`;
  document.getElementById('mainGrid').innerHTML=html;
}

function personCard(c, standalone=false){
  const acts=activities.filter(a=>a.contactId===c.id);
  const types=[...new Set(acts.map(a=>a.type))];
  const init=(c.last||c.first||'?')[0];
  const bg=ac(c.last+c.first);
  const title=[c.dept,c.position].filter(Boolean).join(' / ');
  return `<div class="person-card" onclick="showDetail('${c.id}')">
    <div class="person-head">
      <div class="avatar" style="background:${bg}">${init}</div>
      <div>
        <div class="person-name">${c.last}${c.first}</div>
        <div class="person-dept">${title||'&mdash;'}</div>
      </div>
    </div>
    <div class="person-contacts">
      ${c.office?`<span><span class="pc-label">ì§í†µ</span>${c.office}</span>`:''}
      ${c.mobile?`<span><span class="pc-label">í•¸ë“œí°</span>${c.mobile}</span>`:''}
      ${!c.office&&!c.mobile?`<span style="opacity:.4">ì—°ë½ì²˜ ì—†ìŒ</span>`:''}
    </div>
    ${types.length?`<div class="person-badges">${types.map(t=>`<span class="activity-badge ${TB[t]}">${TE[t]} ${acts.filter(a=>a.type===t).length}</span>`).join('')}</div>`:''}
  </div>`;
}

function tlItem(a, co){
  const c=contacts.find(x=>x.id===a.contactId);
  const who=c?c.last+c.first:'?';
  return `<div class="timeline-item">
    <div class="timeline-dot ${TD[a.type]}">${TE[a.type]}</div>
    <div class="tl-body">
      <div class="tl-meta">
        <span class="tl-type">${TL[a.type]}${a.title?' Â· '+a.title:''}</span>
        <div style="display:flex;gap:4px;align-items:center">
          <span class="tl-date">${a.date}</span>
          <button onclick="openEditAct('${a.id}')" title="ìˆ˜ì •" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:11px;padding:2px 4px;border-radius:3px;transition:all 0.1s" onmouseover="this.style.color='var(--accent)'" onmouseout="this.style.color='var(--muted)'">âœ</button>
          <button onclick="delAct('${a.id}')" title="ì‚­ì œ" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:11px;padding:2px 4px;border-radius:3px;transition:all 0.1s" onmouseover="this.style.color='var(--danger)'" onmouseout="this.style.color='var(--muted)'">ğŸ—‘</button>
        </div>
      </div>
      <div class="tl-who" onclick="showDetail('${a.contactId}')">ğŸ‘¤ ${who}</div>
      ${a.content?`<div class="tl-text">${a.content}</div>`:''}
      ${a.amount?`<div class="tl-amount">â‚© ${fmtMoney(a.amount)}</div>`:''}
    </div>
  </div>`;
}

function showAll(co){
  const all=coActivities(co);
  const tl=document.getElementById('tl-'+CSS.escape(co));
  if(tl){ tl.innerHTML=all.map(a=>tlItem(a,co)).join(''); }
  const btn=tl?.nextElementSibling;
  if(btn?.classList.contains('show-more-btn')) btn.remove();
}

function toggleCo(co){
  const el=document.getElementById('cg-'+CSS.escape(co));
  if(!el) return;
  if(el.classList.contains('collapsed')){ el.classList.remove('collapsed'); expanded.add(co); }
  else { el.classList.add('collapsed'); expanded.delete(co); }
}

// â”€â”€ GROUP LIST VIEW (íšŒì‚¬ë³„ ëª©ë¡) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderGroupList(list){
  const groups={};
  for(const c of list){ const k=(c.company||'').trim()||'__none__'; (groups[k]=groups[k]||[]).push(c); }
  const named=Object.keys(groups).filter(k=>k!=='__none__').sort();
  const none=groups['__none__']||[];
  let html='';

  for(const co of named){
    const members=groups[co];
    const ci=companies[co]||{};
    const coActs=coActivities(co);
    const types=[...new Set(coActs.map(a=>a.type))];
    const isExp=expanded.has(co);
    const col=ac(co);

    html+=`
    <div class="company-group${isExp?'':' collapsed'}" id="cg-${CSS.escape(co)}">
      <div class="company-header" onclick="toggleCo('${esc(co)}')">
        <div class="company-logo" style="background:linear-gradient(135deg,${col},${col}bb)">${co[0]}</div>
        <div class="company-info">
          <div class="company-name">${co}</div>
          <div class="company-meta">
            <span>ğŸ‘¤ ${members.length}ëª…</span>
            ${ci.phone?`<span>â˜ ${ci.phone}</span>`:''}
            ${coActs.length?`<span>ğŸ“‹ ${coActs.length}ê±´</span>`:''}
          </div>
        </div>
        <div class="company-badges">${types.map(t=>`<span class="activity-badge ${TB[t]}">${TE[t]} ${coActs.filter(a=>a.type===t).length}</span>`).join('')}</div>
        <button class="shared-edit-btn" style="margin-right:4px" onclick="event.stopPropagation();openCompanyModal('${esc(co)}')">âœ</button>
        <span class="company-toggle">â–¾</span>
      </div>
      <div class="company-body">
        <div class="shared-bar">
          <span class="shared-tag">ê³µí†µ</span>
          ${ci.phone?`<span>â˜ ${ci.phone}</span>`:'<span style="opacity:.4">ëŒ€í‘œì „í™” ì—†ìŒ</span>'}
          ${ci.fax?`<span>ğŸ“  ${ci.fax}</span>`:''}
          ${ci.address?`<span>ğŸ“ ${ci.address}</span>`:'<span style="opacity:.4">ì£¼ì†Œ ì—†ìŒ</span>'}
          <button class="shared-edit-btn" onclick="openAddContact('${esc(co)}')">ï¼‹ ë‹´ë‹¹ì</button>
        </div>
        <div class="list-wrap" style="margin:0;border-radius:0;border-left:none;border-right:none;border-bottom:none">
          <table class="list-table">
            <thead><tr>
              <th style="width:130px">ì´ë¦„</th>
              <th style="width:160px">ì§í•¨</th>
              <th style="width:150px">ì§í†µ</th>
              <th style="width:150px">í•¸ë“œí°</th>
              <th style="width:110px">í™œë™</th>
            </tr></thead>
            <tbody>
              ${members.map(c=>personListRow(c)).join('')}
            </tbody>
          </table>
        </div>
      </div>
    </div>`;
  }

  if(none.length){
    html+=`<div style="margin-top:16px">
      <div class="ungrouped-label">â”€â”€ íšŒì‚¬ ë¯¸ì§€ì • (${none.length}ëª…)</div>
      <div class="list-wrap">
        <table class="list-table">
          <thead><tr><th style="width:130px">ì´ë¦„</th><th style="width:160px">ì§í•¨</th><th style="width:150px">ì§í†µ</th><th style="width:150px">í•¸ë“œí°</th><th style="width:110px">í™œë™</th></tr></thead>
          <tbody>${none.map(c=>personListRow(c)).join('')}</tbody>
        </table>
      </div>
    </div>`;
  }

  if(!named.length&&!none.length) html=`<div class="empty-state"><div class="empty-icon">ğŸ‘¥</div><p>ì—°ë½ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>`;
  document.getElementById('mainGrid').innerHTML=html;
}

// â”€â”€ FLAT LIST VIEW (ì „ì²´ ëª©ë¡) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFlatList(list){
  // sort by company then name
  const sorted=[...list].sort((a,b)=>{
    const ca=(a.company||'ã…¿').localeCompare(b.company||'ã…¿','ko');
    if(ca!==0) return ca;
    return (a.last+a.first).localeCompare(b.last+b.first,'ko');
  });

  if(!sorted.length){
    document.getElementById('mainGrid').innerHTML=`<div class="empty-state"><div class="empty-icon">ğŸ‘¥</div><p>ì—°ë½ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>`;
    return;
  }

  // Group header rows mixed in
  let rows=''; let lastCo=null;
  for(const c of sorted){
    const co=(c.company||'').trim();
    if(co && co!==lastCo){
      const ci=companies[co]||{};
      const cnt=list.filter(x=>x.company===co).length;
      rows+=`<tr class="co-row" onclick="setViewMode('group');setTimeout(()=>{expanded.add('${esc(co)}');const el=document.getElementById('cg-'+CSS.escape('${esc(co)}'));if(el){el.classList.remove('collapsed');el.scrollIntoView({behavior:'smooth',block:'start'});}},80)">
        <td colspan="6" style="padding:9px 16px">
          <div style="display:flex;align-items:center;gap:10px">
            <div style="width:26px;height:26px;border-radius:6px;background:${ac(co)};display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff;flex-shrink:0">${co[0]}</div>
            <span>${co}</span>
            <span style="font-size:11px;color:var(--muted);font-weight:400">${cnt}ëª…${ci.phone?' Â· â˜ '+ci.phone:''}</span>
          </div>
        </td>
      </tr>`;
      lastCo=co;
    }
    rows+=personListRow(c, co?true:false);
  }

  document.getElementById('mainGrid').innerHTML=`
    <div class="list-wrap">
      <table class="list-table">
        <thead><tr>
          <th style="width:130px">ì´ë¦„</th>
          <th style="width:160px">ì§í•¨</th>
          <th style="width:150px">ì§í†µ</th>
          <th style="width:150px">í•¸ë“œí°</th>
          <th style="width:110px">í™œë™</th>
        </tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;
}

// â”€â”€ PERSON LIST ROW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function personListRow(c, indented=true){
  const acts=activities.filter(a=>a.contactId===c.id);
  const types=[...new Set(acts.map(a=>a.type))];
  const bg=ac(c.last+c.first);
  const init=(c.last||c.first||'?')[0];
  const title=[c.dept,c.position].filter(Boolean).join(' / ')||'â€”';
  return `<tr onclick="showDetail('${c.id}')" style="cursor:pointer">
    <td style="padding-left:${indented?26:14}px">
      <div style="display:flex;align-items:center;gap:8px">
        <div style="width:28px;height:28px;border-radius:50%;background:${bg};display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;flex-shrink:0">${init}</div>
        <span style="font-weight:500">${c.last}${c.first}</span>
      </div>
    </td>
    <td style="color:var(--muted);font-size:12px">${title}</td>
    <td style="font-family:'IBM Plex Mono',monospace;font-size:12px;color:var(--text)">${c.office||'<span style="opacity:.3">â€”</span>'}</td>
    <td style="font-family:'IBM Plex Mono',monospace;font-size:12px;color:var(--text)">${c.mobile||'<span style="opacity:.3">â€”</span>'}</td>
    <td>${types.map(t=>`<span class="activity-badge ${TB[t]}">${TE[t]}${acts.filter(a=>a.type===t).length}</span>`).join(' ')||'<span style="color:var(--border);font-size:11px">â€”</span>'}</td>
  </tr>`;
}

// â”€â”€ DETAIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showDetail(id){
  currentCid=id;
  const c=contacts.find(x=>x.id===id);
  if(!c) return;
  const acts=contactActivities(id);
  const bg=ac(c.last+c.first);
  const init=(c.last||c.first||'?')[0];
  const ci=c.company?(companies[c.company]||{}):{};

  const info=[
    {l:'ì´ë©”ì¼',v:c.email||'â€”'},{l:'íœ´ëŒ€í°',v:c.mobile||'â€”'},
    {l:'ì‚¬ë¬´ì‹¤',v:c.office||'â€”'},{l:'ì¶”ê°€ ì—°ë½ì²˜',v:c.extra||'â€”'},
    {l:'ì£¼ì†Œ',v:ci.address||c.address||'â€”'},{l:'ë©”ëª¨',v:c.memo||'â€”'},
  ];

  document.getElementById('detailContent').innerHTML=`
    <div class="detail-header">
      <div class="detail-avatar" style="background:${bg}">${init}</div>
      <div>
        <div class="detail-name">${c.last}${c.first}</div>
        <div class="detail-sub">${c.company||''}${c.dept?' Â· '+c.dept:''}${c.position?' / '+c.position:''}</div>
      </div>
      <div class="detail-actions">
        <button class="btn btn-outline btn-sm" onclick="openEditContact('${id}')">âœ ìˆ˜ì •</button>
        <button class="btn btn-primary btn-sm" onclick="openActModal_contact('${id}')">ï¼‹ í™œë™</button>
        <button class="btn btn-danger btn-sm" onclick="delContact('${id}')">ğŸ—‘</button>
      </div>
    </div>
    <div class="info-grid">
      ${info.map(i=>`<div class="info-card"><div class="info-card-label">${i.l}</div><div class="info-card-value">${i.v}</div></div>`).join('')}
    </div>
    <div class="acts-section">
      <div class="acts-head"><span class="acts-title">í™œë™ (${acts.length})</span>
        <button class="btn btn-primary btn-sm" onclick="openActModal_contact('${id}')">ï¼‹ ì¶”ê°€</button>
      </div>
      ${acts.length===0?`<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><p>ì•„ì§ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.</p></div>`
        :`<div class="timeline">${acts.map(a=>`
          <div class="timeline-item">
            <div class="timeline-dot ${TD[a.type]}">${TE[a.type]}</div>
            <div class="tl-body">
              <div class="tl-meta">
                <span class="tl-type">${TL[a.type]}${a.title?' Â· '+a.title:''}</span>
                <div style="display:flex;gap:4px;align-items:center">
                  <span class="tl-date">${a.date}</span>
                  <button onclick="openEditAct('${a.id}')" title="ìˆ˜ì •" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:11px;padding:2px 4px;border-radius:3px;transition:all 0.1s" onmouseover="this.style.color='var(--accent)'" onmouseout="this.style.color='var(--muted)'">âœ</button>
                  <button onclick="delAct('${a.id}',true)" title="ì‚­ì œ" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:11px;padding:2px 4px;border-radius:3px;transition:all 0.1s" onmouseover="this.style.color='var(--danger)'" onmouseout="this.style.color='var(--muted)'">ğŸ—‘</button>
                </div>
              </div>
              ${a.content?`<div class="tl-text">${a.content}</div>`:''}
              ${a.amount?`<div class="tl-amount">â‚© ${fmtMoney(a.amount)}</div>`:''}
            </div>
          </div>`).join('')}
        </div>`}
    </div>`;

  // Company back button
  const coBtn=document.getElementById('detailCoBtn');
  if(c.company){
    coBtn.style.display='';
    coBtn.onclick=()=>{
      backToList();
      setTimeout(()=>{
        expanded.add(c.company);
        const el=document.getElementById('cg-'+CSS.escape(c.company));
        if(el){ el.classList.remove('collapsed'); el.scrollIntoView({behavior:'smooth',block:'start'}); }
      },80);
    };
  } else coBtn.style.display='none';

  document.getElementById('contactsView').style.display='none';
  document.getElementById('detailView').classList.add('open');
}

// â”€â”€ ALL ACTIVITIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAllActs(){
  let allSorted = [...activities].sort((a,b)=>b.date.localeCompare(a.date));
  // ìœ í˜• í•„í„°
  if(actFilter !== 'all') allSorted = allSorted.filter(a=>a.type===actFilter);
  // íŒ€ í•„í„°
  if(actTeamFilter !== 'all'){
    const cos = getCosByTeam(actTeamFilter);
    if(cos){
      const cids = contacts.filter(c=>cos.includes(c.company||'')).map(c=>c.id);
      allSorted = allSorted.filter(a=>cids.includes(a.contactId));
    }
  }
  const acts = allSorted;
  const div = document.getElementById('allActsContent');
  const total = activities.length;

  // ê±´ìˆ˜ í‘œì‹œ
  const subEl = document.getElementById('actsSub');
  if(subEl){
    let desc = actFilter==='all' ? 'ì „ì²´' : (TL[actFilter]||actFilter);
    if(actTeamFilter!=='all') desc += ` Â· ğŸ‘¥ ${actTeamFilter}íŒ€`;
    subEl.textContent = `${desc} ${acts.length}ê±´ / ì „ì²´ ${total}ê±´`;
  }

  if(!acts.length){ div.innerHTML=`<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><p>${actFilter==='all'?'í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.':'í•´ë‹¹ ìœ í˜•ì˜ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.'}</p></div>`; return; }
  div.innerHTML=`<div class="timeline">${acts.map(a=>{
    const c=contacts.find(x=>x.id===a.contactId);
    return `<div class="timeline-item">
      <div class="timeline-dot ${TD[a.type]}">${TE[a.type]}</div>
      <div class="tl-body">
        <div class="tl-meta">
          <span class="tl-type" style="cursor:pointer" onclick="${c?`showDetail('${c.id}')`:''}">
            ${TL[a.type]||a.type}${a.title?' Â· '+a.title:''}
          </span>
          <div style="display:flex;gap:4px;align-items:center">
            <span class="tl-date">${a.date}</span>
            <button onclick="openEditAct('${a.id}')" title="ìˆ˜ì •" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:11px;padding:2px 4px;border-radius:3px;transition:all 0.1s" onmouseover="this.style.color='var(--accent)'" onmouseout="this.style.color='var(--muted)'">âœ</button>
            <button onclick="delAct('${a.id}')" title="ì‚­ì œ" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:11px;padding:2px 4px;border-radius:3px;transition:all 0.1s" onmouseover="this.style.color='var(--danger)'" onmouseout="this.style.color='var(--muted)'">ğŸ—‘</button>
          </div>
        </div>
        <div class="tl-who" style="cursor:pointer" onclick="${c?`showDetail('${c.id}')`:''}">
          ğŸ‘¤ ${c?c.last+c.first:'?'} ${c&&c.company?'<span style="color:var(--muted)">Â· '+c.company+'</span>':''}
        </div>
        ${a.content?`<div class="tl-text">${a.content}</div>`:''}
        ${a.amount?`<div class="tl-amount">â‚© ${fmtMoney(a.amount)}</div>`:''}
      </div>
    </div>`;
  }).join('')}</div>`;
}

// â”€â”€ CONTACT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function refreshCoSuggestions(){
  const dl=document.getElementById('coSuggestions');
  dl.innerHTML=[...new Set(contacts.map(c=>c.company).filter(Boolean))].map(n=>`<option value="${n}">`).join('');
}
function onCompanyInput(){
  const co=document.getElementById('f_company').value.trim();
  const ci=companies[co];
  const notice=document.getElementById('addrNotice');
  const addrInput=document.getElementById('f_address');
  if(co&&ci&&ci.address){ notice.style.display=''; addrInput.value=ci.address; addrInput.style.borderColor='var(--accent)'; }
  else { notice.style.display='none'; addrInput.style.borderColor=''; }
}

function openAddContact(preCo){
  editCid=null;
  document.getElementById('cModalTitle').textContent='ìƒˆ ì—°ë½ì²˜';
  ['f_dept','f_position','f_last','f_first','f_email','f_office','f_mobile','f_extra','f_address','f_memo']
    .forEach(id=>document.getElementById(id).value='');
  document.getElementById('f_company').value=preCo||'';
  document.getElementById('addrNotice').style.display='none';
  refreshCoSuggestions();
  if(preCo) onCompanyInput();
  document.getElementById('contactModal').classList.add('open');
}
function openEditContact(id){
  editCid=id;
  const c=contacts.find(x=>x.id===id);
  document.getElementById('cModalTitle').textContent='ì—°ë½ì²˜ ìˆ˜ì •';
  document.getElementById('f_company').value=c.company||'';
  document.getElementById('f_dept').value=c.dept||'';
  document.getElementById('f_position').value=c.position||'';
  document.getElementById('f_last').value=c.last||'';
  document.getElementById('f_first').value=c.first||'';
  document.getElementById('f_email').value=c.email||'';
  document.getElementById('f_office').value=c.office||'';
  document.getElementById('f_mobile').value=c.mobile||'';
  document.getElementById('f_extra').value=c.extra||'';
  document.getElementById('f_address').value=c.address||'';
  document.getElementById('f_memo').value=c.memo||'';
  document.getElementById('addrNotice').style.display='none';
  refreshCoSuggestions();
  document.getElementById('contactModal').classList.add('open');
}
function saveContact(){
  const last=document.getElementById('f_last').value.trim();
  const first=document.getElementById('f_first').value.trim();
  if(!last&&!first){ alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  const co=document.getElementById('f_company').value.trim();
  const addr=document.getElementById('f_address').value.trim();
  // Sync address to company info
  if(co&&addr){ if(!companies[co]) companies[co]={}; if(!companies[co].address) companies[co].address=addr; }
  const data={company:co, dept:document.getElementById('f_dept').value.trim(),
    position:document.getElementById('f_position').value.trim(), last, first,
    email:document.getElementById('f_email').value.trim(), office:document.getElementById('f_office').value.trim(),
    mobile:document.getElementById('f_mobile').value.trim(), extra:document.getElementById('f_extra').value.trim(),
    address:addr, memo:document.getElementById('f_memo').value.trim()};
  if(editCid){ const i=contacts.findIndex(x=>x.id===editCid); contacts[i]={...contacts[i],...data}; persist(); closeModal('contactModal'); showDetail(editCid); }
  else { contacts.unshift({id:uid(),createdAt:new Date().toISOString(),...data}); persist(); closeModal('contactModal'); renderContacts(); }
}
function delContact(id){
  const c = contacts.find(x=>x.id===id);
  if(!c) return;
  const actCnt = activities.filter(a=>a.contactId===id).length;
  document.getElementById('delContactInfo').innerHTML =
    `<strong>${c.last}${c.first}</strong>${c.company?' Â· '+c.company:''}<br>
     <span style="font-size:12px;color:var(--muted)">ê´€ë ¨ í™œë™ ${actCnt}ê±´ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.</span>`;
  document.getElementById('delContactConfirmBtn').onclick = ()=>{
    contacts = contacts.filter(x=>x.id!==id);
    activities = activities.filter(a=>a.contactId!==id);
    persist();
    closeModal('delContactModal');
    backToList();
  };
  document.getElementById('delContactModal').classList.add('open');
}

// â”€â”€ COMPANY MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _finRows=[];  // [{year,headcount,revenue,op_profit,net_profit,assets,liabilities}]
let _ceoRows=[];  // [{from,to,name,memo}]

function switchCoTab(tab){
  ['basic','finance','ceo'].forEach(t=>{
    document.getElementById('coTab-'+t).classList.toggle('active',t===tab);
    document.getElementById('coPanel-'+t).style.display=t===tab?'':'none';
  });
}

function addFinanceRow(data={}){
  const yr=data.year||(new Date().getFullYear());
  _finRows.push({...{year:yr,headcount:'',revenue:'',op_profit:'',net_profit:'',assets:'',liabilities:''},...data});
  renderFinTable();
}
function renderFinTable(){
  // sort by year desc
  _finRows.sort((a,b)=>Number(b.year)-Number(a.year));
  const tbody=document.getElementById('finBody');
  tbody.innerHTML=_finRows.map((r,i)=>`
    <tr>
      <td><input class="fin-year" value="${r.year}" onchange="_finRows[${i}].year=this.value" placeholder="2024"></td>
      <td><input class="fin-input" value="${r.headcount}" onchange="_finRows[${i}].headcount=this.value" placeholder="â€”"></td>
      <td><input class="fin-input" value="${r.revenue}" onchange="_finRows[${i}].revenue=this.value" placeholder="â€”"></td>
      <td><input class="fin-input" value="${r.op_profit}" onchange="_finRows[${i}].op_profit=this.value" placeholder="â€”"></td>
      <td><input class="fin-input" value="${r.net_profit}" onchange="_finRows[${i}].net_profit=this.value" placeholder="â€”"></td>
      <td><input class="fin-input" value="${r.assets}" onchange="_finRows[${i}].assets=this.value" placeholder="â€”"></td>
      <td><input class="fin-input" value="${r.liabilities}" onchange="_finRows[${i}].liabilities=this.value" placeholder="â€”"></td>
      <td><button class="fin-del" onclick="_finRows.splice(${i},1);renderFinTable()">âœ•</button></td>
    </tr>`).join('');
}

function addCeoRow(data={}){
  _ceoRows.unshift({...{from:'',to:'',name:'',memo:''},...data});
  renderCeoList();
}
function renderCeoList(){
  const div=document.getElementById('ceoList');
  if(!_ceoRows.length){
    div.innerHTML=`<div style="text-align:center;padding:24px;color:var(--muted);font-size:13px">ë“±ë¡ëœ ëŒ€í‘œì´ì‚¬ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
    return;
  }
  div.innerHTML=`
    <div class="ceo-header"><span>ì·¨ì„ì—°ë„</span><span>ì´ë¦„</span><span>í‡´ì„ì—°ë„</span><span>ë¹„ê³ </span><span></span></div>
    ${_ceoRows.map((r,i)=>`
    <div class="ceo-row">
      <input class="ceo-input" value="${r.from}" onchange="_ceoRows[${i}].from=this.value" placeholder="2020">
      <input class="ceo-input" value="${r.name}" onchange="_ceoRows[${i}].name=this.value" placeholder="í™ê¸¸ë™">
      <input class="ceo-input" value="${r.to}" onchange="_ceoRows[${i}].to=this.value" placeholder="í˜„ì¬">
      <input class="ceo-input" value="${r.memo}" onchange="_ceoRows[${i}].memo=this.value" placeholder="ë©”ëª¨">
      <button class="ceo-del" onclick="_ceoRows.splice(${i},1);renderCeoList()">âœ•</button>
    </div>`).join('')}`;
}

function openCompanyModal(co){
  editCoName=co;
  const ci=companies[co]||{};
  document.getElementById('coModalTitle').textContent=co;
  document.getElementById('co_name').value=co;
  document.getElementById('co_phone').value=ci.phone||'';
  document.getElementById('co_fax').value=ci.fax||'';
  document.getElementById('co_address').value=ci.address||'';
  document.getElementById('co_memo').value=ci.memo||'';
  document.getElementById('co_our_team').value=ci.ourTeam||'';
  document.getElementById('co_our_name').value=ci.ourName||'';
  document.getElementById('co_our_memo').value=ci.ourMemo||'';

  // ì¬ë¬´ ë°ì´í„° ë¡œë“œ
  _finRows=(ci.finance||[]).map(r=>({...r}));
  renderFinTable();
  if(!_finRows.length) addFinanceRow({year:new Date().getFullYear()});

  // ëŒ€í‘œì´ì‚¬ ì´ë ¥ ë¡œë“œ
  _ceoRows=(ci.ceoHistory||[]).map(r=>({...r}));
  renderCeoList();

  // ë³‘í•© ëŒ€ìƒ ëª©ë¡
  const sel=document.getElementById('co_merge_target');
  const allCos=[...new Set(contacts.map(c=>c.company).filter(Boolean))].sort();
  sel.innerHTML='<option value="">â€” ë³‘í•© ì•ˆ í•¨ â€”</option>'
    +allCos.filter(n=>n!==co).map(n=>{
      const cnt=contacts.filter(c=>c.company===n).length;
      return `<option value="${n.replace(/"/g,'&quot;')}">${n} (${cnt}ëª…)</option>`;
    }).join('');
  sel.value='';
  document.getElementById('co_merge_preview').style.display='none';
  sel.onchange=()=>{
    const target=sel.value;
    const prev=document.getElementById('co_merge_preview');
    if(!target){ prev.style.display='none'; return; }
    const cnt=contacts.filter(c=>c.company===target).length;
    prev.style.display='';
    prev.textContent=`âš  "${target}" ì†Œì† ${cnt}ëª…ì´ "${co}"ë¡œ ì´ë™ë©ë‹ˆë‹¤. ì €ì¥ ì‹œ ì ìš©ë©ë‹ˆë‹¤.`;
  };

  switchCoTab('basic');
  document.getElementById('companyModal').classList.add('open');
}

function saveCompany(){
  if(!editCoName) return;
  const newName=document.getElementById('co_name').value.trim();
  const mergeTarget=document.getElementById('co_merge_target').value;
  if(!newName){ alert('íšŒì‚¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }

  // â‘  ë³‘í•© â€” confirm ëŒ€ì‹  ì „ìš© ëª¨ë‹¬
  if(mergeTarget){
    const cnt=contacts.filter(c=>c.company===mergeTarget).length;
    document.getElementById('mergeConfirmInfo').innerHTML=
      `<div>ì—†ì•¨ íšŒì‚¬&nbsp;&nbsp;<strong style="color:var(--accent2)">${mergeTarget}</strong> <span style="color:var(--muted)">(${cnt}ëª…)</span></div>
       <div>í•©ì¹  íšŒì‚¬&nbsp;&nbsp;<strong style="color:var(--accent3)">${newName}</strong></div>
       <div style="margin-top:8px;font-size:12px;color:var(--muted)">â†’ "${mergeTarget}" ì†Œì† ${cnt}ëª…ì´ "${newName}"ìœ¼ë¡œ ì´ë™ë©ë‹ˆë‹¤.</div>`;
    document.getElementById('mergeConfirmBtn').onclick=()=>{
      closeModal('mergeConfirmModal');
      _doSaveCompany(newName, mergeTarget);
    };
    document.getElementById('mergeConfirmModal').classList.add('open');
    return;
  }

  _doSaveCompany(newName, null);
}

function _doSaveCompany(newName, mergeTarget){
  // â‘  ë³‘í•©
  if(mergeTarget){
    contacts.forEach(c=>{ if(c.company===mergeTarget) c.company=newName; });
    // ë³‘í•© ëŒ€ìƒ í™œë™ë„ ì´ì „
    const mergedInfo = companies[mergeTarget]||{};
    delete companies[mergeTarget];
    // ì¬ë¬´/ëŒ€í‘œì´ì‚¬ ë°ì´í„° ë³‘í•© (ê¸°ì¡´ ë°ì´í„° ë³´ì¡´)
    if(!companies[newName]) companies[newName]={};
    if(mergedInfo.finance?.length && !companies[newName].finance?.length)
      companies[newName].finance = mergedInfo.finance;
    if(mergedInfo.ceoHistory?.length && !companies[newName].ceoHistory?.length)
      companies[newName].ceoHistory = mergedInfo.ceoHistory;
  }

  // â‘¡ íšŒì‚¬ëª… ë³€ê²½
  if(newName!==editCoName){
    contacts.forEach(c=>{ if(c.company===editCoName) c.company=newName; });
    const oldInfo=companies[editCoName]||{};
    delete companies[editCoName];
    if(!companies[newName]) companies[newName]={};
    companies[newName]={...oldInfo,...companies[newName]};
  }

  // â‘¢ ê³µí†µ ì •ë³´ ì €ì¥
  if(!companies[newName]) companies[newName]={};
  companies[newName].phone     = document.getElementById('co_phone').value.trim();
  companies[newName].fax       = document.getElementById('co_fax').value.trim();
  companies[newName].address   = document.getElementById('co_address').value.trim();
  companies[newName].memo      = document.getElementById('co_memo').value.trim();
  companies[newName].ourTeam   = document.getElementById('co_our_team').value.trim();
  companies[newName].ourName   = document.getElementById('co_our_name').value.trim();
  companies[newName].ourMemo   = document.getElementById('co_our_memo').value.trim();
  companies[newName].finance   = _finRows.filter(r=>r.year).map(r=>({
    year:r.year, headcount:r.headcount, revenue:r.revenue,
    op_profit:r.op_profit, net_profit:r.net_profit,
    assets:r.assets, liabilities:r.liabilities
  }));
  companies[newName].ceoHistory= _ceoRows.filter(r=>r.name);

  persist();
  closeModal('companyModal');
  renderContacts();
}

// â”€â”€ ACTIVITY MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let editActId = null;

function openActModal_contact(cid){
  editActId = null;
  actCid = cid;
  const c = contacts.find(x=>x.id===cid);
  document.getElementById('actModalTitle').textContent = 'í™œë™ ì¶”ê°€';
  document.getElementById('actWhoSection').style.display = '';
  document.getElementById('actWho').innerHTML = `${c?c.last+c.first:''} ${c&&c.company?'<span style="font-size:12px;color:var(--muted)">Â· '+c.company+'</span>':''}`;
  _resetActForm();
  document.getElementById('activityModal').classList.add('open');
}

function openActModal_co(co){
  const members = contacts.filter(c=>(c.company||'').trim()===co);
  if(!members.length){ alert('ë¨¼ì € ë‹´ë‹¹ìë¥¼ ì¶”ê°€í•˜ì„¸ìš”.'); return; }
  editActId = null;
  actCid = members[0].id;
  document.getElementById('actModalTitle').textContent = 'í™œë™ ì¶”ê°€';
  document.getElementById('actWhoSection').style.display = '';
  if(members.length===1){
    const c = members[0];
    document.getElementById('actWho').innerHTML = `${c.last+c.first} <span style="font-size:12px;color:var(--muted)">Â· ${co}</span>`;
    _resetActForm();
    document.getElementById('activityModal').classList.add('open');
  } else {
    document.getElementById('actWho').innerHTML =
      `<select id="actPicker" onchange="actCid=this.value" style="background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:5px 8px;font-family:inherit;font-size:13px;outline:none;width:100%">
        ${members.map(m=>`<option value="${m.id}">${m.last}${m.first} (${m.dept||m.position||''})</option>`).join('')}
      </select>`;
    _resetActForm();
    document.getElementById('activityModal').classList.add('open');
  }
}

function openEditAct(id){
  const a = activities.find(x=>x.id===id);
  if(!a) return;
  editActId = id;
  actCid = a.contactId;
  const c = contacts.find(x=>x.id===a.contactId);
  document.getElementById('actModalTitle').textContent = 'í™œë™ ìˆ˜ì •';
  document.getElementById('actWhoSection').style.display = '';
  document.getElementById('actWho').innerHTML = c ? `${c.last}${c.first} <span style="font-size:12px;color:var(--muted)">Â· ${c.company||''}</span>` : '';
  document.getElementById('a_type').value   = a.type  || 'other';
  document.getElementById('a_date').value   = a.date  || '';
  document.getElementById('a_title').value  = a.title || '';
  document.getElementById('a_content').value= a.content|| '';
  document.getElementById('a_amount').value = a.amount || '';
  document.getElementById('activityModal').classList.add('open');
}

function _resetActForm(){
  refreshTypeSelect();
  document.getElementById('a_date').value   = new Date().toISOString().slice(0,10);
  document.getElementById('a_type').value   = actTypes[0]?.id || 'order';
  ['a_title','a_content','a_amount'].forEach(id=>document.getElementById(id).value='');
}

function saveActivity(){
  const picker = document.getElementById('actPicker');
  if(picker) actCid = picker.value;
  if(!actCid){ alert('ë‹´ë‹¹ìë¥¼ ì„ íƒí•˜ì„¸ìš”.'); return; }
  const date = document.getElementById('a_date').value;
  if(!date){ alert('ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  const data = {
    contactId: actCid,
    type:    document.getElementById('a_type').value,
    date,
    title:   document.getElementById('a_title').value.trim(),
    content: document.getElementById('a_content').value.trim(),
    amount:  document.getElementById('a_amount').value.trim(),
  };
  if(editActId){
    // ìˆ˜ì •
    const idx = activities.findIndex(a=>a.id===editActId);
    if(idx>-1) activities[idx] = {...activities[idx], ...data};
  } else {
    // ì‹ ê·œ
    activities.push({id:uid(), createdAt:new Date().toISOString(), ...data});
  }
  editActId = null;
  persist();
  closeModal('activityModal');
  if(currentCid) showDetail(currentCid); else renderContacts();
}

function delAct(id, fromDetail=false){
  const a = activities.find(x=>x.id===id);
  if(!a) return;
  const c = contacts.find(x=>x.id===a.contactId);
  const typeLabel = {visit:'ğŸ¤ ë°©ë¬¸', call:'ğŸ“ í†µí™”', quote:'ğŸ“„ ê²¬ì ', order:'ğŸ“¦ ë°œì£¼', other:'ğŸ“Œ ê¸°íƒ€'};
  document.getElementById('delActInfo').innerHTML = `
    <div style="display:flex;flex-direction:column;gap:4px">
      <div><span style="color:var(--muted);font-size:11px;font-family:'IBM Plex Mono',monospace">ìœ í˜•</span>&nbsp;&nbsp;${typeLabel[a.type]||a.type}</div>
      <div><span style="color:var(--muted);font-size:11px;font-family:'IBM Plex Mono',monospace">ë‚ ì§œ</span>&nbsp;&nbsp;${a.date}</div>
      ${a.title?`<div><span style="color:var(--muted);font-size:11px;font-family:'IBM Plex Mono',monospace">ì œëª©</span>&nbsp;&nbsp;${a.title}</div>`:''}
      ${a.content?`<div><span style="color:var(--muted);font-size:11px;font-family:'IBM Plex Mono',monospace">ë‚´ìš©</span>&nbsp;&nbsp;<span style="color:var(--muted)">${a.content.length>50?a.content.slice(0,50)+'â€¦':a.content}</span></div>`:''}
      ${c?`<div><span style="color:var(--muted);font-size:11px;font-family:'IBM Plex Mono',monospace">ë‹´ë‹¹ì</span>&nbsp;&nbsp;${c.last}${c.first}${c.company?' Â· '+c.company:''}</div>`:''}
    </div>`;
  document.getElementById('delActConfirmBtn').onclick = ()=>{
    activities = activities.filter(x=>x.id!==id);
    persist();
    closeModal('delActModal');
    if(fromDetail && currentCid) showDetail(currentCid);
    else { renderContacts(); renderAllActs(); }
  };
  document.getElementById('delActModal').classList.add('open');
}

// â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function closeModal(id){ document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.modal-overlay').forEach(o=>{ o.addEventListener('click',e=>{ if(e.target===o) o.classList.remove('open'); }); });

function renderStats(){
  const today = new Date();
  const todayStr = today.toISOString().slice(0,10);

  // 1ì£¼ì¼ ì „ ë‚ ì§œ (ì˜¤ëŠ˜ í¬í•¨ 7ì¼)
  const weekAgo = new Date(today);
  weekAgo.setDate(weekAgo.getDate() - 6);
  const weekAgoStr = weekAgo.toISOString().slice(0,10);

  const cos = [...new Set(contacts.map(c=>c.company).filter(Boolean))];

  // ë‹¹ì¼ ì‹ ê·œ ì—°ë½ì²˜ (createdAt ê¸°ì¤€)
  const newContacts = contacts.filter(c=>(c.createdAt||'').slice(0,10)===todayStr).length;
  // ë‹¹ì¼ ì‹ ê·œ í™œë™ (ë“±ë¡ì¼ createdAt ê¸°ì¤€)
  const newActs = activities.filter(a=>(a.createdAt||'').slice(0,10)===todayStr).length;

  // í™œë™ ìœ í˜•ë³„ â€” í™œë™ì˜ date í•„ë“œ ê¸°ì¤€, ìµœê·¼ 7ì¼
  const weekActs = activities.filter(a=>{
    const d = (a.date||'').slice(0,10);
    return d >= weekAgoStr && d <= todayStr;
  });

  // ì‚¬ì´ë“œë°” ë°°ì§€ ì—…ë°ì´íŠ¸
  const cBadge  = document.getElementById('todayContacts');
  const aBadge  = document.getElementById('todayActivities');
  const mcBadge = document.getElementById('mTodayContacts');
  const maBadge = document.getElementById('mTodayActivities');
  [cBadge, mcBadge].forEach(b=>{ if(b){ b.textContent='+'+newContacts; b.style.display=newContacts>0?'inline-block':'none'; }});
  [aBadge, maBadge].forEach(b=>{ if(b){ b.textContent='+'+newActs;     b.style.display=newActs>0?'inline-block':'none'; }});

  const typeRows = actTypes.map(t=>{
    const cnt = weekActs.filter(a=>a.type===t.id).length;
    if(!cnt) return '';
    return `<div class="stat-row"><span>${t.emoji} ${t.label}</span><span>${cnt}</span></div>`;
  }).join('');

  document.getElementById('sidebarStats').innerHTML=`
    <div class="stat-row"><span>íšŒì‚¬</span><span>${cos.length}</span></div>
    <div class="stat-row">
      <span>ì—°ë½ì²˜</span>
      <span>${contacts.length}${newContacts>0?` <span style="color:#ff6b6b;font-size:10px;font-weight:700">+${newContacts}ì˜¤ëŠ˜</span>`:''}</span>
    </div>
    <div class="stat-row">
      <span>ì´ í™œë™</span>
      <span>${activities.length}${newActs>0?` <span style="color:#ff6b6b;font-size:10px;font-weight:700">+${newActs}ì˜¤ëŠ˜</span>`:''}</span>
    </div>
    <div style="border-top:1px solid var(--border);margin:6px 0;opacity:.3"></div>
    <div style="font-size:10px;color:var(--muted);margin-bottom:4px;font-family:'IBM Plex Mono',monospace">
      í™œë™ ìœ í˜•ë³„ <span style="opacity:.6">(ìµœê·¼ 7ì¼)</span>
    </div>
    ${typeRows || `<div style="font-size:10px;color:var(--border);padding:2px 0">ìµœê·¼ 7ì¼ í™œë™ ì—†ìŒ</div>`}
    <div style="border-top:1px solid var(--border);margin:6px 0;opacity:.3"></div>
    <div style="font-size:10px;color:var(--muted);font-family:'IBM Plex Mono',monospace;text-align:right">
      ${weekAgoStr} ~ ${todayStr}
    </div>`;
}

// â”€â”€ PDF IMPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let pdfBase64 = null;
let pdfFileType = null;
let pdfExtracted = [];
let pdfActivities = [];

function pdfShowStep(n){
  for(let i=0;i<=4;i++) document.getElementById('pdfStep'+i).style.display = i===n ? '' : 'none';
}

function openPdfModal(){
  pdfBase64 = null;
  pdfFileType = null;
  pdfExtracted = [];
  pdfActivities = [];
  document.getElementById('pdfFileInput').value='';
  document.getElementById('pdfFileName').style.display='none';
  document.getElementById('pdfFileTypeNote').style.display='none';
  document.getElementById('pdfAnalyzeBtn').disabled=true;
  document.getElementById('dropIcon').textContent='ğŸ—‚';
  const key = localStorage.getItem('crm_api_key');
  // í‚¤ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
  const prev = document.getElementById('keyPreview');
  if(prev && key) prev.textContent = '(í˜„ì¬: ' + key.slice(0,12) + '...)';
  pdfShowStep(key ? 1 : 0);
  document.getElementById('pdfModal').classList.add('open');
}

function pdfSaveKey(){
  const key = document.getElementById('pdfApiKey').value.trim();
  if(!key){ alert('API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
  if(!key.startsWith('sk-')){ alert('ì˜¬ë°”ë¥¸ API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.\ní‚¤ëŠ” sk- ë¡œ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤.'); return; }
  localStorage.setItem('crm_api_key', key);
  pdfShowStep(1);
}

function pdfChangeKey(){
  const key = localStorage.getItem('crm_api_key')||'';
  const input = document.getElementById('pdfApiKey');
  input.value = key;
  input.type = 'password';
  const prev = document.getElementById('keyPreview');
  if(prev && key) prev.textContent = '(í˜„ì¬: ' + key.slice(0,12) + '...)';
  pdfShowStep(0);
}

// íŒŒì¼ ìœ í˜• ê°ì§€
function detectFileType(file){
  const name = file.name.toLowerCase();
  const mime = file.type;
  if(mime==='application/pdf' || name.endsWith('.pdf'))
    return {kind:'pdf', mediaType:'application/pdf', icon:'ğŸ“„', label:'PDF ë¬¸ì„œ'};
  if(['image/jpeg','image/jpg','image/png','image/webp','image/gif'].includes(mime) ||
     /\.(jpg|jpeg|png|webp|gif)$/.test(name))
    return {kind:'image', mediaType: mime||'image/jpeg', icon:'ğŸ–¼', label:'ì´ë¯¸ì§€ (ëª…í•¨Â·ì‚¬ì§„)'};
  if(mime==='text/plain' || name.endsWith('.txt'))
    return {kind:'text', mediaType:'text/plain', icon:'ğŸ“', label:'í…ìŠ¤íŠ¸ íŒŒì¼'};
  if(mime==='text/csv' || name.endsWith('.csv'))
    return {kind:'text', mediaType:'text/csv', icon:'ğŸ“Š', label:'CSV íŒŒì¼'};
  if(/\.(xls|xlsx)$/.test(name))
    return {kind:'text', mediaType:'text/plain', icon:'ğŸ“Š', label:'ì—‘ì…€ íŒŒì¼'};
  if(/\.(doc|docx)$/.test(name))
    return {kind:'text', mediaType:'text/plain', icon:'ğŸ“‹', label:'Word íŒŒì¼'};
  return {kind:'text', mediaType:'text/plain', icon:'ğŸ“', label:'íŒŒì¼'};
}



function onPdfSelected(input){
  const file = input.files[0];
  if(!file) return;
  if(file.size > 10*1024*1024){ alert('íŒŒì¼ í¬ê¸°ê°€ 10MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.'); return; }

  const ft = detectFileType(file);
  pdfFileType = ft;

  const nameEl = document.getElementById('pdfFileName');
  nameEl.innerHTML = ft.icon + ' <strong>' + file.name + '</strong> <span style="color:var(--muted)">(' + (file.size/1024).toFixed(0) + 'KB)</span>';
  nameEl.style.display = '';

  const noteEl = document.getElementById('pdfFileTypeNote');
  noteEl.innerHTML = 'ê°ì§€ëœ ìœ í˜•: <span style="color:var(--accent)">' + ft.label + '</span>';
  noteEl.style.display = '';

  document.getElementById('dropIcon').textContent = ft.icon;
  document.getElementById('pdfAnalyzeBtn').disabled = false;

  const reader = new FileReader();
  if(ft.kind === 'text'){
    reader.onload = e => {
      try { pdfBase64 = btoa(unescape(encodeURIComponent(e.target.result))); }
      catch(ex){ pdfBase64 = btoa(e.target.result); }
    };
    reader.readAsText(file, 'UTF-8');
  } else {
    reader.onload = e => { pdfBase64 = e.target.result.split(',')[1]; };
    reader.readAsDataURL(file);
  }
}

// Drag & drop support
(function(){
  const dz = document.getElementById('pdfDropzone');
  if(!dz) return;
  dz.addEventListener('dragover', e=>{ e.preventDefault(); dz.classList.add('drag'); });
  dz.addEventListener('dragleave', ()=> dz.classList.remove('drag'));
  dz.addEventListener('drop', e=>{
    e.preventDefault(); dz.classList.remove('drag');
    const file = e.dataTransfer.files[0];
    if(!file) return;
    const fi = document.getElementById('pdfFileInput');
    const dt = new DataTransfer();
    dt.items.add(file);
    fi.files = dt.files;
    onPdfSelected(fi);
  });
})();

async function pdfAnalyze(){
  if(!pdfBase64){ alert('íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
  const apiKey = localStorage.getItem('crm_api_key');
  if(!apiKey){ alert('API í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.'); pdfShowStep(0); return; }

  const ft = pdfFileType || {kind:'pdf', mediaType:'application/pdf', icon:'ğŸ“„', label:'íŒŒì¼'};
  const loadMsg = document.getElementById('pdfLoadingMsg');
  if(loadMsg) loadMsg.textContent = ft.icon + ' ' + ft.label + ' ë¶„ì„ ì¤‘...';
  pdfShowStep(2);

  const prompt = `ì´ íŒŒì¼ì—ì„œ ì—°ë½ì²˜ ì •ë³´ì™€ ê±°ë˜/í™œë™ ë‚´ì—­ì„ ëª¨ë‘ ì¶”ì¶œí•´ì£¼ì„¸ìš”.
ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”. ë‹¤ë¥¸ ì„¤ëª… í…ìŠ¤íŠ¸ ì—†ì´ JSONë§Œ:

{
  "contacts": [
    {
      "company": "íšŒì‚¬ëª…",
      "dept": "ë¶€ì„œ",
      "position": "ì§ì±…",
      "last": "ì„±",
      "first": "ì´ë¦„",
      "email": "ì´ë©”ì¼",
      "office": "ì‚¬ë¬´ì‹¤ì „í™”",
      "mobile": "íœ´ëŒ€í°",
      "extra": "íŒ©ìŠ¤ ë“± ì¶”ê°€ì—°ë½ì²˜",
      "address": "ì£¼ì†Œ",
      "memo": "ê¸°íƒ€ì •ë³´"
    }
  ],
  "activities": [
    {
      "date": "YYYY-MM-DD",
      "type": "visit ë˜ëŠ” call ë˜ëŠ” quote ë˜ëŠ” order ë˜ëŠ” other",
      "title": "í•œ ì¤„ ì œëª©",
      "content": "ìƒì„¸ ë‚´ìš©",
      "amount": "ê¸ˆì•¡(ìˆ«ìë§Œ, ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)"
    }
  ]
}

ê·œì¹™:
- ëª…í•¨ ì´ë¯¸ì§€ë¼ë©´ ëª…í•¨ì— ë³´ì´ëŠ” ëª¨ë“  ì •ë³´ë¥¼ ì¶”ì¶œí•˜ì„¸ìš”.
- ì—¬ëŸ¬ ëª…í•¨ì´ ìˆìœ¼ë©´ ê°ê° ë¶„ë¦¬í•´ì„œ ì¶”ì¶œí•˜ì„¸ìš”.
- í•œêµ­ ì´ë¦„ì€ ì„±(last)ê³¼ ì´ë¦„(first)ì„ ë¶„ë¦¬. ì˜ˆ: ê¹€ì² ìˆ˜ â†’ last:"ê¹€", first:"ì² ìˆ˜"
- ë‚ ì§œëŠ” ë°˜ë“œì‹œ YYYY-MM-DD í˜•ì‹. ì˜ˆ: 2024.06.26 â†’ "2024-06-26"
- ê±°ë˜ ìœ í˜• ë§¤í•‘: ë°©ë¬¸â†’visit, í†µí™”â†’call, ê²¬ì â†’quote, ë°œì£¼â†’order, ê¸°íƒ€â†’other
- ê¸ˆì•¡: ìˆ«ìë§Œ. ì˜ˆ: "3880ë§Œ" â†’ "38800000"
- ì—†ëŠ” í•­ëª©ì€ ë¹ˆ ë¬¸ìì—´("")ë¡œ ë‘ì„¸ìš”.
- JSON ì™¸ ë‹¤ë¥¸ í…ìŠ¤íŠ¸ëŠ” ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.`;

  try {
    // íŒŒì¼ ìœ í˜•ë³„ content êµ¬ì„±
    let contentParts;
    if(ft.kind === 'image'){
      contentParts = [
        { type:'image', source:{ type:'base64', media_type: ft.mediaType, data: pdfBase64 } },
        { type:'text', text: prompt }
      ];
    } else if(ft.kind === 'text'){
      let textContent = '';
      try { textContent = decodeURIComponent(escape(atob(pdfBase64))); }
      catch(e){ textContent = atob(pdfBase64); }
      contentParts = [
        { type:'text', text: 'ì•„ë˜ëŠ” íŒŒì¼ ë‚´ìš©ì…ë‹ˆë‹¤:\n\n' + textContent + '\n\n' + prompt }
      ];
    } else {
      // PDF
      contentParts = [
        { type:'document', source:{ type:'base64', media_type:'application/pdf', data: pdfBase64 } },
        { type:'text', text: prompt }
      ];
    }

    const reqBody = {
      model: 'claude-opus-4-6',
      max_tokens: 4000,
      messages: [{ role:'user', content: contentParts }]
    };

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify(reqBody)
    });

    let data;
    try { data = await response.json(); }
    catch(e){ throw new Error('ì„œë²„ ì‘ë‹µì„ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (HTTP ' + response.status + ')'); }

    if(!response.ok){
      const errType = data?.error?.type || '';
      const errMsg  = data?.error?.message || JSON.stringify(data);
      if(response.status === 401) throw new Error('API í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. í‚¤ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.\n(' + errMsg + ')');
      if(response.status === 400) throw new Error('ìš”ì²­ ì˜¤ë¥˜ (400): ' + errMsg);
      if(response.status === 429) throw new Error('ìš”ì²­ í•œë„ ì´ˆê³¼ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      throw new Error('API ì˜¤ë¥˜ (' + response.status + '): ' + errMsg);
    }

    const raw = data.content?.find(b=>b.type==='text')?.text || '';
    if(!raw) throw new Error('AI ì‘ë‹µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');

    // JSON ì¶”ì¶œ â€” ë‹¤ì–‘í•œ íŒ¨í„´ ì‹œë„
    let parsed = null;
    const jsonMatch = raw.match(/\{[\s\S]*\}/);
    if(jsonMatch){
      try { parsed = JSON.parse(jsonMatch[0]); } catch(e){}
    }
    if(!parsed) throw new Error('ì‘ë‹µì—ì„œ JSONì„ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì›ë³¸: ' + raw.slice(0,200));

    pdfExtracted  = parsed.contacts   || [];
    pdfActivities = parsed.activities || [];

    if(!pdfExtracted.length && !pdfActivities.length)
      throw new Error('ì¶”ì¶œëœ ì—°ë½ì²˜ë‚˜ í™œë™ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.\níŒŒì¼ì— ì—°ë½ì²˜ ê´€ë ¨ ë‚´ìš©ì´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');

    renderPdfResults();
    pdfShowStep(3);

  } catch(err) {
    const msg = (err.message || String(err)).replace(/\n/g,'<br>');
    document.getElementById('pdfErrorMsg').innerHTML =
      `<div style="background:rgba(255,107,107,0.1);border:1px solid rgba(255,107,107,0.3);border-radius:8px;padding:12px 14px;margin-bottom:12px;text-align:left;word-break:break-all">${msg}</div>
       <div style="font-size:11px;color:var(--muted);line-height:1.8;text-align:left">
         <b>í™•ì¸ ì‚¬í•­:</b><br>
         â€¢ API í‚¤ê°€ <code>sk-ant-</code>ë¡œ ì‹œì‘í•˜ëŠ”ì§€ í™•ì¸<br>
         â€¢ PDFê°€ ì•”í˜¸í™”ë˜ì–´ ìˆì§€ ì•Šì€ì§€ í™•ì¸<br>
         â€¢ ì´ë¯¸ì§€ëŠ” JPG Â· PNG Â· WEBP ê¶Œì¥<br>
         â€¢ íŒŒì¼ì´ ë„ˆë¬´ í¬ê±°ë‚˜ ì†ìƒë˜ì§€ ì•Šì•˜ëŠ”ì§€ í™•ì¸
       </div>`;
    pdfShowStep(4);
  }
}

function pdfRetry(){
  pdfBase64=null; pdfExtracted=[]; pdfActivities=[]; pdfFileType=null;
  document.getElementById('pdfFileInput').value='';
  document.getElementById('pdfFileName').style.display='none';
  document.getElementById('pdfFileTypeNote').style.display='none';
  document.getElementById('pdfAnalyzeBtn').disabled=true;
  document.getElementById('dropIcon').textContent='ğŸ—‚';
  pdfShowStep(1);
}

function esc2(s){ return (s||'').replace(/"/g,'&quot;').replace(/</g,'&lt;'); }

function renderPdfResults(){
  const div = document.getElementById('pdfResults');
  const typeLabel = {};
  actTypes.forEach(t=>{ typeLabel[t.id] = t.emoji+' '+t.label; });

  let html = '';

  // â”€â”€ ì—°ë½ì²˜ ì„¹ì…˜ â”€â”€
  if(pdfExtracted.length){
    html += `<div style="font-size:11px;font-family:'IBM Plex Mono',monospace;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border)">ğŸ‘¤ ì—°ë½ì²˜ (${pdfExtracted.length}ëª…)</div>`;
    html += pdfExtracted.map((p,i)=>{
      const name=(p.last||'')+(p.first||'')||'ì´ë¦„ ì—†ìŒ';
      return `<div class="pdf-contact-card checked" id="pdfCard${i}">
        <div class="pdf-card-header">
          <input type="checkbox" class="pdf-card-check" id="pdfCheck${i}" checked onchange="document.getElementById('pdfCard${i}').classList.toggle('checked',this.checked)">
          <div class="pdf-card-name">${name} ${p.company?'<span style="font-size:12px;color:var(--muted);font-weight:400">Â· '+p.company+'</span>':''}</div>
        </div>
        <div class="pdf-fields">
          <div class="pdf-field"><label>íšŒì‚¬</label><input id="pr${i}_company" value="${esc2(p.company)}"></div>
          <div class="pdf-field"><label>ë¶€ì„œ</label><input id="pr${i}_dept" value="${esc2(p.dept)}"></div>
          <div class="pdf-field"><label>ì§ì±…</label><input id="pr${i}_position" value="${esc2(p.position)}"></div>
          <div class="pdf-field"><label>ì„±</label><input id="pr${i}_last" value="${esc2(p.last)}"></div>
          <div class="pdf-field"><label>ì´ë¦„</label><input id="pr${i}_first" value="${esc2(p.first)}"></div>
          <div class="pdf-field"><label>ì´ë©”ì¼</label><input id="pr${i}_email" value="${esc2(p.email)}"></div>
          <div class="pdf-field"><label>ì‚¬ë¬´ì‹¤</label><input id="pr${i}_office" value="${esc2(p.office)}"></div>
          <div class="pdf-field"><label>íœ´ëŒ€í°</label><input id="pr${i}_mobile" value="${esc2(p.mobile)}"></div>
          <div class="pdf-field"><label>ì¶”ê°€ì—°ë½ì²˜</label><input id="pr${i}_extra" value="${esc2(p.extra)}"></div>
          <div class="pdf-field full"><label>ì£¼ì†Œ</label><input id="pr${i}_address" value="${esc2(p.address)}"></div>
          <div class="pdf-field full"><label>ë©”ëª¨</label><input id="pr${i}_memo" value="${esc2(p.memo)}"></div>
        </div>
      </div>`;
    }).join('');
  }

  // â”€â”€ í™œë™ ì„¹ì…˜ â”€â”€
  if(pdfActivities.length){
    html += `<div style="font-size:11px;font-family:'IBM Plex Mono',monospace;color:var(--accent3);text-transform:uppercase;letter-spacing:1px;margin:18px 0 8px;padding-bottom:6px;border-bottom:1px solid var(--border)">ğŸ“‹ í™œë™ ë‚´ì—­ (${pdfActivities.length}ê±´) â€” ì—°ë½ì²˜ ì €ì¥ í›„ ìë™ ì—°ê²°ë©ë‹ˆë‹¤</div>`;
    html += `<div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;overflow:hidden">
      <table style="width:100%;border-collapse:collapse;font-size:12px">
        <thead><tr style="background:var(--surface)">
          <th style="padding:8px 10px;text-align:left;font-size:10px;color:var(--muted);font-family:'IBM Plex Mono',monospace;font-weight:400;border-bottom:1px solid var(--border);width:28px"></th>
          <th style="padding:8px 10px;text-align:left;font-size:10px;color:var(--muted);font-family:'IBM Plex Mono',monospace;font-weight:400;border-bottom:1px solid var(--border);width:100px">ë‚ ì§œ</th>
          <th style="padding:8px 10px;text-align:left;font-size:10px;color:var(--muted);font-family:'IBM Plex Mono',monospace;font-weight:400;border-bottom:1px solid var(--border);width:80px">ìœ í˜•</th>
          <th style="padding:8px 10px;text-align:left;font-size:10px;color:var(--muted);font-family:'IBM Plex Mono',monospace;font-weight:400;border-bottom:1px solid var(--border)">ë‚´ìš©</th>
          <th style="padding:8px 10px;text-align:right;font-size:10px;color:var(--muted);font-family:'IBM Plex Mono',monospace;font-weight:400;border-bottom:1px solid var(--border);width:90px">ê¸ˆì•¡</th>
        </tr></thead>
        <tbody>
          ${pdfActivities.map((a,i)=>{
            const tl = typeLabel[a.type]||('ğŸ“Œ '+a.type);
            const amtDisp = a.amount ? 'â‚©'+Number(a.amount||0).toLocaleString() : '';
            return `<tr style="border-bottom:1px solid var(--border)">
              <td style="padding:7px 10px"><input type="checkbox" id="paCheck${i}" checked style="accent-color:var(--accent3)"></td>
              <td style="padding:7px 10px;font-family:'IBM Plex Mono',monospace;color:var(--muted)">${a.date||''}</td>
              <td style="padding:7px 10px">${tl}</td>
              <td style="padding:7px 10px;color:var(--text)">${a.title||''}${a.content&&a.content!==a.title?'<div style="font-size:11px;color:var(--muted);margin-top:2px">'+a.content+'</div>':''}</td>
              <td style="padding:7px 10px;text-align:right;font-family:'IBM Plex Mono',monospace;color:var(--accent3);font-size:11px">${amtDisp}</td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>`;
  }

  div.innerHTML = html || '<div style="text-align:center;padding:24px;color:var(--muted)">ì¶”ì¶œëœ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
}

function pdfImportAll(){
  let addedContacts = 0, addedActs = 0;
  const newContactIds = [];

  // â‘  ì—°ë½ì²˜ ì €ì¥
  for(let i=0; i<pdfExtracted.length; i++){
    const chk = document.getElementById('pdfCheck'+i);
    if(!chk || !chk.checked) continue;
    const get = id => document.getElementById(`pr${i}_${id}`)?.value?.trim()||'';
    const last=get('last'), first=get('first');
    if(!last && !first) continue;
    const co=get('company'), addr=get('address');
    if(co && addr){ if(!companies[co]) companies[co]={}; if(!companies[co].address) companies[co].address=addr; }
    const newId = uid();
    contacts.unshift({ id:newId, createdAt:new Date().toISOString(),
      company:co, dept:get('dept'), position:get('position'), last, first,
      email:get('email'), office:get('office'), mobile:get('mobile'),
      extra:get('extra'), address:addr, memo:get('memo') });
    newContactIds.push(newId);
    addedContacts++;
  }

  // â‘¡ í™œë™ ì €ì¥ â€” ì²« ë²ˆì§¸ ì €ì¥ëœ ì—°ë½ì²˜ì— ì—°ê²°
  const targetId = newContactIds[0] || null;
  if(targetId && pdfActivities.length){
    for(let i=0; i<pdfActivities.length; i++){
      const chk = document.getElementById('paCheck'+i);
      if(!chk || !chk.checked) continue;
      const a = pdfActivities[i];
      activities.push({ id:uid(), contactId:targetId,
        type:a.type||'other', date:a.date||'',
        title:a.title||'', content:a.content||'', amount:a.amount||'',
        createdAt:new Date().toISOString() });
      addedActs++;
    }
  } else if(pdfActivities.length && !targetId){
    alert('í™œë™ì„ ì—°ê²°í•  ì—°ë½ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤. ì—°ë½ì²˜ë¥¼ ë¨¼ì € ì²´í¬í•´ì£¼ì„¸ìš”.');
    return;
  }

  persist();
  closeModal('pdfModal');
  renderContacts();
  const msg = [addedContacts?`ì—°ë½ì²˜ ${addedContacts}ëª…`:'', addedActs?`í™œë™ ${addedActs}ê±´`:''].filter(Boolean).join(', ');
  if(msg) alert(`âœ… ${msg} ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
}


// â”€â”€ TYPE MANAGER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEFAULT_TYPE_IDS = ['order','quote','visit','call','other'];
let _editTypes = [];

function openTypeModal(){
  _editTypes = actTypes.map(t=>({...t}));
  renderTypeList();
  document.getElementById('typeModal').classList.add('open');
}

function renderTypeList(){
  const div = document.getElementById('typeList');
  div.innerHTML = _editTypes.map((t,i)=>{
    const isDef = DEFAULT_TYPE_IDS.includes(t.id);
    return `<div style="display:grid;grid-template-columns:36px 60px 1fr 120px auto;gap:8px;align-items:center;margin-bottom:8px">
      <div style="display:flex;flex-direction:column;gap:2px">
        ${i>0?`<button onclick="_editTypes.splice(${i}-1,0,_editTypes.splice(${i},1)[0]);renderTypeList()" style="background:none;border:1px solid var(--border);border-radius:4px;color:var(--muted);cursor:pointer;font-size:10px;padding:1px 4px;line-height:1">â–²</button>`:'<span></span>'}
        ${i<_editTypes.length-1?`<button onclick="_editTypes.splice(${i}+1,0,_editTypes.splice(${i},1)[0]);renderTypeList()" style="background:none;border:1px solid var(--border);border-radius:4px;color:var(--muted);cursor:pointer;font-size:10px;padding:1px 4px;line-height:1">â–¼</button>`:'<span></span>'}
      </div>
      <input value="${t.emoji}" maxlength="2" ${isDef?'readonly':''} onchange="_editTypes[${i}].emoji=this.value" style="padding:6px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:16px;text-align:center;outline:none;width:100%;${isDef?'opacity:.6':''}">
      <input value="${t.label}" ${isDef?'readonly':''} onchange="_editTypes[${i}].label=this.value" style="padding:6px 9px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:13px;font-family:inherit;outline:none;width:100%;${isDef?'opacity:.6':''}">
      <div style="display:flex;align-items:center;gap:6px">
        <input type="color" value="${t.color||'#7986cb'}" onchange="_editTypes[${i}].color=this.value" style="width:32px;height:28px;border:1px solid var(--border);border-radius:5px;background:var(--bg);cursor:pointer;padding:2px">
        <div style="width:20px;height:20px;border-radius:50%;background:${t.color||'#7986cb'}"></div>
      </div>
      ${isDef
        ? `<span style="font-size:11px;color:var(--muted);padding:0 8px">ê¸°ë³¸</span>`
        : `<button onclick="_editTypes.splice(${i},1);renderTypeList()" style="background:none;border:1px solid var(--border);border-radius:6px;color:var(--muted);cursor:pointer;font-size:13px;padding:4px 8px" onmouseover="this.style.borderColor='var(--danger)';this.style.color='var(--danger)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--muted)'">âœ•</button>`
      }
    </div>`;
  }).join('');
}

function addCustomType(){
  const emoji = document.getElementById('newTypeEmoji').value.trim()||'ğŸ”–';
  const label = document.getElementById('newTypeLabel').value.trim();
  const color = document.getElementById('newTypeColor').value;
  if(!label){ alert('ìœ í˜• ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  const id = 'custom_'+Date.now();
  _editTypes.push({id, label, emoji, color});
  document.getElementById('newTypeEmoji').value='';
  document.getElementById('newTypeLabel').value='';
  renderTypeList();
}

function saveTypes_modal(){
  actTypes = _editTypes;
  saveTypes(actTypes);
  rebuildTypeMaps();
  injectTypeStyles();
  refreshTypeSelect();
  refreshFilterBar();
  closeModal('typeModal');
  renderContacts();
}

function refreshTypeSelect(){
  const sel = document.getElementById('a_type');
  if(!sel) return;
  const cur = sel.value;
  sel.innerHTML = actTypes.map(t=>`<option value="${t.id}">${t.emoji} ${t.label}</option>`).join('');
  if(actTypes.find(t=>t.id===cur)) sel.value=cur;
}

function refreshFilterBar(){
  const bar = document.getElementById('actFilterBar');
  if(!bar) return;
  bar.innerHTML = `<button class="filter-chip${actFilter==='all'?' active':''}" onclick="setActFilter('all',this)">ì „ì²´</button>`
    + actTypes.map(t=>`<button class="filter-chip${actFilter===t.id?' active':''}" onclick="setActFilter('${t.id}',this)">${t.emoji} ${t.label}</button>`).join('');
}

// â”€â”€ GOOGLE SHEETS ì„¤ì • ëª¨ë‹¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openGsModal(){
  const input = document.getElementById('gsUrlInput');
  const statusDiv = document.getElementById('gsCurrentStatus');
  const disconnectBtn = document.getElementById('gsDisconnectBtn');
  const curUrlEl = document.getElementById('gsCurrentUrl');
  const lastSyncEl = document.getElementById('gsLastSyncInfo');

  input.value = gsUrl;
  if(gsUrl){
    statusDiv.style.display = '';
    disconnectBtn.style.display = '';
    curUrlEl.textContent = gsUrl;
    lastSyncEl.textContent = gsLastSync ? 'ë§ˆì§€ë§‰ ë™ê¸°í™”: ' + gsLastSync : 'ì•„ì§ ë™ê¸°í™” ì•ˆ ë¨';
  } else {
    statusDiv.style.display = 'none';
    disconnectBtn.style.display = 'none';
  }
  document.getElementById('gsUrlMsg').textContent = '';
  document.getElementById('gsModal').classList.add('open');
}

function gsSaveUrl(){
  const url = document.getElementById('gsUrlInput').value.trim();
  const msg = document.getElementById('gsUrlMsg');
  if(!url){
    msg.style.color = 'var(--accent2)';
    msg.textContent = 'URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
    return;
  }
  if(!url.includes('script.google.com')){
    msg.style.color = 'var(--accent2)';
    msg.textContent = 'âš  Google Apps Script URLì´ ì•„ë‹Œ ê²ƒ ê°™ìŠµë‹ˆë‹¤.';
    return;
  }
  gsUrl = url;
  localStorage.setItem('crm_gs_url', gsUrl);
  msg.style.color = 'var(--accent3)';
  msg.textContent = 'âœ… ì €ì¥ëìŠµë‹ˆë‹¤. ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
  closeModal('gsModal');
  gsLoad();
}

function gsDisconnect(){
  if(!confirm('Google Sheets ì—°ë™ì„ í•´ì œí• ê¹Œìš”?\në¡œì»¬ ë°ì´í„°ëŠ” ìœ ì§€ë©ë‹ˆë‹¤.')) return;
  gsUrl = '';
  localStorage.removeItem('crm_gs_url');
  gsUpdateStatus('offline', 'ë¡œì»¬ ì €ì¥ ëª¨ë“œ');
  closeModal('gsModal');
}

function gsManualLoad(){
  if(!gsUrl){
    document.getElementById('gsUrlMsg').textContent = 'ë¨¼ì € URLì„ ì €ì¥í•´ì£¼ì„¸ìš”.';
    return;
  }
  closeModal('gsModal');
  gsLoad();
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
injectTypeStyles();
refreshTypeSelect();
refreshFilterBar();
refreshTeamFilterBars();
renderStats();
renderContacts();

// Google Sheets ì—°ë™ ì‹œ ìë™ ë™ê¸°í™”
if(gsIsConnected()){
  gsUpdateStatus('syncing', 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
  gsLoad();
} else {
  gsUpdateStatus('offline', 'ë¡œì»¬ ì €ì¥ ëª¨ë“œ Â· â˜ï¸ í´ë¦­í•´ì„œ ì—°ë™');
}
</script>
</body>
</html>
