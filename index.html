<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CRM ê³ ê°ê´€ë¦¬</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #22263a;
    --border: #2d3250;
    --accent: #4f7cff;
    --accent2: #ff6b6b;
    --accent3: #43e97b;
    --accent4: #f7971e;
    --text: #e8eaf6;
    --muted: #7986cb;
    --danger: #ef5350;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Noto Sans KR', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; display: flex; }

  .sidebar {
    width: 260px; min-height: 100vh; background: var(--surface);
    border-right: 1px solid var(--border); display: flex; flex-direction: column;
    padding: 24px 0; position: fixed; left: 0; top: 0; bottom: 0; z-index: 100;
  }
  .logo { padding: 0 24px 20px; border-bottom: 1px solid var(--border); margin-bottom: 12px; }
  .logo h1 { font-size: 20px; font-weight: 700; color: var(--accent); }
  .logo span { font-size: 12px; color: var(--muted); font-family: 'IBM Plex Mono', monospace; }
  .sidebar-btn {
    margin: 3px 12px; padding: 10px 16px; border-radius: 8px; border: none;
    background: transparent; color: var(--text); font-family: 'Noto Sans KR', sans-serif;
    font-size: 14px; cursor: pointer; text-align: left; transition: all 0.15s;
    display: flex; align-items: center; gap: 10px;
  }
  .sidebar-btn:hover { background: var(--surface2); }
  .sidebar-btn.active { background: var(--accent); color: #fff; }
  .sidebar-stats { margin-top: auto; padding: 16px 24px; border-top: 1px solid var(--border); font-size: 12px; color: var(--muted); font-family: 'IBM Plex Mono', monospace; }
  .stat-row { display: flex; justify-content: space-between; margin: 4px 0; }
  .stat-row span:last-child { color: var(--accent); }

  .main { margin-left: 260px; flex: 1; display: flex; flex-direction: column; min-height: 100vh; }
  .topbar { padding: 14px 28px; border-bottom: 1px solid var(--border); background: var(--surface); display: flex; align-items: center; gap: 12px; position: sticky; top: 0; z-index: 50; }
  .search-wrap { position: relative; flex: 1; }
  .search-wrap input { width: 100%; padding: 9px 14px 9px 38px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px; font-family: 'Noto Sans KR', sans-serif; outline: none; transition: border-color 0.2s; }
  .search-wrap input:focus { border-color: var(--accent); }
  .search-icon { position: absolute; left: 11px; top: 50%; transform: translateY(-50%); color: var(--muted); font-size: 15px; }
  .view-toggle { display: flex; gap: 3px; }
  .toggle-btn { padding: 7px 11px; border-radius: 6px; border: 1px solid var(--border); background: transparent; color: var(--muted); cursor: pointer; font-size: 15px; transition: all 0.15s; }
  .toggle-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }
  .btn { padding: 9px 18px; border-radius: 8px; border: none; cursor: pointer; font-family: 'Noto Sans KR', sans-serif; font-size: 14px; font-weight: 500; transition: all 0.15s; display: inline-flex; align-items: center; gap: 6px; white-space: nowrap; }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-primary:hover { background: #3d6bef; }
  .btn-outline { background: transparent; color: var(--text); border: 1px solid var(--border); }
  .btn-outline:hover { background: var(--surface2); }
  .btn-danger { background: var(--danger); color: #fff; }
  .btn-sm { padding: 5px 11px; font-size: 12px; }
  .btn-xs { padding: 3px 8px; font-size: 11px; border-radius: 5px; }

  .content { padding: 24px 28px; flex: 1; }
  .section-title { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
  .section-sub { font-size: 13px; color: var(--muted); margin-bottom: 14px; }
  .filter-bar { display: flex; gap: 6px; margin-bottom: 18px; flex-wrap: wrap; }
  .filter-chip { padding: 5px 13px; border-radius: 20px; border: 1px solid var(--border); background: transparent; color: var(--muted); font-size: 12px; cursor: pointer; font-family: 'Noto Sans KR', sans-serif; transition: all 0.15s; }
  .filter-chip:hover { border-color: var(--accent); color: var(--text); }
  .filter-chip.active { background: var(--accent); border-color: var(--accent); color: #fff; }

  /* Company Group */
  .company-group { background: #12151f; border: 1px solid var(--border); border-radius: 14px; margin-bottom: 18px; overflow: hidden; }
  .company-header { padding: 14px 18px; display: flex; align-items: center; gap: 12px; cursor: pointer; user-select: none; background: var(--surface); border-bottom: 1px solid var(--border); transition: background 0.15s; }
  .company-header:hover { background: var(--surface2); }
  .company-logo { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 17px; font-weight: 700; color: #fff; flex-shrink: 0; }
  .company-info { flex: 1; min-width: 0; }
  .company-name { font-size: 15px; font-weight: 700; }
  .company-meta { font-size: 11px; color: var(--muted); margin-top: 3px; display: flex; gap: 12px; flex-wrap: wrap; }
  .company-badges { display: flex; gap: 5px; flex-wrap: wrap; }
  .company-toggle { color: var(--muted); font-size: 13px; transition: transform 0.2s; flex-shrink: 0; margin-left: 8px; }
  .company-group.collapsed .company-toggle { transform: rotate(-90deg); }
  .company-body { }
  .company-group.collapsed .company-body { display: none; }

  /* Shared bar */
  .shared-bar { padding: 8px 18px; background: rgba(79,124,255,0.06); border-bottom: 1px solid var(--border); display: flex; gap: 16px; flex-wrap: wrap; font-size: 12px; color: var(--muted); align-items: center; }
  .shared-tag { font-family: 'IBM Plex Mono', monospace; font-size: 10px; background: rgba(79,124,255,0.15); color: var(--accent); padding: 1px 6px; border-radius: 4px; }
  .shared-edit-btn { margin-left: auto; background: none; border: 1px solid var(--border); color: var(--muted); border-radius: 5px; padding: 2px 8px; font-size: 11px; cursor: pointer; font-family: 'Noto Sans KR', sans-serif; transition: all 0.15s; }
  .shared-edit-btn:hover { color: var(--text); border-color: var(--accent); }

  /* Members row */
  .members-row { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px; padding: 14px 18px; border-bottom: 1px solid var(--border); }
  .person-card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 12px; cursor: pointer; transition: all 0.15s; position: relative; }
  .person-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; background: var(--accent); border-radius: 10px 0 0 10px; }
  .person-card:hover { border-color: var(--accent); transform: translateY(-1px); box-shadow: 0 4px 14px rgba(79,124,255,0.12); }
  .person-head { display: flex; align-items: center; gap: 9px; margin-bottom: 8px; }
  .avatar { width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 700; color: #fff; flex-shrink: 0; }
  .person-name { font-size: 14px; font-weight: 600; }
  .person-dept { font-size: 11px; color: var(--muted); margin-top: 1px; }
  .person-contacts { font-size: 12px; color: var(--muted); line-height: 1.8; }
  .person-contacts span { display: block; }
  .person-badges { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 7px; }
  .add-card { background: transparent; border: 1px dashed var(--border); border-radius: 10px; padding: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 7px; color: var(--muted); font-size: 12px; transition: all 0.15s; font-family: 'Noto Sans KR', sans-serif; }
  .add-card:hover { border-color: var(--accent); color: var(--accent); }

  /* Activity badge */
  .activity-badge { font-size: 10px; padding: 1px 7px; border-radius: 10px; font-family: 'IBM Plex Mono', monospace; }
  .badge-order { background: rgba(67,233,123,0.15); color: var(--accent3); }
  .badge-quote { background: rgba(247,151,30,0.15); color: var(--accent4); }
  .badge-visit { background: rgba(255,107,107,0.15); color: var(--accent2); }
  .badge-call { background: rgba(79,124,255,0.15); color: var(--accent); }
  .badge-other { background: rgba(121,134,203,0.15); color: var(--muted); }

  /* Company Timeline */
  .co-timeline-section { padding: 14px 18px; }
  .co-timeline-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
  .co-timeline-label { font-size: 11px; font-family: 'IBM Plex Mono', monospace; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
  .timeline { position: relative; }
  .timeline::before { content: ''; position: absolute; left: 14px; top: 6px; bottom: 6px; width: 1px; background: var(--border); }
  .timeline-item { display: flex; gap: 12px; margin-bottom: 12px; }
  .timeline-dot { width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 12px; position: relative; z-index: 1; }
  .dot-order { background: rgba(67,233,123,0.15); color: var(--accent3); border: 1px solid var(--accent3); }
  .dot-quote { background: rgba(247,151,30,0.15); color: var(--accent4); border: 1px solid var(--accent4); }
  .dot-visit { background: rgba(255,107,107,0.15); color: var(--accent2); border: 1px solid var(--accent2); }
  .dot-call { background: rgba(79,124,255,0.15); color: var(--accent); border: 1px solid var(--accent); }
  .dot-other { background: rgba(121,134,203,0.15); color: var(--muted); border: 1px solid var(--muted); }
  .tl-body { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 9px 12px; flex: 1; }
  .tl-meta { display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px; }
  .tl-type { font-size: 12px; font-weight: 600; }
  .tl-date { font-size: 11px; color: var(--muted); font-family: 'IBM Plex Mono', monospace; }
  .tl-who { font-size: 11px; color: var(--accent); margin-bottom: 3px; cursor: pointer; }
  .tl-who:hover { text-decoration: underline; }
  .tl-text { font-size: 12px; color: var(--muted); line-height: 1.6; }
  .tl-amount { font-size: 11px; color: var(--accent3); font-family: 'IBM Plex Mono', monospace; margin-top: 2px; }
  .show-more-btn { width: 100%; padding: 7px; background: none; border: 1px dashed var(--border); border-radius: 6px; color: var(--muted); font-size: 12px; cursor: pointer; font-family: 'Noto Sans KR', sans-serif; margin-top: 4px; transition: all 0.15s; }
  .show-more-btn:hover { border-color: var(--accent); color: var(--accent); }

  /* Ungrouped */
  .ungrouped-label { font-size: 12px; color: var(--muted); font-family: 'IBM Plex Mono', monospace; margin-bottom: 10px; }
  .ungrouped-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px; }

  /* Modal */
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.72); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
  .modal-overlay.open { display: flex; }
  .modal { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; width: 640px; max-width: 95vw; max-height: 92vh; overflow-y: auto; padding: 26px; position: relative; }
  .modal-title { font-size: 17px; font-weight: 700; margin-bottom: 20px; }
  .modal-close { position: absolute; top: 13px; right: 13px; background: var(--surface2); border: none; color: var(--text); width: 28px; height: 28px; border-radius: 6px; cursor: pointer; font-size: 15px; display: flex; align-items: center; justify-content: center; }
  .modal-close:hover { background: var(--danger); }
  .form-section { margin-bottom: 18px; }
  .form-section-title { font-size: 10px; font-family: 'IBM Plex Mono', monospace; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 9px; padding-bottom: 7px; border-bottom: 1px solid var(--border); }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
  .form-row.three { grid-template-columns: 1fr 1fr 1fr; }
  .form-row.single { grid-template-columns: 1fr; }
  .form-group { display: flex; flex-direction: column; gap: 5px; }
  .form-group label { font-size: 11px; color: var(--muted); }
  .form-group input, .form-group textarea, .form-group select { padding: 8px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 7px; color: var(--text); font-size: 13px; font-family: 'Noto Sans KR', sans-serif; outline: none; transition: border-color 0.2s; width: 100%; }
  .form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color: var(--accent); }
  .form-group select option { background: var(--surface); }
  .form-group textarea { resize: vertical; min-height: 68px; }
  .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 18px; }

  /* Detail view */
  .detail-view { display: none; padding: 24px 28px; }
  .detail-view.open { display: block; }
  .detail-header { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 22px; margin-bottom: 16px; display: flex; align-items: center; gap: 18px; flex-wrap: wrap; }
  .detail-avatar { width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 700; color: #fff; flex-shrink: 0; }
  .detail-name { font-size: 20px; font-weight: 700; }
  .detail-sub { font-size: 13px; color: var(--muted); margin-top: 3px; }
  .detail-actions { margin-left: auto; display: flex; gap: 7px; flex-wrap: wrap; }
  .info-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; margin-bottom: 16px; }
  .info-card { background: var(--surface); border: 1px solid var(--border); border-radius: 9px; padding: 12px; }
  .info-card-label { font-size: 10px; color: var(--muted); font-family: 'IBM Plex Mono', monospace; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px; }
  .info-card-value { font-size: 13px; }
  .acts-section { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 18px; }
  .acts-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
  .acts-title { font-size: 14px; font-weight: 600; }
  .empty-state { text-align: center; padding: 36px 20px; color: var(--muted); }
  .empty-icon { font-size: 36px; margin-bottom: 10px; }

  /* List view */
  .list-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
  .list-table { width: 100%; border-collapse: collapse; }
  .list-table th { text-align: left; padding: 9px 13px; font-size: 10px; color: var(--muted); font-family: 'IBM Plex Mono', monospace; text-transform: uppercase; border-bottom: 1px solid var(--border); }
  .list-table td { padding: 11px 13px; font-size: 13px; border-bottom: 1px solid var(--border); vertical-align: middle; }
  .list-table tr:last-child td { border-bottom: none; }
  .list-table tbody tr:hover td { background: var(--surface2); cursor: pointer; }
  .co-row td { background: rgba(79,124,255,0.05); font-weight: 600; font-size: 13px; }

  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
</style>
</head>
<body>

<aside class="sidebar">
  <div class="logo">
    <h1>â–¸ CRM</h1>
    <span>ê³ ê°ê´€ë¦¬ ì‹œìŠ¤í…œ</span>
  </div>
  <button class="sidebar-btn active" id="navContacts" onclick="nav('contacts')"><span>ğŸ¢</span> ì—°ë½ì²˜</button>
  <button class="sidebar-btn" id="navActivities" onclick="nav('activities')"><span>ğŸ“‹</span> ì „ì²´ ì•¡í‹°ë¹„í‹°</button>
  <div class="sidebar-stats" id="sidebarStats"></div>
</aside>

<main class="main">
  <div class="topbar">
    <div class="search-wrap">
      <span class="search-icon">ğŸ”</span>
      <input type="text" id="searchInput" placeholder="ì´ë¦„, íšŒì‚¬, ì´ë©”ì¼ ê²€ìƒ‰..." oninput="renderContacts()">
    </div>
    <div class="view-toggle">
      <button class="toggle-btn active" id="vBtn-group" title="íšŒì‚¬ë³„ ê·¸ë£¹" onclick="setViewMode('group')">âŠ</button>
      <button class="toggle-btn" id="vBtn-list" title="ëª©ë¡" onclick="setViewMode('list')">â˜°</button>
    </div>
    <button class="btn btn-primary" onclick="openAddContact(null)">ï¼‹ ì—°ë½ì²˜</button>
  </div>

  <!-- Contacts View -->
  <div class="content" id="contactsView">
    <div class="section-title">ì—°ë½ì²˜</div>
    <div class="section-sub" id="viewSub"></div>
    <div class="filter-bar">
      <button class="filter-chip active" onclick="setFilter('all',this)">ì „ì²´</button>
      <button class="filter-chip" onclick="setFilter('order',this)">ğŸ“¦ ë°œì£¼</button>
      <button class="filter-chip" onclick="setFilter('quote',this)">ğŸ“„ ê²¬ì </button>
      <button class="filter-chip" onclick="setFilter('visit',this)">ğŸ¤ ë°©ë¬¸</button>
      <button class="filter-chip" onclick="setFilter('call',this)">ğŸ“ í†µí™”</button>
      <button class="filter-chip" onclick="setFilter('other',this)">ğŸ“Œ ê¸°íƒ€</button>
    </div>
    <div id="mainGrid"></div>
  </div>

  <!-- Detail View -->
  <div id="detailView" class="detail-view">
    <div style="display:flex;gap:8px;margin-bottom:14px">
      <button class="btn btn-outline btn-sm" onclick="backToList()">â† ëª©ë¡ìœ¼ë¡œ</button>
      <button class="btn btn-outline btn-sm" id="detailCoBtn" style="display:none">ğŸ¢ íšŒì‚¬ ë³´ê¸°</button>
    </div>
    <div id="detailContent"></div>
  </div>

  <!-- Activities View -->
  <div class="content" id="activitiesView" style="display:none">
    <div class="section-title">ì „ì²´ ì•¡í‹°ë¹„í‹°</div>
    <div class="section-sub">ëª¨ë“  í™œë™ ë‚´ì—­ (ìµœì‹ ìˆœ)</div>
    <div id="allActsContent"></div>
  </div>
</main>

<!-- Contact Modal -->
<div class="modal-overlay" id="contactModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('contactModal')">âœ•</button>
    <div class="modal-title" id="cModalTitle">ìƒˆ ì—°ë½ì²˜</div>
    <div class="form-section">
      <div class="form-section-title">ì†Œì† íšŒì‚¬</div>
      <div class="form-row single">
        <div class="form-group">
          <label>íšŒì‚¬ëª… (ê°™ì€ íšŒì‚¬ ì§ì›ì€ ë™ì¼ ì´ë¦„ ì…ë ¥)</label>
          <input type="text" id="f_company" placeholder="(ì£¼)ì˜ˆì‹œê¸°ì—…" list="coSuggestions" oninput="onCompanyInput()">
          <datalist id="coSuggestions"></datalist>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>ë¶€ì„œ</label><input type="text" id="f_dept" placeholder="ì˜ì—…íŒ€"></div>
        <div class="form-group"><label>ì§ì±…</label><input type="text" id="f_position" placeholder="ê³¼ì¥"></div>
      </div>
    </div>
    <div class="form-section">
      <div class="form-section-title">ê°œì¸ ì •ë³´</div>
      <div class="form-row">
        <div class="form-group"><label>ì„± *</label><input type="text" id="f_last" placeholder="ê¹€"></div>
        <div class="form-group"><label>ì´ë¦„ *</label><input type="text" id="f_first" placeholder="ì² ìˆ˜"></div>
      </div>
      <div class="form-row single">
        <div class="form-group"><label>ì´ë©”ì¼</label><input type="email" id="f_email" placeholder="example@email.com"></div>
      </div>
    </div>
    <div class="form-section">
      <div class="form-section-title">ê°œì¸ ì—°ë½ì²˜</div>
      <div class="form-row three">
        <div class="form-group"><label>ì‚¬ë¬´ì‹¤</label><input type="tel" id="f_office" placeholder="02-0000-0000"></div>
        <div class="form-group"><label>íœ´ëŒ€í°</label><input type="tel" id="f_mobile" placeholder="010-0000-0000"></div>
        <div class="form-group"><label>ì¶”ê°€</label><input type="tel" id="f_extra" placeholder="íŒ©ìŠ¤ ë“±"></div>
      </div>
    </div>
    <div class="form-section">
      <div class="form-section-title">ì£¼ì†Œ (íšŒì‚¬ ê³µìœ )</div>
      <div id="addrNotice" style="font-size:11px;color:var(--accent);margin-bottom:7px;display:none">â„¹ ë“±ë¡ëœ íšŒì‚¬ ì£¼ì†Œê°€ ì ìš©ë©ë‹ˆë‹¤. ë³€ê²½í•˜ë©´ íšŒì‚¬ ì „ì²´ì— ë°˜ì˜ë©ë‹ˆë‹¤.</div>
      <div class="form-row single">
        <div class="form-group"><label>ì£¼ì†Œ</label><input type="text" id="f_address" placeholder="ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123"></div>
      </div>
    </div>
    <div class="form-section">
      <div class="form-section-title">ë©”ëª¨</div>
      <div class="form-row single">
        <div class="form-group"><textarea id="f_memo" placeholder="íŠ¹ì´ì‚¬í•­, ê´€ê³„ ë“±"></textarea></div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal('contactModal')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="saveContact()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- Company Modal -->
<div class="modal-overlay" id="companyModal">
  <div class="modal" style="width:480px">
    <button class="modal-close" onclick="closeModal('companyModal')">âœ•</button>
    <div class="modal-title" id="coModalTitle">íšŒì‚¬ ê³µí†µ ì •ë³´</div>
    <div class="form-section">
      <div class="form-section-title">ëŒ€í‘œ ì—°ë½ì²˜</div>
      <div class="form-row">
        <div class="form-group"><label>ëŒ€í‘œ ì „í™”</label><input type="tel" id="co_phone" placeholder="02-0000-0000"></div>
        <div class="form-group"><label>íŒ©ìŠ¤</label><input type="tel" id="co_fax" placeholder="02-0000-0001"></div>
      </div>
    </div>
    <div class="form-section">
      <div class="form-section-title">ì£¼ì†Œ</div>
      <div class="form-row single">
        <div class="form-group"><label>ì£¼ì†Œ</label><input type="text" id="co_address" placeholder="ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123"></div>
      </div>
    </div>
    <div class="form-section">
      <div class="form-section-title">ë©”ëª¨</div>
      <div class="form-row single">
        <div class="form-group"><textarea id="co_memo" placeholder="íšŒì‚¬ ê´€ë ¨ ë©”ëª¨"></textarea></div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal('companyModal')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="saveCompany()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- Activity Modal -->
<div class="modal-overlay" id="activityModal">
  <div class="modal" style="width:480px">
    <button class="modal-close" onclick="closeModal('activityModal')">âœ•</button>
    <div class="modal-title">ì•¡í‹°ë¹„í‹° ì¶”ê°€</div>
    <div class="form-section">
      <div class="form-section-title">ë‹´ë‹¹ì</div>
      <div id="actWho" style="font-size:14px;font-weight:600;color:var(--accent);padding:4px 0"></div>
    </div>
    <div class="form-row single">
      <div class="form-group"><label>ìœ í˜• *</label>
        <select id="a_type">
          <option value="order">ğŸ“¦ ë°œì£¼</option>
          <option value="quote">ğŸ“„ ê²¬ì </option>
          <option value="visit">ğŸ¤ ë°©ë¬¸</option>
          <option value="call">ğŸ“ í†µí™”</option>
          <option value="other">ğŸ“Œ ê¸°íƒ€</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>ë‚ ì§œ *</label><input type="date" id="a_date"></div>
      <div class="form-group"><label>ê¸ˆì•¡</label><input type="text" id="a_amount" placeholder="â‚©"></div>
    </div>
    <div class="form-row single">
      <div class="form-group"><label>ì œëª©</label><input type="text" id="a_title" placeholder="ê°„ë‹¨í•œ ì œëª©"></div>
    </div>
    <div class="form-row single">
      <div class="form-group"><label>ë‚´ìš©</label><textarea id="a_content" placeholder="ìƒì„¸ ë‚´ìš©"></textarea></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal('activityModal')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="saveActivity()">ì €ì¥</button>
    </div>
  </div>
</div>

<script>
// â”€â”€ DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let contacts  = JSON.parse(localStorage.getItem('crm_contacts')  || '[]');
let activities= JSON.parse(localStorage.getItem('crm_activities')|| '[]');
let companies = JSON.parse(localStorage.getItem('crm_companies') || '{}');

let editCid = null;       // editing contact id
let editCoName = null;    // editing company name
let actCid = null;        // activity target contact id
let currentCid = null;    // currently viewed contact
let curFilter = 'all';
let viewMode = 'group';
let expanded = new Set();

const TL  = {order:'ë°œì£¼',quote:'ê²¬ì ',visit:'ë°©ë¬¸',call:'í†µí™”',other:'ê¸°íƒ€'};
const TE  = {order:'ğŸ“¦',quote:'ğŸ“„',visit:'ğŸ¤',call:'ğŸ“',other:'ğŸ“Œ'};
const TB  = {order:'badge-order',quote:'badge-quote',visit:'badge-visit',call:'badge-call',other:'badge-other'};
const TD  = {order:'dot-order',quote:'dot-quote',visit:'dot-visit',call:'dot-call',other:'dot-other'};

function persist() {
  localStorage.setItem('crm_contacts',  JSON.stringify(contacts));
  localStorage.setItem('crm_activities',JSON.stringify(activities));
  localStorage.setItem('crm_companies', JSON.stringify(companies));
  renderStats();
}
function uid() { return Date.now().toString(36)+Math.random().toString(36).slice(2); }
function esc(s){ return (s||'').replace(/\\/g,'\\\\').replace(/'/g,"\\'"); }
function ac(s){ // avatar color
  const c=['#4f7cff','#ff6b6b','#43e97b','#f7971e','#a855f7','#06b6d4','#f43f5e','#84cc16'];
  let h=0; for(let ch of (s||''))h=(h*31+ch.charCodeAt(0))%c.length; return c[h];
}
function fmtMoney(s){ return Number((s||'').toString().replace(/[^0-9]/g,'')||0).toLocaleString(); }

// â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function nav(p){
  document.getElementById('contactsView').style.display   = p==='contacts' ? '' : 'none';
  document.getElementById('activitiesView').style.display = p==='activities' ? '' : 'none';
  document.getElementById('detailView').classList.remove('open');
  document.getElementById('navContacts').classList.toggle('active', p==='contacts');
  document.getElementById('navActivities').classList.toggle('active', p==='activities');
  currentCid = null;
  if(p==='contacts')   renderContacts();
  if(p==='activities') renderAllActs();
}
function backToList(){
  document.getElementById('detailView').classList.remove('open');
  document.getElementById('contactsView').style.display='';
  currentCid=null; renderContacts();
}
function setViewMode(m){
  viewMode=m;
  document.querySelectorAll('.toggle-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('vBtn-'+m).classList.add('active');
  renderContacts();
}
function setFilter(f,btn){
  curFilter=f;
  document.querySelectorAll('.filter-chip').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active'); renderContacts();
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function coActivities(coName){
  const ids = contacts.filter(c=>(c.company||'').trim()===coName).map(c=>c.id);
  return activities.filter(a=>ids.includes(a.contactId)).sort((a,b)=>b.date.localeCompare(a.date));
}
function contactActivities(cid){ return activities.filter(a=>a.contactId===cid).sort((a,b)=>b.date.localeCompare(a.date)); }

// â”€â”€ RENDER CONTACTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderContacts(){
  const q = document.getElementById('searchInput').value.toLowerCase();
  let list = contacts.filter(c=>{
    const s=(c.company+c.last+c.first+c.email+c.mobile+c.office).toLowerCase();
    return s.includes(q);
  });
  if(curFilter!=='all') list = list.filter(c=>activities.some(a=>a.contactId===c.id&&a.type===curFilter));
  document.getElementById('viewSub').textContent = `ì´ ${list.length}ëª…`;
  if(viewMode==='list'){ renderListView(list); return; }
  renderGroupView(list);
}

function renderGroupView(list){
  const groups={};
  for(const c of list){ const k=(c.company||'').trim()||'__none__'; (groups[k]=groups[k]||[]).push(c); }
  const named = Object.keys(groups).filter(k=>k!=='__none__').sort();
  const none  = groups['__none__']||[];
  let html='';

  for(const co of named){
    const members = groups[co];
    const ci = companies[co]||{};
    const coActs = coActivities(co);
    const types = [...new Set(coActs.map(a=>a.type))];
    const isExp = expanded.has(co);
    const col = ac(co);
    const preview = coActs.slice(0,5);

    html+=`
    <div class="company-group${isExp?'':' collapsed'}" id="cg-${CSS.escape(co)}">
      <div class="company-header" onclick="toggleCo('${esc(co)}')">
        <div class="company-logo" style="background:linear-gradient(135deg,${col},${col}bb)">${co[0]}</div>
        <div class="company-info">
          <div class="company-name">${co}</div>
          <div class="company-meta">
            <span>ğŸ‘¤ ${members.length}ëª…</span>
            ${ci.phone?`<span>â˜ ${ci.phone}</span>`:''}
            ${coActs.length?`<span>ğŸ“‹ ${coActs.length}ê±´</span>`:''}
          </div>
        </div>
        <div class="company-badges">${types.map(t=>`<span class="activity-badge ${TB[t]}">${TE[t]} ${coActs.filter(a=>a.type===t).length}</span>`).join('')}</div>
        <span class="company-toggle">â–¾</span>
      </div>
      <div class="company-body">
        <!-- shared bar -->
        <div class="shared-bar">
          <span class="shared-tag">ê³µí†µ</span>
          ${ci.phone?`<span>â˜ ${ci.phone}</span>`:'<span style="opacity:.4">ëŒ€í‘œì „í™” ì—†ìŒ</span>'}
          ${ci.fax?`<span>ğŸ“  ${ci.fax}</span>`:''}
          ${ci.address?`<span>ğŸ“ ${ci.address}</span>`:'<span style="opacity:.4">ì£¼ì†Œ ì—†ìŒ</span>'}
          <button class="shared-edit-btn" onclick="openCompanyModal('${esc(co)}')">âœ ìˆ˜ì •</button>
        </div>
        <!-- members -->
        <div class="members-row">
          ${members.map(c=>personCard(c)).join('')}
          <button class="add-card" onclick="openAddContact('${esc(co)}')">ï¼‹ ë‹´ë‹¹ì ì¶”ê°€</button>
        </div>
        <!-- timeline -->
        <div class="co-timeline-section">
          <div class="co-timeline-head">
            <span class="co-timeline-label">ğŸ“‹ íšŒì‚¬ ì „ì²´ ì•¡í‹°ë¹„í‹° (${coActs.length}ê±´)</span>
            <button class="btn btn-primary btn-xs" onclick="openActModal_co('${esc(co)}')">ï¼‹ ì¶”ê°€</button>
          </div>
          ${coActs.length===0
            ? `<div style="font-size:12px;color:var(--muted);text-align:center;padding:12px">ì•¡í‹°ë¹„í‹° ì—†ìŒ</div>`
            : `<div class="timeline" id="tl-${CSS.escape(co)}">
                ${preview.map(a=>tlItem(a,co)).join('')}
               </div>
               ${coActs.length>5?`<button class="show-more-btn" onclick="showAll('${esc(co)}')">+ ${coActs.length-5}ê±´ ë” ë³´ê¸°</button>`:''}`
          }
        </div>
      </div>
    </div>`;
  }

  if(none.length){
    html+=`<div style="margin-top:16px">
      <div class="ungrouped-label">â”€â”€ íšŒì‚¬ ë¯¸ì§€ì • (${none.length}ëª…)</div>
      <div class="ungrouped-grid">${none.map(c=>personCard(c,true)).join('')}</div>
    </div>`;
  }

  if(!named.length&&!none.length) html=`<div class="empty-state"><div class="empty-icon">ğŸ‘¥</div><p>ì—°ë½ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>`;
  document.getElementById('mainGrid').innerHTML=html;
}

function personCard(c, standalone=false){
  const acts=activities.filter(a=>a.contactId===c.id);
  const types=[...new Set(acts.map(a=>a.type))];
  const init=(c.last||c.first||'?')[0];
  const bg=ac(c.last+c.first);
  return `<div class="person-card" onclick="showDetail('${c.id}')">
    <div class="person-head">
      <div class="avatar" style="background:${bg}">${init}</div>
      <div><div class="person-name">${c.last}${c.first}</div><div class="person-dept">${[c.dept,c.position].filter(Boolean).join(' / ')||'â€”'}</div></div>
    </div>
    <div class="person-contacts">
      ${c.email?`<span>âœ‰ ${c.email}</span>`:''}
      ${c.mobile?`<span>ğŸ“± ${c.mobile}</span>`:''}
      ${c.office?`<span>â˜ ${c.office}</span>`:''}
    </div>
    ${types.length?`<div class="person-badges">${types.map(t=>`<span class="activity-badge ${TB[t]}">${TE[t]} ${acts.filter(a=>a.type===t).length}</span>`).join('')}</div>`:''}
  </div>`;
}

function tlItem(a, co){
  const c=contacts.find(x=>x.id===a.contactId);
  const who=c?c.last+c.first:'?';
  return `<div class="timeline-item">
    <div class="timeline-dot ${TD[a.type]}">${TE[a.type]}</div>
    <div class="tl-body">
      <div class="tl-meta">
        <span class="tl-type">${TL[a.type]}${a.title?' Â· '+a.title:''}</span>
        <div style="display:flex;gap:5px;align-items:center">
          <span class="tl-date">${a.date}</span>
          <button onclick="delAct('${a.id}')" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:10px">âœ•</button>
        </div>
      </div>
      <div class="tl-who" onclick="showDetail('${a.contactId}')">ğŸ‘¤ ${who}</div>
      ${a.content?`<div class="tl-text">${a.content}</div>`:''}
      ${a.amount?`<div class="tl-amount">â‚© ${fmtMoney(a.amount)}</div>`:''}
    </div>
  </div>`;
}

function showAll(co){
  const all=coActivities(co);
  const tl=document.getElementById('tl-'+CSS.escape(co));
  if(tl){ tl.innerHTML=all.map(a=>tlItem(a,co)).join(''); }
  const btn=tl?.nextElementSibling;
  if(btn?.classList.contains('show-more-btn')) btn.remove();
}

function toggleCo(co){
  const el=document.getElementById('cg-'+CSS.escape(co));
  if(!el) return;
  if(el.classList.contains('collapsed')){ el.classList.remove('collapsed'); expanded.add(co); }
  else { el.classList.add('collapsed'); expanded.delete(co); }
}

// â”€â”€ LIST VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderListView(list){
  const groups={};
  for(const c of list){ const k=(c.company||'').trim()||'__none__'; (groups[k]=groups[k]||[]).push(c); }
  const named=Object.keys(groups).filter(k=>k!=='__none__').sort();
  const none=groups['__none__']||[];
  let rows='';
  for(const co of named){
    const ca=coActivities(co);
    rows+=`<tr class="co-row"><td colspan="5" style="padding-left:13px">ğŸ¢ ${co} <span style="font-size:11px;color:var(--muted);font-weight:400">Â· ${groups[co].length}ëª… Â· ì•¡í‹°ë¹„í‹° ${ca.length}ê±´</span></td></tr>`;
    for(const c of groups[co]){
      const acts=activities.filter(a=>a.contactId===c.id);
      const types=[...new Set(acts.map(a=>a.type))];
      rows+=`<tr onclick="showDetail('${c.id}')">
        <td style="padding-left:26px">${c.last}${c.first}</td>
        <td style="color:var(--muted)">${[c.dept,c.position].filter(Boolean).join('/')}</td>
        <td>${c.mobile||c.office||'â€”'}</td>
        <td>${c.email||'â€”'}</td>
        <td>${types.map(t=>`<span class="activity-badge ${TB[t]}">${TE[t]}${acts.filter(a=>a.type===t).length}</span>`).join(' ')}</td>
      </tr>`;
    }
  }
  for(const c of none){
    const acts=activities.filter(a=>a.contactId===c.id);
    const types=[...new Set(acts.map(a=>a.type))];
    rows+=`<tr onclick="showDetail('${c.id}')">
      <td>${c.last}${c.first}</td>
      <td style="color:var(--muted)">${[c.dept,c.position].filter(Boolean).join('/')}</td>
      <td>${c.mobile||c.office||'â€”'}</td>
      <td>${c.email||'â€”'}</td>
      <td>${types.map(t=>`<span class="activity-badge ${TB[t]}">${TE[t]}${acts.filter(a=>a.type===t).length}</span>`).join(' ')}</td>
    </tr>`;
  }
  document.getElementById('mainGrid').innerHTML=`
    <div class="list-wrap">
      <table class="list-table">
        <thead><tr><th>ì´ë¦„</th><th>ë¶€ì„œ/ì§ì±…</th><th>ì—°ë½ì²˜</th><th>ì´ë©”ì¼</th><th>ì•¡í‹°ë¹„í‹°</th></tr></thead>
        <tbody>${rows||'<tr><td colspan="5" style="text-align:center;color:var(--muted);padding:32px">ì—°ë½ì²˜ ì—†ìŒ</td></tr>'}</tbody>
      </table>
    </div>`;
}

// â”€â”€ DETAIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showDetail(id){
  currentCid=id;
  const c=contacts.find(x=>x.id===id);
  if(!c) return;
  const acts=contactActivities(id);
  const bg=ac(c.last+c.first);
  const init=(c.last||c.first||'?')[0];
  const ci=c.company?(companies[c.company]||{}):{};

  const info=[
    {l:'ì´ë©”ì¼',v:c.email||'â€”'},{l:'íœ´ëŒ€í°',v:c.mobile||'â€”'},
    {l:'ì‚¬ë¬´ì‹¤',v:c.office||'â€”'},{l:'ì¶”ê°€ ì—°ë½ì²˜',v:c.extra||'â€”'},
    {l:'ì£¼ì†Œ',v:ci.address||c.address||'â€”'},{l:'ë©”ëª¨',v:c.memo||'â€”'},
  ];

  document.getElementById('detailContent').innerHTML=`
    <div class="detail-header">
      <div class="detail-avatar" style="background:${bg}">${init}</div>
      <div>
        <div class="detail-name">${c.last}${c.first}</div>
        <div class="detail-sub">${c.company||''}${c.dept?' Â· '+c.dept:''}${c.position?' / '+c.position:''}</div>
      </div>
      <div class="detail-actions">
        <button class="btn btn-outline btn-sm" onclick="openEditContact('${id}')">âœ ìˆ˜ì •</button>
        <button class="btn btn-primary btn-sm" onclick="openActModal_contact('${id}')">ï¼‹ ì•¡í‹°ë¹„í‹°</button>
        <button class="btn btn-danger btn-sm" onclick="delContact('${id}')">ğŸ—‘</button>
      </div>
    </div>
    <div class="info-grid">
      ${info.map(i=>`<div class="info-card"><div class="info-card-label">${i.l}</div><div class="info-card-value">${i.v}</div></div>`).join('')}
    </div>
    <div class="acts-section">
      <div class="acts-head"><span class="acts-title">ì•¡í‹°ë¹„í‹° (${acts.length})</span>
        <button class="btn btn-primary btn-sm" onclick="openActModal_contact('${id}')">ï¼‹ ì¶”ê°€</button>
      </div>
      ${acts.length===0?`<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><p>ì•„ì§ ì•¡í‹°ë¹„í‹°ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>`
        :`<div class="timeline">${acts.map(a=>`
          <div class="timeline-item">
            <div class="timeline-dot ${TD[a.type]}">${TE[a.type]}</div>
            <div class="tl-body">
              <div class="tl-meta">
                <span class="tl-type">${TL[a.type]}${a.title?' Â· '+a.title:''}</span>
                <div style="display:flex;gap:5px;align-items:center">
                  <span class="tl-date">${a.date}</span>
                  <button onclick="delAct('${a.id}',true)" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:10px">âœ•</button>
                </div>
              </div>
              ${a.content?`<div class="tl-text">${a.content}</div>`:''}
              ${a.amount?`<div class="tl-amount">â‚© ${fmtMoney(a.amount)}</div>`:''}
            </div>
          </div>`).join('')}
        </div>`}
    </div>`;

  // Company back button
  const coBtn=document.getElementById('detailCoBtn');
  if(c.company){
    coBtn.style.display='';
    coBtn.onclick=()=>{
      backToList();
      setTimeout(()=>{
        expanded.add(c.company);
        const el=document.getElementById('cg-'+CSS.escape(c.company));
        if(el){ el.classList.remove('collapsed'); el.scrollIntoView({behavior:'smooth',block:'start'}); }
      },80);
    };
  } else coBtn.style.display='none';

  document.getElementById('contactsView').style.display='none';
  document.getElementById('detailView').classList.add('open');
}

// â”€â”€ ALL ACTIVITIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAllActs(){
  const acts=[...activities].sort((a,b)=>b.date.localeCompare(a.date));
  const div=document.getElementById('allActsContent');
  if(!acts.length){ div.innerHTML=`<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><p>ì•¡í‹°ë¹„í‹°ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>`; return; }
  div.innerHTML=`<div class="timeline">${acts.map(a=>{
    const c=contacts.find(x=>x.id===a.contactId);
    return `<div class="timeline-item">
      <div class="timeline-dot ${TD[a.type]}">${TE[a.type]}</div>
      <div class="tl-body" style="cursor:pointer" onclick="${c?`showDetail('${c.id}')`:''}">
        <div class="tl-meta">
          <span class="tl-type">${TL[a.type]}${a.title?' Â· '+a.title:''}</span>
          <span class="tl-date">${a.date}</span>
        </div>
        <div class="tl-who">${c?c.last+c.first:'?'} ${c&&c.company?'Â· '+c.company:''}</div>
        ${a.content?`<div class="tl-text">${a.content}</div>`:''}
        ${a.amount?`<div class="tl-amount">â‚© ${fmtMoney(a.amount)}</div>`:''}
      </div>
    </div>`;
  }).join('')}</div>`;
}

// â”€â”€ CONTACT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function refreshCoSuggestions(){
  const dl=document.getElementById('coSuggestions');
  dl.innerHTML=[...new Set(contacts.map(c=>c.company).filter(Boolean))].map(n=>`<option value="${n}">`).join('');
}
function onCompanyInput(){
  const co=document.getElementById('f_company').value.trim();
  const ci=companies[co];
  const notice=document.getElementById('addrNotice');
  const addrInput=document.getElementById('f_address');
  if(co&&ci&&ci.address){ notice.style.display=''; addrInput.value=ci.address; addrInput.style.borderColor='var(--accent)'; }
  else { notice.style.display='none'; addrInput.style.borderColor=''; }
}

function openAddContact(preCo){
  editCid=null;
  document.getElementById('cModalTitle').textContent='ìƒˆ ì—°ë½ì²˜';
  ['f_dept','f_position','f_last','f_first','f_email','f_office','f_mobile','f_extra','f_address','f_memo']
    .forEach(id=>document.getElementById(id).value='');
  document.getElementById('f_company').value=preCo||'';
  document.getElementById('addrNotice').style.display='none';
  refreshCoSuggestions();
  if(preCo) onCompanyInput();
  document.getElementById('contactModal').classList.add('open');
}
function openEditContact(id){
  editCid=id;
  const c=contacts.find(x=>x.id===id);
  document.getElementById('cModalTitle').textContent='ì—°ë½ì²˜ ìˆ˜ì •';
  document.getElementById('f_company').value=c.company||'';
  document.getElementById('f_dept').value=c.dept||'';
  document.getElementById('f_position').value=c.position||'';
  document.getElementById('f_last').value=c.last||'';
  document.getElementById('f_first').value=c.first||'';
  document.getElementById('f_email').value=c.email||'';
  document.getElementById('f_office').value=c.office||'';
  document.getElementById('f_mobile').value=c.mobile||'';
  document.getElementById('f_extra').value=c.extra||'';
  document.getElementById('f_address').value=c.address||'';
  document.getElementById('f_memo').value=c.memo||'';
  document.getElementById('addrNotice').style.display='none';
  refreshCoSuggestions();
  document.getElementById('contactModal').classList.add('open');
}
function saveContact(){
  const last=document.getElementById('f_last').value.trim();
  const first=document.getElementById('f_first').value.trim();
  if(!last&&!first){ alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  const co=document.getElementById('f_company').value.trim();
  const addr=document.getElementById('f_address').value.trim();
  // Sync address to company info
  if(co&&addr){ if(!companies[co]) companies[co]={}; if(!companies[co].address) companies[co].address=addr; }
  const data={company:co, dept:document.getElementById('f_dept').value.trim(),
    position:document.getElementById('f_position').value.trim(), last, first,
    email:document.getElementById('f_email').value.trim(), office:document.getElementById('f_office').value.trim(),
    mobile:document.getElementById('f_mobile').value.trim(), extra:document.getElementById('f_extra').value.trim(),
    address:addr, memo:document.getElementById('f_memo').value.trim()};
  if(editCid){ const i=contacts.findIndex(x=>x.id===editCid); contacts[i]={...contacts[i],...data}; persist(); closeModal('contactModal'); showDetail(editCid); }
  else { contacts.unshift({id:uid(),createdAt:new Date().toISOString(),...data}); persist(); closeModal('contactModal'); renderContacts(); }
}
function delContact(id){
  if(!confirm('ì´ ì—°ë½ì²˜ì™€ ê´€ë ¨ ì•¡í‹°ë¹„í‹°ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
  contacts=contacts.filter(c=>c.id!==id);
  activities=activities.filter(a=>a.contactId!==id);
  persist(); backToList();
}

// â”€â”€ COMPANY MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openCompanyModal(co){
  editCoName=co;
  const ci=companies[co]||{};
  document.getElementById('coModalTitle').textContent=co+' â€” ê³µí†µ ì •ë³´';
  document.getElementById('co_phone').value=ci.phone||'';
  document.getElementById('co_fax').value=ci.fax||'';
  document.getElementById('co_address').value=ci.address||'';
  document.getElementById('co_memo').value=ci.memo||'';
  document.getElementById('companyModal').classList.add('open');
}
function saveCompany(){
  if(!editCoName) return;
  companies[editCoName]={
    phone:document.getElementById('co_phone').value.trim(),
    fax:document.getElementById('co_fax').value.trim(),
    address:document.getElementById('co_address').value.trim(),
    memo:document.getElementById('co_memo').value.trim(),
  };
  persist(); closeModal('companyModal'); renderContacts();
}

// â”€â”€ ACTIVITY MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openActModal_contact(cid){
  actCid=cid;
  const c=contacts.find(x=>x.id===cid);
  document.getElementById('actWho').innerHTML=`${c?c.last+c.first:''} ${c&&c.company?'<span style="font-size:12px;color:var(--muted)">Â· '+c.company+'</span>':''}`;
  _resetActForm();
  document.getElementById('activityModal').classList.add('open');
}
function openActModal_co(co){
  const members=contacts.filter(c=>(c.company||'').trim()===co);
  if(!members.length){ alert('ë¨¼ì € ë‹´ë‹¹ìë¥¼ ì¶”ê°€í•˜ì„¸ìš”.'); return; }
  actCid=members[0].id;
  if(members.length===1){
    openActModal_contact(members[0].id);
  } else {
    document.getElementById('actWho').innerHTML=
      `<select id="actPicker" onchange="actCid=this.value" style="background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:5px 8px;font-family:inherit;font-size:13px;outline:none;width:100%">
        ${members.map(m=>`<option value="${m.id}">${m.last}${m.first} (${m.dept||m.position||''})</option>`).join('')}
      </select>`;
    _resetActForm();
    document.getElementById('activityModal').classList.add('open');
  }
}
function _resetActForm(){
  document.getElementById('a_date').value=new Date().toISOString().slice(0,10);
  document.getElementById('a_type').value='order';
  ['a_title','a_content','a_amount'].forEach(id=>document.getElementById(id).value='');
}
function saveActivity(){
  const picker=document.getElementById('actPicker');
  if(picker) actCid=picker.value;
  if(!actCid){ alert('ë‹´ë‹¹ìë¥¼ ì„ íƒí•˜ì„¸ìš”.'); return; }
  const date=document.getElementById('a_date').value;
  if(!date){ alert('ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  activities.push({id:uid(), contactId:actCid,
    type:document.getElementById('a_type').value, date,
    title:document.getElementById('a_title').value.trim(),
    content:document.getElementById('a_content').value.trim(),
    amount:document.getElementById('a_amount').value.trim(),
    createdAt:new Date().toISOString()});
  persist(); closeModal('activityModal');
  if(currentCid) showDetail(currentCid); else renderContacts();
}
function delAct(id, fromDetail=false){
  if(!confirm('ì´ ì•¡í‹°ë¹„í‹°ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
  activities=activities.filter(a=>a.id!==id);
  persist();
  if(fromDetail&&currentCid) showDetail(currentCid); else renderContacts();
}

// â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function closeModal(id){ document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.modal-overlay').forEach(o=>{ o.addEventListener('click',e=>{ if(e.target===o) o.classList.remove('open'); }); });

function renderStats(){
  const cos=[...new Set(contacts.map(c=>c.company).filter(Boolean))];
  document.getElementById('sidebarStats').innerHTML=`
    <div class="stat-row"><span>íšŒì‚¬</span><span>${cos.length}</span></div>
    <div class="stat-row"><span>ì—°ë½ì²˜</span><span>${contacts.length}</span></div>
    <div class="stat-row"><span>ë°œì£¼</span><span>${activities.filter(a=>a.type==='order').length}</span></div>
    <div class="stat-row"><span>ê²¬ì </span><span>${activities.filter(a=>a.type==='quote').length}</span></div>
    <div class="stat-row"><span>ì´ ì•¡í‹°ë¹„í‹°</span><span>${activities.length}</span></div>`;
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
renderStats();
renderContacts();
</script>
</body>
</html>
