<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CRM ê³ ê°ê´€ë¦¬</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #22263a;
    --border: #2d3250;
    --accent: #4f7cff;
    --accent2: #ff6b6b;
    --accent3: #43e97b;
    --accent4: #f7971e;
    --text: #e8eaf6;
    --muted: #7986cb;
    --danger: #ef5350;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Noto Sans KR', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; }

  /* â”€â”€ SIDEBAR (PC) â”€â”€ */
  .sidebar {
    width: 220px; min-height: 100vh; background: var(--surface);
    border-right: 1px solid var(--border); display: flex; flex-direction: column;
    padding: 20px 0; position: fixed; left: 0; top: 0; bottom: 0; z-index: 200;
    transition: transform 0.25s ease;
  }
  .logo { padding: 0 20px 16px; border-bottom: 1px solid var(--border); margin-bottom: 10px; }
  .logo h1 { font-size: 18px; font-weight: 700; color: var(--accent); }
  .logo span { font-size: 11px; color: var(--muted); font-family: 'IBM Plex Mono', monospace; }
  .sidebar-btn {
    margin: 2px 10px; padding: 9px 14px; border-radius: 8px; border: none;
    background: transparent; color: var(--text); font-family: 'Noto Sans KR', sans-serif;
    font-size: 13px; cursor: pointer; text-align: left; transition: all 0.15s;
    display: flex; align-items: center; gap: 9px; width: calc(100% - 20px);
  }
  .sidebar-btn:hover { background: var(--surface2); }
  .sidebar-btn.active { background: var(--accent); color: #fff; }
  .today-badge {
    margin-left: auto; background: #ff6b6b; color: #fff;
    font-size: 10px; font-weight: 700; font-family: 'IBM Plex Mono', monospace;
    padding: 1px 6px; border-radius: 10px; min-width: 18px; text-align: center;
    line-height: 16px; height: 16px; display: inline-block; flex-shrink: 0;
  }
  .sidebar-btn.active .today-badge { background: rgba(255,255,255,0.3); color: #fff; }
  .sidebar-stats { margin-top: auto; padding: 14px 20px; border-top: 1px solid var(--border); font-size: 11px; color: var(--muted); font-family: 'IBM Plex Mono', monospace; }
  .stat-row { display: flex; justify-content: space-between; margin: 3px 0; }
  .stat-row span:last-child { color: var(--accent); }

  /* â”€â”€ MAIN (PC) â”€â”€ */
  .main { margin-left: 220px; flex: 1; display: flex; flex-direction: column; min-height: 100vh; }
  .topbar { padding: 12px 20px; border-bottom: 1px solid var(--border); background: var(--surface); display: flex; align-items: center; gap: 10px; position: sticky; top: 0; z-index: 100; }
  .search-wrap { position: relative; flex: 1; min-width: 0; }
  .search-wrap input { width: 100%; padding: 8px 12px 8px 34px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 13px; font-family: 'Noto Sans KR', sans-serif; outline: none; transition: border-color 0.2s; }
  .search-wrap input:focus { border-color: var(--accent); }
  .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--muted); font-size: 14px; }
  .view-toggle { display: flex; gap: 3px; flex-shrink: 0; }
  .toggle-btn { padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border); background: transparent; color: var(--muted); cursor: pointer; font-size: 14px; transition: all 0.15s; }
  .toggle-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }
  .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-family: 'Noto Sans KR', sans-serif; font-size: 13px; font-weight: 500; transition: all 0.15s; display: inline-flex; align-items: center; gap: 5px; white-space: nowrap; flex-shrink: 0; }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-primary:hover { background: #3d6bef; }
  .btn-outline { background: transparent; color: var(--text); border: 1px solid var(--border); }
  .btn-outline:hover { background: var(--surface2); }
  .btn-danger { background: var(--danger); color: #fff; }
  .btn-sm { padding: 5px 10px; font-size: 12px; }
  .btn-xs { padding: 3px 7px; font-size: 11px; border-radius: 5px; }

  /* â”€â”€ ëª¨ë°”ì¼ í•˜ë‹¨ íƒ­ë°” â”€â”€ */
  .mobile-tabbar {
    display: none;
    position: fixed; bottom: 0; left: 0; right: 0; z-index: 300;
    background: var(--surface); border-top: 1px solid var(--border);
    padding: 6px 0 calc(6px + env(safe-area-inset-bottom));
    grid-template-columns: repeat(4, 1fr);
  }
  .mobile-tab {
    display: flex; flex-direction: column; align-items: center; gap: 3px;
    padding: 6px 4px; border: none; background: transparent; color: var(--muted);
    font-family: 'Noto Sans KR', sans-serif; font-size: 10px; cursor: pointer;
    position: relative; transition: color 0.15s;
  }
  .mobile-tab .tab-icon { font-size: 20px; line-height: 1; }
  .mobile-tab.active { color: var(--accent); }
  .mobile-tab .today-badge { position: absolute; top: 4px; right: calc(50% - 18px); }

  /* ëª¨ë°”ì¼ í—¤ë” */
  .mobile-header {
    display: none; position: fixed; top: 0; left: 0; right: 0; z-index: 200;
    background: var(--surface); border-bottom: 1px solid var(--border);
    padding: 10px 14px; align-items: center; gap: 10px; height: 52px;
  }
  .mobile-header h1 { font-size: 16px; font-weight: 700; color: var(--accent); flex: 1; }

  .content { padding: 20px 24px; flex: 1; }
  .section-title { font-size: 17px; font-weight: 700; margin-bottom: 4px; }
  .section-sub { font-size: 12px; color: var(--muted); margin-bottom: 12px; }
  .filter-bar { display: flex; gap: 6px; margin-bottom: 16px; flex-wrap: wrap; }
  .filter-chip { padding: 4px 12px; border-radius: 20px; border: 1px solid var(--border); background: transparent; color: var(--muted); font-size: 12px; cursor: pointer; font-family: 'Noto Sans KR', sans-serif; transition: all 0.15s; }
  .filter-chip:hover { border-color: var(--accent); color: var(--text); }
  .filter-chip.active { background: var(--accent); border-color: var(--accent); color: #fff; }
  .filter-bar-label { font-size: 10px; color: var(--muted); font-family: 'IBM Plex Mono', monospace; align-self: center; margin-right: 4px; white-space: nowrap; }
  /* íŒ€ í•„í„°ë°” êµ¬ë¶„ì„  */
  .filter-bar + .filter-bar { padding-top: 8px; border-top: 1px solid var(--border); }

  /* â”€â”€ ëª¨ë°”ì¼ ë°˜ì‘í˜• â”€â”€ */
  @media (max-width: 768px) {
    body { flex-direction: column; }
    .sidebar { display: none !important; }
    .main { margin-left: 0 !important; padding-top: 52px; padding-bottom: 70px; }
    .mobile-header { display: flex; }
    .mobile-tabbar { display: grid; }
    .topbar {
      padding: 8px 12px; gap: 8px;
      position: sticky; top: 52px;
    }
    .pc-only { display: none !important; }
    .content { padding: 14px 12px; }
    .section-title { font-size: 15px; }
    .members-row { grid-template-columns: 1fr !important; }
    .modal { width: 100% !important; max-width: 100vw !important; max-height: 92vh; border-radius: 16px 16px 0 0 !important; margin: auto 0 0 0 !important; }
    .modal-overlay { align-items: flex-end !important; }
    .list-wrap { overflow-x: auto; }
    .shared-bar { flex-wrap: wrap; gap: 6px; }
    .fin-summary { gap: 12px; }
    .view-toggle .toggle-btn { padding: 6px 8px; font-size: 13px; }
  }

  @media (max-width: 480px) {
    .topbar { flex-wrap: wrap; }
    .search-wrap { order: -1; width: 100%; flex-basis: 100%; }
    .view-toggle { gap: 2px; }
  }

  /* Company Group */
  .company-group { background: #12151f; border: 1px solid var(--border); border-radius: 14px; margin-bottom: 18px; overflow: hidden; }
  .company-header { padding: 14px 18px; display: flex; align-items: center; gap: 12px; cursor: pointer; user-select: none; background: var(--surface); border-bottom: 1px solid var(--border); transition: background 0.15s; }
  .company-header:hover { background: var(--surface2); }
  .company-logo { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 17px; font-weight: 700; color: #fff; flex-shrink: 0; }
  .company-info { flex: 1; min-width: 0; }
  .company-name { font-size: 15px; font-weight: 700; }
  .company-meta { font-size: 11px; color: var(--muted); margin-top: 3px; display: flex; gap: 12px; flex-wrap: wrap; }
  .company-badges { display: flex; gap: 5px; flex-wrap: wrap; }
  .company-toggle { color: var(--muted); font-size: 13px; transition: transform 0.2s; flex-shrink: 0; margin-left: 8px; }
  .company-group.collapsed .company-toggle { transform: rotate(-90deg); }
  .company-body { }
  .company-group.collapsed .company-body { display: none; }

  /* Shared bar */
  .shared-bar { padding: 8px 18px; background: rgba(79,124,255,0.06); border-bottom: 1px solid var(--border); display: flex; gap: 16px; flex-wrap: wrap; font-size: 12px; color: var(--muted); align-items: center; }
  .shared-tag { font-family: 'IBM Plex Mono', monospace; font-size: 10px; background: rgba(79,124,255,0.15); color: var(--accent); padding: 1px 6px; border-radius: 4px; }
  .shared-edit-btn { margin-left: auto; background: none; border: 1px solid var(--border); color: var(--muted); border-radius: 5px; padding: 2px 8px; font-size: 11px; cursor: pointer; font-family: 'Noto Sans KR', sans-serif; transition: all 0.15s; }
  .shared-edit-btn:hover { color: var(--text); border-color: var(--accent); }

  /* Members row */
  .members-row { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px; padding: 14px 18px; border-bottom: 1px solid var(--border); }
  .person-card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 12px; cursor: pointer; transition: all 0.15s; position: relative; }
  .person-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; background: var(--accent); border-radius: 10px 0 0 10px; }
  .person-card:hover { border-color: var(--accent); transform: translateY(-1px); box-shadow: 0 4px 14px rgba(79,124,255,0.12); }
  .person-head { display: flex; align-items: center; gap: 9px; margin-bottom: 8px; }
  .avatar { width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 700; color: #fff; flex-shrink: 0; }
  .person-name { font-size: 14px; font-weight: 600; }
  .person-dept { font-size: 11px; color: var(--muted); margin-top: 1px; }
  .person-contacts { font-size: 12px; color: var(--text); line-height: 2; }
  .person-contacts span { display: block; }
  .pc-label { display: inline-block; font-size: 10px; font-family: 'IBM Plex Mono', monospace; color: var(--muted); background: var(--surface2); border: 1px solid var(--border); border-radius: 3px; padding: 0 5px; margin-right: 5px; vertical-align: middle; }
  .person-badges { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 7px; }
  .add-card { background: transparent; border: 1px dashed var(--border); border-radius: 10px; padding: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 7px; color: var(--muted); font-size: 12px; transition: all 0.15s; font-family: 'Noto Sans KR', sans-serif; }
  .add-card:hover { border-color: var(--accent); color: var(--accent); }

  /* Activity badge - dynamically injected via JS */
  .co-timeline-section { padding: 14px 18px; }
  .co-timeline-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
  .co-timeline-label { font-size: 11px; font-family: 'IBM Plex Mono', monospace; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
  .timeline { position: relative; }
  .timeline::before { content: ''; position: absolute; left: 14px; top: 6px; bottom: 6px; width: 1px; background: var(--border); }
  .timeline-item { display: flex; gap: 12px; margin-bottom: 8px; }
  .timeline-dot { width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 12px; position: relative; z-index: 1; }
  .dot-call { background: rgba(79,124,255,0.15); color: var(--accent); border: 1px solid var(--accent); }
  .tl-body { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; flex: 1; overflow: hidden; transition: border-color 0.15s; }
  .tl-body:hover { border-color: var(--accent); }
  .tl-summary { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; cursor: pointer; user-select: none; gap: 8px; }
  .tl-summary-left { display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0; }
  .tl-type { font-size: 12px; font-weight: 600; white-space: nowrap; }
  .tl-title-preview { font-size: 12px; color: var(--muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .tl-summary-right { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
  .tl-date { font-size: 11px; color: var(--muted); font-family: 'IBM Plex Mono', monospace; }
  .tl-amount-badge { font-size: 11px; color: var(--accent3); font-family: 'IBM Plex Mono', monospace; font-weight: 600; }
  .tl-chevron { font-size: 10px; color: var(--muted); transition: transform 0.2s; }
  .tl-detail { display: none; padding: 0 12px 10px; border-top: 1px solid var(--border); }
  .tl-detail.open { display: block; }
  .tl-who { font-size: 11px; color: var(--accent); margin: 6px 0 4px; cursor: pointer; }
  .tl-who:hover { text-decoration: underline; }
  .tl-text { font-size: 12px; color: var(--muted); line-height: 1.6; }
  .tl-amount { font-size: 12px; color: var(--accent3); font-family: 'IBM Plex Mono', monospace; margin-top: 4px; font-weight: 600; }
  .tl-actions { display: flex; gap: 4px; margin-top: 8px; justify-content: flex-end; }
  .tl-act-btn { background: none; border: 1px solid var(--border); color: var(--muted); cursor: pointer; font-size: 11px; padding: 3px 8px; border-radius: 5px; font-family: 'Noto Sans KR', sans-serif; transition: all 0.1s; }
  .tl-act-btn:hover { border-color: var(--accent); color: var(--accent); }
  .tl-act-btn.danger:hover { border-color: var(--danger); color: var(--danger); }
  .show-more-btn { width: 100%; padding: 7px; background: none; border: 1px dashed var(--border); border-radius: 6px; color: var(--muted); font-size: 12px; cursor: pointer; font-family: 'Noto Sans KR', sans-serif; margin-top: 4px; transition: all 0.15s; }
  .show-more-btn:hover { border-color: var(--accent); color: var(--accent); }
  /* í™œë™ í•„í„°ë°” (ê°œì¸/íšŒì‚¬ ìƒì„¸) */
  .acts-filter { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px; }

  /* Ungrouped */
  .ungrouped-label { font-size: 12px; color: var(--muted); font-family: 'IBM Plex Mono', monospace; margin-bottom: 10px; }
  .ungrouped-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px; }

  /* Modal */
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.72); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
  .modal-overlay.open { display: flex; }
  .modal { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; width: 640px; max-width: 95vw; max-height: 92vh; overflow-y: auto; padding: 26px; position: relative; }
  .modal-title { font-size: 17px; font-weight: 700; margin-bottom: 20px; }
  .modal-close { position: absolute; top: 13px; right: 13px; background: var(--surface2); border: none; color: var(--text); width: 28px; height: 28px; border-radius: 6px; cursor: pointer; font-size: 15px; display: flex; align-items: center; justify-content: center; }
  .modal-close:hover { background: var(--danger); }
  .form-section { margin-bottom: 18px; }
  .form-section-title { font-size: 10px; font-family: 'IBM Plex Mono', monospace; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 9px; padding-bottom: 7px; border-bottom: 1px solid var(--border); }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
  .form-row.three { grid-template-columns: 1fr 1fr 1fr; }
  .form-row.single { grid-template-columns: 1fr; }
  .form-group { display: flex; flex-direction: column; gap: 5px; }
  .form-group label { font-size: 11px; color: var(--muted); }
  .form-group input, .form-group textarea, .form-group select { padding: 8px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 7px; color: var(--text); font-size: 13px; font-family: 'Noto Sans KR', sans-serif; outline: none; transition: border-color 0.2s; width: 100%; }
  .form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color: var(--accent); }
  .form-group select option { background: var(--surface); }
  .form-group textarea { resize: vertical; min-height: 68px; }
  .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 18px; }

  /* Detail view */
  .detail-view { display: none; padding: 24px 28px; }
  .detail-view.open { display: block; }
  .detail-header { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 22px; margin-bottom: 16px; display: flex; align-items: center; gap: 18px; flex-wrap: wrap; }
  .detail-avatar { width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 700; color: #fff; flex-shrink: 0; }
  .detail-name { font-size: 20px; font-weight: 700; }
  .detail-sub { font-size: 13px; color: var(--muted); margin-top: 3px; }
  .detail-actions { margin-left: auto; display: flex; gap: 7px; flex-wrap: wrap; }
  .info-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; margin-bottom: 16px; }
  .info-card { background: var(--surface); border: 1px solid var(--border); border-radius: 9px; padding: 12px; }
  .info-card-label { font-size: 10px; color: var(--muted); font-family: 'IBM Plex Mono', monospace; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px; }
  .info-card-value { font-size: 13px; }
  .acts-section { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 18px; }
  .acts-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
  .acts-title { font-size: 14px; font-weight: 600; }
  .empty-state { text-align: center; padding: 36px 20px; color: var(--muted); }
  .empty-icon { font-size: 36px; margin-bottom: 10px; }

  /* List view */
  .list-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
  .list-table { width: 100%; border-collapse: collapse; }
  .list-table th { text-align: left; padding: 9px 13px; font-size: 10px; color: var(--muted); font-family: 'IBM Plex Mono', monospace; text-transform: uppercase; border-bottom: 1px solid var(--border); background: var(--surface2); white-space: nowrap; }
  .list-table td { padding: 10px 13px; font-size: 13px; border-bottom: 1px solid var(--border); vertical-align: middle; }
  .list-table tr:last-child td { border-bottom: none; }
  .list-table tbody tr:not(.co-row):hover td { background: var(--surface2); }
  .co-row td { background: rgba(79,124,255,0.06); font-weight: 600; font-size: 13px; cursor: pointer; }
  .co-row:hover td { background: rgba(79,124,255,0.12) !important; }

  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* Company tabs */
  .co-tabs { display:flex; gap:4px; margin-bottom:20px; border-bottom:1px solid var(--border); padding-bottom:0; }
  .co-tab { padding:8px 18px; border:none; background:transparent; color:var(--muted); font-family:'Noto Sans KR',sans-serif; font-size:13px; cursor:pointer; border-bottom:2px solid transparent; margin-bottom:-1px; transition:all 0.15s; }
  .co-tab:hover { color:var(--text); }
  .co-tab.active { color:var(--accent); border-bottom-color:var(--accent); font-weight:600; }
  .co-panel { }

  /* Finance table */
  .fin-table { width:100%; border-collapse:collapse; font-size:13px; }
  .fin-table th { text-align:center; padding:8px 6px; font-size:10px; color:var(--muted); font-family:'IBM Plex Mono',monospace; text-transform:uppercase; border-bottom:1px solid var(--border); background:var(--surface2); white-space:nowrap; }
  .fin-table td { padding:5px 4px; border-bottom:1px solid var(--border); vertical-align:middle; }
  .fin-table tr:last-child td { border-bottom:none; }
  .fin-input { width:100%; padding:5px 7px; background:var(--bg); border:1px solid var(--border); border-radius:5px; color:var(--text); font-size:12px; font-family:'IBM Plex Mono',monospace; outline:none; text-align:right; }
  .fin-input:focus { border-color:var(--accent); }
  .fin-year { width:72px; padding:5px 7px; background:var(--bg); border:1px solid var(--border); border-radius:5px; color:var(--accent); font-size:12px; font-family:'IBM Plex Mono',monospace; outline:none; text-align:center; font-weight:600; }
  .fin-year:focus { border-color:var(--accent); }
  .fin-del { background:none; border:none; color:var(--muted); cursor:pointer; font-size:14px; padding:2px 6px; border-radius:4px; transition:all 0.1s; }
  .fin-del:hover { background:var(--danger); color:#fff; }

  /* CEO history */
  .ceo-row { display:grid; grid-template-columns:100px 1fr 1fr 1fr 32px; gap:8px; align-items:center; margin-bottom:8px; }
  .ceo-input { padding:7px 9px; background:var(--bg); border:1px solid var(--border); border-radius:6px; color:var(--text); font-size:13px; font-family:'Noto Sans KR',sans-serif; outline:none; width:100%; }
  .ceo-input:focus { border-color:var(--accent); }
  .ceo-del { background:none; border:none; color:var(--muted); cursor:pointer; font-size:14px; padding:4px 6px; border-radius:4px; transition:all 0.1s; width:32px; }
  .ceo-del:hover { background:var(--danger); color:#fff; }
  .ceo-header { display:grid; grid-template-columns:100px 1fr 1fr 1fr 32px; gap:8px; margin-bottom:6px; font-size:10px; color:var(--muted); font-family:'IBM Plex Mono',monospace; text-transform:uppercase; }

  /* Finance summary in company card */
  .fin-summary { padding:0 18px; background:rgba(67,233,123,0.04); border-bottom:1px solid var(--border); display:flex; gap:0; flex-wrap:nowrap; font-size:12px; align-items:stretch; overflow:hidden; }
  .fin-summary-preview { display:flex; align-items:center; gap:0; flex:1; overflow:hidden; cursor:pointer; padding:7px 0; }
  .fin-summary-preview:hover { opacity:.8; }
  .fin-chip { display:flex; align-items:center; gap:4px; padding:0 10px; border-right:1px solid var(--border); white-space:nowrap; flex-shrink:0; }
  .fin-chip:first-child { padding-left:0; }
  .fin-chip-label { font-size:10px; color:var(--muted); font-family:'IBM Plex Mono',monospace; }
  .fin-chip-value { font-size:12px; font-weight:600; font-family:'IBM Plex Mono',monospace; }
  .fin-chip-value.pos { color:var(--accent3); }
  .fin-chip-value.neg { color:var(--accent2); }
  .fin-chip-value.neu { color:var(--text); }
  .fin-expand-btn { padding:0 12px; background:none; border:none; color:var(--muted); cursor:pointer; font-size:11px; font-family:'IBM Plex Mono',monospace; border-left:1px solid var(--border); white-space:nowrap; flex-shrink:0; }
  .fin-expand-btn:hover { color:var(--accent); }
  .fin-detail { display:none; padding:10px 18px; border-bottom:1px solid var(--border); background:rgba(67,233,123,0.02); }
  .fin-detail.open { display:block; }
  .fin-table { width:100%; border-collapse:collapse; font-size:12px; font-family:'IBM Plex Mono',monospace; }
  .fin-table th { font-size:10px; color:var(--muted); font-weight:500; padding:4px 8px; text-align:right; border-bottom:1px solid var(--border); }
  .fin-table th:first-child { text-align:left; }
  .fin-table td { padding:5px 8px; text-align:right; border-bottom:1px solid rgba(45,50,80,0.5); }
  .fin-table td:first-child { text-align:left; color:var(--accent); font-weight:600; }
  /* CEO expandable */
  .ceo-bar { padding:6px 18px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:10px; font-size:12px; color:var(--muted); background:rgba(79,124,255,0.03); cursor:pointer; user-select:none; }
  .ceo-bar:hover { background:rgba(79,124,255,0.07); }
  .ceo-bar-name { color:var(--text); font-weight:600; }
  .ceo-detail { display:none; padding:8px 18px; border-bottom:1px solid var(--border); background:rgba(79,124,255,0.02); }
  .ceo-detail.open { display:block; }
  .ceo-row-item { display:flex; gap:10px; font-size:12px; padding:4px 0; border-bottom:1px solid rgba(45,50,80,0.4); align-items:center; }
  .ceo-row-item:last-child { border-bottom:none; }
  .ceo-row-name { font-weight:600; color:var(--text); min-width:80px; }
  .ceo-row-period { color:var(--accent); font-family:'IBM Plex Mono',monospace; font-size:11px; }
  .ceo-row-memo { color:var(--muted); font-size:11px; flex:1; }

  /* PDF Import */
  .pdf-dropzone {
    border: 2px dashed var(--border); border-radius: 10px; padding: 36px 20px;
    text-align: center; cursor: pointer; transition: all 0.2s;
  }
  .pdf-dropzone:hover, .pdf-dropzone.drag { border-color: var(--accent); background: rgba(79,124,255,0.05); }
  .pdf-drop-icon { font-size: 36px; margin-bottom: 10px; }
  .pdf-drop-text { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
  .pdf-drop-sub { font-size: 12px; color: var(--muted); }
  .pdf-spinner {
    width: 44px; height: 44px; border: 3px solid var(--border);
    border-top-color: var(--accent); border-radius: 50%;
    animation: spin 0.8s linear infinite; margin: 0 auto;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .pdf-contact-card {
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 10px; padding: 14px 16px; margin-bottom: 10px;
  }
  .pdf-contact-card.checked { border-color: var(--accent); }
  .pdf-card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
  .pdf-card-check { width: 18px; height: 18px; accent-color: var(--accent); cursor: pointer; flex-shrink: 0; }
  .pdf-card-name { font-size: 14px; font-weight: 700; flex: 1; }
  .pdf-fields { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .pdf-field { display: flex; flex-direction: column; gap: 3px; }
  .pdf-field label { font-size: 10px; color: var(--muted); font-family: 'IBM Plex Mono', monospace; text-transform: uppercase; }
  .pdf-field input { padding: 6px 9px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 12px; font-family: 'Noto Sans KR', sans-serif; outline: none; }
  .pdf-field input:focus { border-color: var(--accent); }
  .pdf-field.full { grid-column: 1 / -1; }
</style>
</head>
<body>

<!-- â”€â”€ ëª¨ë°”ì¼ í—¤ë” â”€â”€ -->
<header class="mobile-header">
  <h1>â–¸ CRM</h1>
  <div style="display:flex;gap:6px;margin-left:auto;align-items:center">
    <button class="btn btn-outline btn-sm" onclick="openPdfModal()" style="padding:5px 8px;font-size:12px">ğŸ—‚</button>
    <button class="btn btn-primary btn-sm" onclick="openAddContact(null)" style="padding:5px 10px;font-size:12px">ï¼‹</button>
  </div>
</header>

<aside class="sidebar">
  <div class="logo">
    <h1>â–¸ CRM</h1>
    <span>ê³ ê°ê´€ë¦¬ ì‹œìŠ¤í…œ</span>
  </div>
  <button class="sidebar-btn active" id="navContacts" onclick="nav('contacts')"><span>ğŸ¢</span> ì—°ë½ì²˜ <span class="today-badge" id="todayContacts" style="display:none"></span></button>
  <button class="sidebar-btn" id="navActivities" onclick="nav('activities')"><span>ğŸ“‹</span> ì „ì²´ í™œë™ <span class="today-badge" id="todayActivities" style="display:none"></span></button>
  <button class="sidebar-btn" onclick="openTypeModal()"><span>ğŸ·</span> í™œë™ ìœ í˜• ê´€ë¦¬</button>
  <button class="sidebar-btn" onclick="openGsModal()"><span>ğŸ—„</span> Supabase ì—°ë™</button>
  <div id="gsSyncStatus" style="font-size:10px;padding:6px 20px;color:var(--muted);font-family:'IBM Plex Mono',monospace;line-height:1.5"></div>
  <div class="sidebar-stats" id="sidebarStats"></div>
</aside>

<main class="main">
  <div class="topbar" id="mainTopbar">
    <div class="search-wrap">
      <span class="search-icon">ğŸ”</span>
      <input type="text" id="searchInput" placeholder="ì´ë¦„, íšŒì‚¬ ê²€ìƒ‰..." oninput="renderContacts()">
    </div>
    <div class="view-toggle">
      <button class="toggle-btn active" id="vBtn-group" title="íšŒì‚¬ë³„ ì¹´ë“œ" onclick="setViewMode('group')">âŠ</button>
      <button class="toggle-btn" id="vBtn-glist" title="íšŒì‚¬ë³„ ëª©ë¡" onclick="setViewMode('glist')">â–¤</button>
      <button class="toggle-btn" id="vBtn-list" title="ì „ì²´ ëª©ë¡" onclick="setViewMode('list')">â˜°</button>
    </div>
    <button class="btn btn-outline pc-only" onclick="openPdfModal()" title="íŒŒì¼ì—ì„œ ì—°ë½ì²˜ ìë™ ì¶”ì¶œ">ğŸ—‚ íŒŒì¼ ê°€ì ¸ì˜¤ê¸°</button>
    <button class="btn btn-primary pc-only" onclick="openAddContact(null)">ï¼‹ ì—°ë½ì²˜</button>
  </div>

  <!-- Contacts View -->
  <div class="content" id="contactsView">
    <div class="section-title">ì—°ë½ì²˜</div>
    <div class="section-sub" id="viewSub"></div>
    <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:14px">
      <div class="filter-bar" id="teamFilterBar"></div>
    </div>
    <div id="mainGrid"></div>
  </div>

  <!-- Detail View -->
  <div id="detailView" class="detail-view">
    <div style="display:flex;gap:8px;margin-bottom:14px">
      <button class="btn btn-outline btn-sm" onclick="backToList()">â† ëª©ë¡ìœ¼ë¡œ</button>
      <button class="btn btn-outline btn-sm" id="detailCoBtn" style="display:none">ğŸ¢ íšŒì‚¬ ë³´ê¸°</button>
    </div>
    <div id="detailContent"></div>
  </div>

  <!-- Activities View -->
  <div class="content" id="activitiesView" style="display:none">
    <div class="section-title">ì „ì²´ í™œë™</div>
    <div class="section-sub" id="actsSub">ëª¨ë“  í™œë™ ë‚´ì—­ (ìµœì‹ ìˆœ)</div>
    <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:16px">
      <div class="filter-bar" id="actFilterBar" style="margin-bottom:0"></div>
      <div class="filter-bar" id="actTeamFilterBar" style="margin-bottom:0"></div>
    </div>
    <div id="allActsContent"></div>
  </div>
</main>

<!-- â”€â”€ ëª¨ë°”ì¼ í•˜ë‹¨ íƒ­ë°” â”€â”€ -->
<nav class="mobile-tabbar">
  <button class="mobile-tab active" id="mTabContacts" onclick="nav('contacts')">
    <span class="tab-icon">ğŸ¢</span>
    <span>ì—°ë½ì²˜</span>
    <span class="today-badge" id="mTodayContacts" style="display:none"></span>
  </button>
  <button class="mobile-tab" id="mTabActivities" onclick="nav('activities')">
    <span class="tab-icon">ğŸ“‹</span>
    <span>í™œë™</span>
    <span class="today-badge" id="mTodayActivities" style="display:none"></span>
  </button>
  <button class="mobile-tab" id="mTabImport" onclick="openPdfModal()">
    <span class="tab-icon">ğŸ—‚</span>
    <span>ê°€ì ¸ì˜¤ê¸°</span>
  </button>
  <button class="mobile-tab" id="mTabGs" onclick="openGsModal()">
    <span class="tab-icon" id="mTabGsIcon">ğŸ—„</span>
    <span>ì—°ë™ì„¤ì •</span>
  </button>
</nav>

<!-- Contact Modal -->
<div class="modal-overlay" id="contactModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('contactModal')">âœ•</button>
    <div class="modal-title" id="cModalTitle">ìƒˆ ì—°ë½ì²˜</div>
    <div class="form-section">
      <div class="form-section-title">ì†Œì† íšŒì‚¬</div>
      <div class="form-row single">
        <div class="form-group">
          <label>íšŒì‚¬ëª… (ê°™ì€ íšŒì‚¬ ì§ì›ì€ ë™ì¼ ì´ë¦„ ì…ë ¥)</label>
          <input type="text" id="f_company" placeholder="(ì£¼)ì˜ˆì‹œê¸°ì—…" list="coSuggestions" oninput="onCompanyInput()">
          <datalist id="coSuggestions"></datalist>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>ë¶€ì„œ</label><input type="text" id="f_dept" placeholder="ì˜ì—…íŒ€"></div>
        <div class="form-group"><label>ì§ì±…</label><input type="text" id="f_position" placeholder="ê³¼ì¥"></div>
      </div>
    </div>
    <div class="form-section">
      <div class="form-section-title">ê°œì¸ ì •ë³´</div>
      <div class="form-row">
        <div class="form-group"><label>ì„± *</label><input type="text" id="f_last" placeholder="ê¹€"></div>
        <div class="form-group"><label>ì´ë¦„ *</label><input type="text" id="f_first" placeholder="ì² ìˆ˜"></div>
      </div>
      <div class="form-row single">
        <div class="form-group"><label>ì´ë©”ì¼</label><input type="email" id="f_email" placeholder="example@email.com"></div>
      </div>
    </div>
    <div class="form-section">
      <div class="form-section-title">ê°œì¸ ì—°ë½ì²˜</div>
      <div class="form-row three">
        <div class="form-group"><label>ì‚¬ë¬´ì‹¤</label><input type="tel" id="f_office" placeholder="02-0000-0000"></div>
        <div class="form-group"><label>íœ´ëŒ€í°</label><input type="tel" id="f_mobile" placeholder="010-0000-0000"></div>
        <div class="form-group"><label>ì¶”ê°€</label><input type="tel" id="f_extra" placeholder="íŒ©ìŠ¤ ë“±"></div>
      </div>
    </div>
    <div class="form-section">
      <div class="form-section-title">ì£¼ì†Œ (íšŒì‚¬ ê³µìœ )</div>
      <div id="addrNotice" style="font-size:11px;color:var(--accent);margin-bottom:7px;display:none">â„¹ ë“±ë¡ëœ íšŒì‚¬ ì£¼ì†Œê°€ ì ìš©ë©ë‹ˆë‹¤. ë³€ê²½í•˜ë©´ íšŒì‚¬ ì „ì²´ì— ë°˜ì˜ë©ë‹ˆë‹¤.</div>
      <div class="form-row single">
        <div class="form-group"><label>ì£¼ì†Œ</label><input type="text" id="f_address" placeholder="ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123"></div>
      </div>
    </div>
    <div class="form-section">
      <div class="form-section-title">ë©”ëª¨</div>
      <div class="form-row single">
        <div class="form-group"><textarea id="f_memo" placeholder="íŠ¹ì´ì‚¬í•­, ê´€ê³„ ë“±"></textarea></div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal('contactModal')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="saveContact()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- Company Modal -->
<div class="modal-overlay" id="companyModal">
  <div class="modal" style="width:680px">
    <button class="modal-close" onclick="closeModal('companyModal')">âœ•</button>
    <div class="modal-title" id="coModalTitle">íšŒì‚¬ ì •ë³´</div>

    <!-- íƒ­ -->
    <div class="co-tabs">
      <button class="co-tab active" id="coTab-basic" onclick="switchCoTab('basic')">ê¸°ë³¸ ì •ë³´</button>
      <button class="co-tab" id="coTab-finance" onclick="switchCoTab('finance')">ì¬ë¬´ í˜„í™©</button>
      <button class="co-tab" id="coTab-ceo" onclick="switchCoTab('ceo')">ëŒ€í‘œì´ì‚¬ ì´ë ¥</button>
    </div>

    <!-- íƒ­: ê¸°ë³¸ ì •ë³´ -->
    <div id="coPanel-basic" class="co-panel">
      <div class="form-section">
        <div class="form-section-title">íšŒì‚¬ëª…</div>
        <div class="form-row single">
          <div class="form-group">
            <label>íšŒì‚¬ëª… (ìˆ˜ì • ì‹œ ì†Œì† ì§ì› ì „ì²´ì— ìë™ ë°˜ì˜)</label>
            <input type="text" id="co_name" placeholder="íšŒì‚¬ëª…">
          </div>
        </div>
      </div>
      <div class="form-section">
        <div class="form-section-title">ìš°ë¦¬ íŒ€ ë‹´ë‹¹ì</div>
        <p style="font-size:11px;color:var(--muted);margin-bottom:8px;line-height:1.6">ì´ íšŒì‚¬ë¥¼ ë‹´ë‹¹í•˜ëŠ” ìš°ë¦¬ íŒ€ ì •ë³´ë¥¼ ê¸°ë¡í•©ë‹ˆë‹¤.</p>
        <div class="form-row">
          <div class="form-group"><label>íŒ€ëª…</label><input type="text" id="co_our_team" placeholder="ì˜ì—…1íŒ€"></div>
          <div class="form-group"><label>ë‹´ë‹¹ì ì´ë¦„</label><input type="text" id="co_our_name" placeholder="í™ê¸¸ë™"></div>
        </div>
        <div class="form-row single">
          <div class="form-group"><label>ë©”ëª¨</label><input type="text" id="co_our_memo" placeholder="ì£¼ë‹´ë‹¹ì / 2024.01 ì¸ìˆ˜ì¸ê³„"></div>
        </div>
      </div>

      <div class="form-section">
        <div class="form-section-title">ë‹¤ë¥¸ íšŒì‚¬ì™€ ë³‘í•©</div>
        <p style="font-size:11px;color:var(--muted);margin-bottom:8px;line-height:1.6">ê°™ì€ íšŒì‚¬ê°€ ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ë“±ë¡ëœ ê²½ìš° ë³‘í•©í•©ë‹ˆë‹¤. ë³‘í•© ëŒ€ìƒì˜ ëª¨ë“  ì§ì›ì´ í˜„ì¬ íšŒì‚¬ë¡œ ì´ë™ë©ë‹ˆë‹¤.</p>
        <div class="form-row single">
          <div class="form-group">
            <label>ë³‘í•©í•  íšŒì‚¬ ì„ íƒ (ì—†ì• ê³  ì‹¶ì€ ìª½)</label>
            <select id="co_merge_target" style="background:var(--bg);border:1px solid var(--border);border-radius:7px;color:var(--text);padding:8px 10px;font-size:13px;font-family:inherit;outline:none;width:100%">
              <option value="">â€” ë³‘í•© ì•ˆ í•¨ â€”</option>
            </select>
          </div>
        </div>
        <div id="co_merge_preview" style="display:none;font-size:12px;color:var(--accent);margin-top:6px;padding:8px 12px;background:rgba(79,124,255,0.08);border-radius:6px;border:1px solid rgba(79,124,255,0.2)"></div>
      </div>
      <div class="form-section">
        <div class="form-section-title">ëŒ€í‘œ ì—°ë½ì²˜</div>
        <div class="form-row">
          <div class="form-group"><label>ëŒ€í‘œ ì „í™”</label><input type="tel" id="co_phone" placeholder="02-0000-0000"></div>
          <div class="form-group"><label>íŒ©ìŠ¤</label><input type="tel" id="co_fax" placeholder="02-0000-0001"></div>
        </div>
      </div>
      <div class="form-section">
        <div class="form-section-title">ì£¼ì†Œ</div>
        <div class="form-row single">
          <div class="form-group"><label>ì£¼ì†Œ</label><input type="text" id="co_address" placeholder="ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123"></div>
        </div>
      </div>
      <div class="form-section">
        <div class="form-section-title">ë©”ëª¨</div>
        <div class="form-row single">
          <div class="form-group"><textarea id="co_memo" placeholder="íšŒì‚¬ ê´€ë ¨ ë©”ëª¨"></textarea></div>
        </div>
      </div>
    </div>

    <!-- íƒ­: ì¬ë¬´ í˜„í™© -->
    <div id="coPanel-finance" class="co-panel" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
        <p style="font-size:12px;color:var(--muted)">ì—°ë„ë³„ ì¬ë¬´ ë°ì´í„°ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ë‹¨ìœ„: ë°±ë§Œì›</p>
        <button class="btn btn-primary btn-sm" onclick="addFinanceRow()">ï¼‹ ì—°ë„ ì¶”ê°€</button>
      </div>
      <div style="overflow-x:auto">
        <table class="fin-table" id="finTable">
          <thead>
            <tr>
              <th style="width:80px">ì—°ë„</th>
              <th>ì¸ì›(ëª…)</th>
              <th>ë§¤ì¶œ</th>
              <th>ì˜ì—…ì´ìµ</th>
              <th>ìˆœì´ìµ</th>
              <th>ìì‚°</th>
              <th>ë¶€ì±„</th>
              <th style="width:36px"></th>
            </tr>
          </thead>
          <tbody id="finBody"></tbody>
        </table>
      </div>
      <p style="font-size:11px;color:var(--muted);margin-top:10px">* ê¸ˆì•¡ ë‹¨ìœ„: ë°±ë§Œì› / ë¹ˆì¹¸ì€ ë¯¸ì…ë ¥ìœ¼ë¡œ ì²˜ë¦¬</p>
    </div>

    <!-- íƒ­: ëŒ€í‘œì´ì‚¬ ì´ë ¥ -->
    <div id="coPanel-ceo" class="co-panel" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
        <p style="font-size:12px;color:var(--muted)">ëŒ€í‘œì´ì‚¬ ë³€ê²½ ì´ë ¥ì„ ìµœì‹ ìˆœìœ¼ë¡œ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
        <button class="btn btn-primary btn-sm" onclick="addCeoRow()">ï¼‹ ì¶”ê°€</button>
      </div>
      <div id="ceoList"></div>
    </div>

    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal('companyModal')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="saveCompany()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- Supabase ì—°ë™ Modal -->
<div class="modal-overlay" id="gsModal">
  <div class="modal" style="width:540px">
    <button class="modal-close" onclick="closeModal('gsModal')">âœ•</button>
    <div class="modal-title">ğŸ—„ Supabase ì—°ë™</div>

    <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:16px;font-size:12px;line-height:2.1;color:var(--muted)">
      <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:8px">ğŸ“‹ ìµœì´ˆ ì„¤ì • ë°©ë²• (í•œ ë²ˆë§Œ)</div>
      <div><span style="color:var(--accent);font-weight:600">1.</span> <a href="https://supabase.com" target="_blank" style="color:var(--accent)">supabase.com</a> â†’ ë¬´ë£Œ ê°€ì… â†’ ìƒˆ í”„ë¡œì íŠ¸ ìƒì„±</div>
      <div><span style="color:var(--accent);font-weight:600">2.</span> í”„ë¡œì íŠ¸ ëŒ€ì‹œë³´ë“œ â†’ ì™¼ìª½ <b>SQL Editor</b> í´ë¦­</div>
      <div><span style="color:var(--accent);font-weight:600">3.</span> ì•„ë˜ <b>SQL ë³µì‚¬</b> ë²„íŠ¼ í´ë¦­ â†’ ë¶™ì—¬ë„£ê¸° â†’ <b>Run</b></div>
      <div><span style="color:var(--accent);font-weight:600">4.</span> ì™¼ìª½ <b>Project Settings â†’ API</b></div>
      <div><span style="color:var(--accent);font-weight:600">5.</span> <b>Project URL</b> ê³¼ <b>anon public key</b> ë³µì‚¬ í›„ ì•„ë˜ ì…ë ¥</div>
    </div>

    <!-- SQL ë³µì‚¬ ë²„íŠ¼ -->
    <div style="margin-bottom:14px">
      <div style="font-size:11px;color:var(--muted);margin-bottom:6px;font-family:'IBM Plex Mono',monospace">SQL Editorì— ì‹¤í–‰í•  í…Œì´ë¸” ìƒì„± ì½”ë“œ</div>
      <div style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px 12px;font-size:11px;font-family:'IBM Plex Mono',monospace;color:var(--muted);line-height:1.7;max-height:120px;overflow-y:auto" id="sbSqlBlock">create table if not exists contacts (id text primary key, company text, dept text, position text, last text, first text, email text, office text, mobile text, extra text, address text, memo text, created_at text);
create table if not exists activities (id text primary key, contact_id text, type text, date text, title text, content text, amount text, created_at text);
create table if not exists companies (name text primary key, data text);
create table if not exists types (id int primary key, data text);
alter table contacts enable row level security;
alter table activities enable row level security;
alter table companies enable row level security;
alter table types enable row level security;
create policy "allow all" on contacts for all using (true) with check (true);
create policy "allow all" on activities for all using (true) with check (true);
create policy "allow all" on companies for all using (true) with check (true);
create policy "allow all" on types for all using (true) with check (true);</div>
      <button class="btn btn-outline btn-sm" style="margin-top:6px;width:100%" onclick="
        navigator.clipboard.writeText(document.getElementById('sbSqlBlock').textContent);
        this.textContent='âœ… ë³µì‚¬ë¨!';
        setTimeout(()=>this.textContent='ğŸ“‹ SQL ì „ì²´ ë³µì‚¬',1500)
      ">ğŸ“‹ SQL ì „ì²´ ë³µì‚¬</button>
    </div>

    <!-- URL / Key ì…ë ¥ -->
    <div style="display:grid;gap:10px;margin-bottom:14px">
      <div class="form-group" style="margin:0">
        <label style="font-size:11px;color:var(--muted);margin-bottom:4px;display:block">Project URL</label>
        <input type="text" id="sbUrlInput" placeholder="https://xxxxxxxxxxx.supabase.co"
          style="width:100%;padding:9px 12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:12px;font-family:'IBM Plex Mono',monospace;outline:none">
      </div>
      <div class="form-group" style="margin:0">
        <label style="font-size:11px;color:var(--muted);margin-bottom:4px;display:block">anon public key</label>
        <div style="position:relative">
          <input type="password" id="sbKeyInput" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
            style="width:100%;padding:9px 38px 9px 12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:12px;font-family:'IBM Plex Mono',monospace;outline:none">
          <button onclick="const i=document.getElementById('sbKeyInput');i.type=i.type==='password'?'text':'password'"
            style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--muted);cursor:pointer">ğŸ‘</button>
        </div>
      </div>
    </div>

    <!-- í˜„ì¬ ì—°ë™ ìƒíƒœ -->
    <div id="sbCurrentStatus" style="display:none;background:rgba(67,233,123,0.08);border:1px solid rgba(67,233,123,0.25);border-radius:8px;padding:10px 14px;font-size:12px;margin-bottom:12px">
      <div style="color:var(--accent3);font-weight:600;margin-bottom:4px">âœ… í˜„ì¬ ì—°ë™ë¨</div>
      <div id="sbCurrentUrl" style="color:var(--muted);font-family:'IBM Plex Mono',monospace;font-size:10px;word-break:break-all"></div>
      <div id="sbLastSyncInfo" style="color:var(--muted);font-size:11px;margin-top:4px"></div>
    </div>

    <div id="sbStatusMsg" style="font-size:11px;min-height:16px;margin-bottom:10px;word-break:break-all;line-height:1.6"></div>

    <div class="modal-actions" style="flex-wrap:wrap;gap:8px">
      <button class="btn btn-outline btn-sm" onclick="closeModal('gsModal')">ë‹«ê¸°</button>
      <button class="btn btn-outline btn-sm" id="sbDisconnectBtn" style="display:none;color:var(--danger);border-color:var(--danger)" onclick="sbDisconnect()">ì—°ë™ í•´ì œ</button>
      <button class="btn btn-outline btn-sm" onclick="sbDiagnose()">ğŸ” ì—°ê²° ì§„ë‹¨</button>
      <button class="btn btn-outline btn-sm" onclick="sbManualLoad()">â˜ ì§€ê¸ˆ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button class="btn btn-primary btn-sm" onclick="sbSaveSettings()">âœ… ì—°ê²° ì €ì¥</button>
    </div>
  </div>
</div>

<!-- Contact Delete Confirm Modal -->
<div class="modal-overlay" id="delContactModal">
  <div class="modal" style="width:380px;text-align:center">
    <div style="font-size:40px;margin-bottom:14px">ğŸ—‘</div>
    <div class="modal-title" style="text-align:center;margin-bottom:8px">ì—°ë½ì²˜ ì‚­ì œ</div>
    <div id="delContactInfo" style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px 16px;margin-bottom:16px;font-size:13px"></div>
    <p style="font-size:12px;color:var(--muted);margin-bottom:20px">ì´ ì—°ë½ì²˜ì™€ ê´€ë ¨ í™œë™ì´ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤. ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
    <div style="display:flex;gap:10px;justify-content:center">
      <button class="btn btn-outline" onclick="closeModal('delContactModal')" style="min-width:100px">ì·¨ì†Œ</button>
      <button class="btn btn-danger" id="delContactConfirmBtn" style="min-width:100px">ì‚­ì œ</button>
    </div>
  </div>
</div>

<!-- Merge Confirm Modal -->
<div class="modal-overlay" id="mergeConfirmModal">
  <div class="modal" style="width:420px;text-align:center">
    <div style="font-size:40px;margin-bottom:14px">ğŸ”€</div>
    <div class="modal-title" style="text-align:center;margin-bottom:8px">íšŒì‚¬ ë³‘í•©</div>
    <div id="mergeConfirmInfo" style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px 16px;margin-bottom:16px;text-align:left;font-size:13px;line-height:2"></div>
    <p style="font-size:12px;color:var(--muted);margin-bottom:20px">ë³‘í•© í›„ì—ëŠ” ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
    <div style="display:flex;gap:10px;justify-content:center">
      <button class="btn btn-outline" onclick="closeModal('mergeConfirmModal')" style="min-width:100px">ì·¨ì†Œ</button>
      <button class="btn btn-primary" id="mergeConfirmBtn" style="min-width:100px">ë³‘í•© ì‹¤í–‰</button>
    </div>
  </div>
</div>

<!-- Activity Modal -->
<div class="modal-overlay" id="activityModal">
  <div class="modal" style="width:480px">
    <button class="modal-close" onclick="closeModal('activityModal')">âœ•</button>
    <div class="modal-title" id="actModalTitle">í™œë™ ì¶”ê°€</div>
    <div class="form-section" id="actWhoSection">
      <div class="form-section-title">ë‹´ë‹¹ì</div>
      <div id="actWho" style="font-size:14px;font-weight:600;color:var(--accent);padding:4px 0"></div>
    </div>
    <div class="form-row single">
      <div class="form-group"><label>ìœ í˜• *</label>
        <select id="a_type"></select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>ë‚ ì§œ *</label><input type="date" id="a_date"></div>
      <div class="form-group"><label>ê¸ˆì•¡</label><input type="text" id="a_amount" placeholder="â‚©"></div>
    </div>
    <div class="form-row single">
      <div class="form-group"><label>ì œëª©</label><input type="text" id="a_title" placeholder="ê°„ë‹¨í•œ ì œëª©"></div>
    </div>
    <div class="form-row single">
      <div class="form-group"><label>ë‚´ìš©</label><textarea id="a_content" placeholder="ìƒì„¸ ë‚´ìš©"></textarea></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal('activityModal')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" id="actSaveBtn" onclick="saveActivity()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- Type Manager Modal -->
<div class="modal-overlay" id="typeModal">
  <div class="modal" style="width:480px">
    <button class="modal-close" onclick="closeModal('typeModal')">âœ•</button>
    <div class="modal-title">í™œë™ ìœ í˜• ê´€ë¦¬</div>
    <p style="font-size:12px;color:var(--muted);margin-bottom:14px;line-height:1.7">ìœ í˜•ì„ ì¶”ê°€í•˜ê±°ë‚˜ ìˆœì„œë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>ê¸°ë³¸ ìœ í˜•(ë°œì£¼Â·ê²¬ì Â·ë°©ë¬¸Â·í†µí™”Â·ê¸°íƒ€)ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
    <div id="typeList"></div>
    <div style="margin-top:14px;padding-top:14px;border-top:1px solid var(--border)">
      <div class="form-section-title" style="margin-bottom:10px">ìƒˆ ìœ í˜• ì¶”ê°€</div>
      <div style="display:grid;grid-template-columns:60px 1fr 120px auto;gap:8px;align-items:center">
        <input id="newTypeEmoji" placeholder="ğŸ”–" maxlength="2" style="padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:7px;color:var(--text);font-size:18px;text-align:center;outline:none;width:100%">
        <input id="newTypeLabel" placeholder="ìœ í˜• ì´ë¦„" style="padding:8px 10px;background:var(--bg);border:1px solid var(--border);border-radius:7px;color:var(--text);font-size:13px;font-family:inherit;outline:none;width:100%">
        <div style="display:flex;align-items:center;gap:6px">
          <input type="color" id="newTypeColor" value="#4f7cff" style="width:32px;height:32px;border:1px solid var(--border);border-radius:6px;background:var(--bg);cursor:pointer;padding:2px">
          <span style="font-size:11px;color:var(--muted)">ìƒ‰ìƒ</span>
        </div>
        <button class="btn btn-primary btn-sm" onclick="addCustomType()">ì¶”ê°€</button>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal('typeModal')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="saveTypes_modal()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- Delete Confirm Modal -->
<div class="modal-overlay" id="delActModal">
  <div class="modal" style="width:400px;text-align:center">
    <div style="font-size:40px;margin-bottom:14px">ğŸ—‘</div>
    <div class="modal-title" style="text-align:center;margin-bottom:8px">í™œë™ ì‚­ì œ</div>
    <div id="delActInfo" style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px 16px;margin-bottom:20px;text-align:left;font-size:13px;line-height:1.8"></div>
    <p style="font-size:13px;color:var(--muted);margin-bottom:20px">ì´ í™œë™ì„ ì‚­ì œí•˜ë©´ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
    <div style="display:flex;gap:10px;justify-content:center">
      <button class="btn btn-outline" onclick="closeModal('delActModal')" style="min-width:100px">ì·¨ì†Œ</button>
      <button class="btn btn-danger" id="delActConfirmBtn" style="min-width:100px">ì‚­ì œ</button>
    </div>
  </div>
</div>

<!-- PDF Import Modal -->
<div class="modal-overlay" id="pdfModal">
  <div class="modal" style="width:640px">
    <button class="modal-close" onclick="closeModal('pdfModal')">âœ•</button>
    <div class="modal-title">ğŸ—‚ íŒŒì¼ì—ì„œ ì—°ë½ì²˜ ìë™ ì¶”ì¶œ</div>

    <!-- Step 1: API Key -->
    <div id="pdfStep0" class="pdf-step">
      <div class="form-section">
        <div class="form-section-title">Claude API í‚¤ ì„¤ì •</div>
        <p style="font-size:12px;color:var(--muted);margin-bottom:10px;line-height:1.7">
          íŒŒì¼ ë¶„ì„ì—ëŠ” Claude APIê°€ ì‚¬ìš©ë©ë‹ˆë‹¤.<br>
          <a href="https://console.anthropic.com" target="_blank" style="color:var(--accent)">console.anthropic.com</a> â†’ API Keys ë©”ë‰´ì—ì„œ ë°œê¸‰í•˜ì„¸ìš”.<br>
          í‚¤ëŠ” ì´ ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë˜ë©° ì™¸ë¶€ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        </p>
        <div class="form-row single">
          <div class="form-group">
            <label>Anthropic API Key <span id="keyPreview" style="font-size:10px;color:var(--accent3);font-family:'IBM Plex Mono',monospace"></span></label>
            <div style="position:relative">
              <input type="password" id="pdfApiKey" placeholder="sk-ant-api03-..."
                style="padding-right:44px"
                oninput="const v=this.value.trim();document.getElementById('pdfKeyValidMsg').textContent=v&&!v.startsWith('sk-')?'âš  sk- ë¡œ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤':''">
              <button onclick="const i=document.getElementById('pdfApiKey');i.type=i.type==='password'?'text':'password'"
                style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--muted);cursor:pointer;font-size:13px">ğŸ‘</button>
            </div>
            <div id="pdfKeyValidMsg" style="font-size:11px;color:var(--accent2);margin-top:4px"></div>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-outline" onclick="closeModal('pdfModal')">ì·¨ì†Œ</button>
        <button class="btn btn-primary" onclick="pdfSaveKey()">ì €ì¥ í›„ ê³„ì†</button>
      </div>
    </div>

    <!-- Step 2: Upload -->
    <div id="pdfStep1" class="pdf-step" style="display:none">
      <div class="form-section">
        <div class="form-section-title">íŒŒì¼ ì—…ë¡œë“œ</div>
        <p style="font-size:12px;color:var(--muted);margin-bottom:12px;line-height:1.8">
          ëª…í•¨ ì‚¬ì§„, PDF, Word, í…ìŠ¤íŠ¸ íŒŒì¼, ê·¸ë¦¬ê³  OutlookÂ·Gmail ë“±ì˜ <strong style="color:var(--accent3)">ëŒ€ìš©ëŸ‰ CSV</strong>ë„ ì§€ì›í•©ë‹ˆë‹¤.<br>
          <span style="color:var(--accent)">ğŸ“„ PDF</span> &nbsp;
          <span style="color:var(--accent)">ğŸ–¼ ì‚¬ì§„ (JPGÂ·PNGÂ·WEBP)</span> &nbsp;
          <span style="color:var(--accent)">ğŸ“ í…ìŠ¤íŠ¸ (TXT)</span> &nbsp;
          <span style="color:var(--accent3)">ğŸ“Š CSV (í¬ê¸° ì œí•œ ì—†ìŒ)</span>
        </p>
        <div id="pdfDropzone" class="pdf-dropzone" onclick="document.getElementById('pdfFileInput').click()">
          <div class="pdf-drop-icon" id="dropIcon">ğŸ—‚</div>
          <div class="pdf-drop-text">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œ</div>
          <div class="pdf-drop-sub">PDF Â· JPG Â· PNG Â· WEBP Â· TXT Â· CSV (CSVëŠ” í¬ê¸° ì œí•œ ì—†ìŒ / ê¸°íƒ€ ìµœëŒ€ 10MB)</div>
          <input type="file" id="pdfFileInput"
            accept=".pdf,.jpg,.jpeg,.png,.webp,.txt,.csv,.xls,.xlsx,.doc,.docx"
            style="display:none" onchange="onPdfSelected(this)">
        </div>
        <div id="pdfFileName" style="font-size:12px;color:var(--accent);margin-top:8px;display:none"></div>
        <div id="pdfFileTypeNote" style="font-size:11px;color:var(--muted);margin-top:6px;display:none"></div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-outline" onclick="pdfChangeKey()">ğŸ”‘ í‚¤ ë³€ê²½</button>
        <button class="btn btn-outline" onclick="closeModal('pdfModal')">ì·¨ì†Œ</button>
        <button class="btn btn-primary" id="pdfAnalyzeBtn" onclick="pdfAnalyze()" disabled>ğŸ” ë¶„ì„ ì‹œì‘</button>
      </div>
    </div>

    <!-- Step 3: Loading -->
    <div id="pdfStep2" class="pdf-step" style="display:none">
      <div style="text-align:center;padding:48px 20px">
        <div class="pdf-spinner"></div>
        <div style="font-size:15px;font-weight:600;margin-top:20px" id="pdfLoadingMsg">íŒŒì¼ ë¶„ì„ ì¤‘...</div>
        <div style="font-size:13px;color:var(--muted);margin-top:8px">Claude AIê°€ ì—°ë½ì²˜ ì •ë³´ë¥¼ ì¶”ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤</div>
      </div>
    </div>

    <!-- Step 4: Results -->
    <div id="pdfStep3" class="pdf-step" style="display:none">
      <div class="form-section">
        <div class="form-section-title">ì¶”ì¶œëœ ì—°ë½ì²˜ í™•ì¸ ë° ìˆ˜ì •</div>
        <p style="font-size:12px;color:var(--muted);margin-bottom:12px">ë‚´ìš©ì„ í™•ì¸í•˜ê³  í•„ìš”í•˜ë©´ ìˆ˜ì • í›„ ì €ì¥í•˜ì„¸ìš”. ì²´í¬ëœ í•­ëª©ë§Œ CRMì— ì¶”ê°€ë©ë‹ˆë‹¤.</p>
      </div>
      <div id="pdfResults"></div>
      <div class="modal-actions" style="margin-top:16px">
        <button class="btn btn-outline" onclick="pdfRetry()">â† ë‹¤ì‹œ ì—…ë¡œë“œ</button>
        <button class="btn btn-primary" onclick="pdfImportAll()">âœ… ì„ íƒ í•­ëª© ëª¨ë‘ ì €ì¥</button>
      </div>
    </div>

    <!-- Step 5: Error -->
    <div id="pdfStep4" class="pdf-step" style="display:none">
      <div style="text-align:center;padding:40px 20px">
        <div style="font-size:40px;margin-bottom:16px">âš ï¸</div>
        <div style="font-size:15px;font-weight:600;margin-bottom:8px">ë¶„ì„ ì‹¤íŒ¨</div>
        <div id="pdfErrorMsg" style="font-size:13px;color:var(--muted);line-height:1.7"></div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-outline" onclick="pdfRetry()">â† ë‹¤ì‹œ ì‹œë„</button>
        <button class="btn btn-outline" onclick="closeModal('pdfModal')">ë‹«ê¸°</button>
      </div>
    </div>

    <!-- Step 6 (CSV): ì»¬ëŸ¼ ë§¤í•‘ -->
    <div id="pdfStep5" class="pdf-step" style="display:none">
      <div class="form-section">
        <div class="form-section-title">ğŸ“Š CSV ì»¬ëŸ¼ ë§¤í•‘ í™•ì¸</div>
        <p style="font-size:12px;color:var(--muted);margin-bottom:10px">ìë™ìœ¼ë¡œ ê°ì§€ëœ ë§¤í•‘ì…ë‹ˆë‹¤. í•„ìš”í•˜ë©´ ë“œë¡­ë‹¤ìš´ìœ¼ë¡œ ë³€ê²½í•˜ì„¸ìš”.</p>
        <div id="csvMappingArea" style="overflow:auto;max-height:300px"></div>
        <div id="csvPreviewInfo" style="font-size:12px;color:var(--muted);margin-top:8px"></div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-outline" onclick="pdfShowStep(1)">â† ë‹¤ì‹œ ì„ íƒ</button>
        <button class="btn btn-primary" onclick="csvImport()">âœ… ì´ ì„¤ì •ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°</button>
      </div>
    </div>

    <!-- Step 7 (CSV): ì§„í–‰ ì¤‘ -->
    <div id="pdfStep6" class="pdf-step" style="display:none">
      <div style="text-align:center;padding:48px 20px">
        <div class="pdf-spinner"></div>
        <div style="font-size:15px;font-weight:600;margin-top:20px" id="csvProgressMsg">ê°€ì ¸ì˜¤ëŠ” ì¤‘...</div>
        <div style="margin:16px auto;max-width:320px;background:var(--surface2);border-radius:8px;overflow:hidden;height:10px">
          <div id="csvProgressBar" style="height:10px;background:var(--accent3);width:0%;transition:width 0.15s;border-radius:8px"></div>
        </div>
        <div id="csvProgressSub" style="font-size:12px;color:var(--muted);margin-top:6px"></div>
      </div>
    </div>

    <!-- Step 8 (CSV): ì™„ë£Œ -->
    <div id="pdfStep7" class="pdf-step" style="display:none">
      <div style="text-align:center;padding:44px 20px">
        <div style="font-size:52px;margin-bottom:14px">âœ…</div>
        <div style="font-size:17px;font-weight:700;margin-bottom:10px" id="csvDoneMsg"></div>
        <div id="csvDoneSub" style="font-size:13px;color:var(--muted);line-height:1.9"></div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-outline" onclick="pdfShowStep(1)">ì¶”ê°€ íŒŒì¼ ê°€ì ¸ì˜¤ê¸°</button>
        <button class="btn btn-primary" onclick="closeModal('pdfModal')">ë‹«ê¸°</button>
      </div>
    </div>

  </div>
</div>


<script>
// â”€â”€ DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let contacts  = JSON.parse(localStorage.getItem('crm_contacts')  || '[]');
let activities= JSON.parse(localStorage.getItem('crm_activities')|| '[]');
let companies = JSON.parse(localStorage.getItem('crm_companies') || '{}');

// â”€â”€ SUPABASE ì—°ë™ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let sbUrl   = localStorage.getItem('crm_sb_url')   || '';
let sbKey   = localStorage.getItem('crm_sb_key')   || '';
let sbSyncing    = false;
let sbPendingSave= false;
let sbLastSync   = localStorage.getItem('crm_sb_last_sync') || '';

function sbIsConnected(){ return !!(sbUrl && sbKey); }

function sbHeaders(){
  return {
    'Content-Type':  'application/json',
    'apikey':        sbKey,
    'Authorization': 'Bearer ' + sbKey,
    'Prefer':        'return=minimal'
  };
}

// ìƒíƒœ í‘œì‹œ
function sbUpdateStatus(state, msg){
  const el = document.getElementById('gsSyncStatus');
  if(!el) return;
  const icons  = {ok:'âœ…', syncing:'ğŸ”„', error:'âš ï¸', offline:'ğŸ’¾'};
  const colors = {ok:'var(--accent3)', syncing:'var(--accent4)', error:'var(--accent2)', offline:'var(--muted)'};
  el.innerHTML = `<span style="color:${colors[state]}">${icons[state]} ${msg}</span>`;
}

// â”€â”€ í…Œì´ë¸” upsert í—¬í¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sbUpsert(table, rows){
  if(!rows.length) return;
  const CHUNK = 500; // ì•ˆì „í•˜ê²Œ 500ìœ¼ë¡œ ë‚®ì¶¤
  for(let i=0; i<rows.length; i+=CHUNK){
    const chunk = rows.slice(i, i+CHUNK);
    const res = await fetch(`${sbUrl}/rest/v1/${table}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'apikey': sbKey,
        'Authorization': 'Bearer ' + sbKey,
        'Prefer': 'resolution=merge-duplicates,return=minimal'
      },
      body: JSON.stringify(chunk)
    });
    if(!res.ok){
      const err = await res.text();
      throw new Error(`[${table}] ì €ì¥ ì‹¤íŒ¨ (${res.status}): ${err}`);
    }
  }
}

// â”€â”€ í…Œì´ë¸” ì „ì²´ ì‚­ì œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sbDeleteAll(table){
  // id ì»¬ëŸ¼ì´ textì¸ ê²½ìš°: neq.(ë¹ˆë¬¸ìì—´)ë¡œ ì „ì²´ ì‚­ì œ
  const res = await fetch(`${sbUrl}/rest/v1/${table}?id=neq.`, {
    method: 'DELETE',
    headers: {
      'apikey': sbKey,
      'Authorization': 'Bearer ' + sbKey,
      'Prefer': 'return=minimal'
    }
  });
  // 204 ë˜ëŠ” 200ì´ë©´ ì„±ê³µ, 404ëŠ” í…Œì´ë¸” ë¹„ì–´ìˆìŒ(ë¬´ì‹œ)
  if(!res.ok && res.status !== 404){
    const txt = await res.text();
    console.warn(`[${table}] ì‚­ì œ ê²½ê³  (${res.status}):`, txt);
  }
}

// â”€â”€ ì „ì²´ ë¶ˆëŸ¬ì˜¤ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sbLoad(){
  if(!sbIsConnected()) return;
  sbUpdateStatus('syncing','ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
  try {
    // ì—°ë½ì²˜ì™€ í™œë™ ê°€ì ¸ì˜¤ê¸° (ìˆœì°¨ì ìœ¼ë¡œ â€” ì˜¤ë¥˜ ìœ„ì¹˜ íŒŒì•… ì‰½ê²Œ)
    const rC = await fetch(
      `${sbUrl}/rest/v1/contacts?select=*&order=created_at.asc&limit=100000`,
      { headers: { 'apikey': sbKey, 'Authorization': 'Bearer ' + sbKey } }
    );
    if(!rC.ok){
      const txt = await rC.text();
      throw new Error(`ì—°ë½ì²˜ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨ (${rC.status}): ${txt}`);
    }
    const dbContacts = await rC.json();

    const rA = await fetch(
      `${sbUrl}/rest/v1/activities?select=*&order=date.desc&limit=2000000`,
      { headers: { 'apikey': sbKey, 'Authorization': 'Bearer ' + sbKey } }
    );
    if(!rA.ok){
      const txt = await rA.text();
      throw new Error(`í™œë™ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨ (${rA.status}): ${txt}`);
    }
    const dbActivities = await rA.json();

    const rCo = await fetch(
      `${sbUrl}/rest/v1/companies?select=*&limit=50000`,
      { headers: { 'apikey': sbKey, 'Authorization': 'Bearer ' + sbKey } }
    );
    const dbCompanies = rCo.ok ? await rCo.json() : [];

    const rT = await fetch(
      `${sbUrl}/rest/v1/types?select=*&limit=100`,
      { headers: { 'apikey': sbKey, 'Authorization': 'Bearer ' + sbKey } }
    );
    const dbTypes = rT.ok ? await rT.json() : [];

    console.log(`[sbLoad] contacts:${dbContacts.length} activities:${dbActivities.length} companies:${dbCompanies.length}`);

    // DB â†’ CRM í˜•ì‹ ë³€í™˜ (ë¹ˆ ë°°ì—´ì´ì–´ë„ ë®ì–´ì”€ â€” ë‹¤ë¥¸ ê¸°ê¸° ì‚­ì œ ë°˜ì˜)
    contacts   = Array.isArray(dbContacts)   ? dbContacts.map(sbRowToContact)   : contacts;
    activities = Array.isArray(dbActivities) ? dbActivities.map(sbRowToActivity): activities;

    if(Array.isArray(dbCompanies) && dbCompanies.length){
      companies = {};
      dbCompanies.forEach(r=>{
        try{ companies[r.name] = JSON.parse(r.data||'{}'); }catch(e){}
      });
    }

    if(Array.isArray(dbTypes) && dbTypes.length){
      try{
        const parsed = JSON.parse(dbTypes[0].data);
        if(Array.isArray(parsed) && parsed.length){
          actTypes = parsed;
          localStorage.setItem('crm_types', JSON.stringify(actTypes));
          rebuildTypeMaps(); injectTypeStyles(); refreshTypeSelect(); refreshFilterBar();
        }
      }catch(e){ console.warn('[sbLoad] types íŒŒì‹± ì˜¤ë¥˜:', e); }
    }

    localPersist();
    sbLastSync = new Date().toLocaleString('ko-KR');
    localStorage.setItem('crm_sb_last_sync', sbLastSync);
    sbUpdateStatus('ok', 'ë™ê¸°í™” ì™„ë£Œ Â· ' + sbLastSync);
    renderStats(); renderContacts(); refreshTeamFilterBars();

  } catch(err){
    console.error('[sbLoad] ì˜¤ë¥˜:', err);
    sbUpdateStatus('error', err.message);
  }
}

// â”€â”€ ì „ì²´ ì €ì¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sbSave(){
  if(!sbIsConnected()){ localPersist(); return; }
  if(sbSyncing){ sbPendingSave = true; return; }
  sbSyncing = true;
  sbUpdateStatus('syncing','ì €ì¥ ì¤‘...');
  localPersist();

  try {
    // contacts: ì „ì²´ ì‚­ì œ í›„ ì¬ì‚½ì… (ë³€ê²½/ì‚­ì œ ì™„ë²½ ë°˜ì˜)
    await sbDeleteAll('contacts');
    if(contacts.length) await sbUpsert('contacts', contacts.map(contactToSbRow));

    // activities: ì „ì²´ ì‚­ì œ í›„ ì¬ì‚½ì…
    await sbDeleteAll('activities');
    if(activities.length) await sbUpsert('activities', activities.map(activityToSbRow));

    // companies
    const coRows = Object.entries(companies).map(([name,data])=>({name, data:JSON.stringify(data)}));
    if(coRows.length){
      await sbDeleteAll('companies');
      await sbUpsert('companies', coRows);
    }

    // types (id=1 ê³ ì • í–‰)
    await fetch(`${sbUrl}/rest/v1/types?id=eq.1`, {
      method:'DELETE',
      headers:{ 'apikey':sbKey, 'Authorization':'Bearer '+sbKey, 'Prefer':'return=minimal' }
    });
    await fetch(`${sbUrl}/rest/v1/types`, {
      method:'POST',
      headers:{ 'Content-Type':'application/json', 'apikey':sbKey, 'Authorization':'Bearer '+sbKey, 'Prefer':'return=minimal' },
      body: JSON.stringify([{id:1, data:JSON.stringify(actTypes)}])
    });

    sbLastSync = new Date().toLocaleString('ko-KR');
    localStorage.setItem('crm_sb_last_sync', sbLastSync);
    sbUpdateStatus('ok', 'ì €ì¥ë¨ Â· ' + sbLastSync);
    console.log(`[sbSave] ì™„ë£Œ â€” contacts:${contacts.length} activities:${activities.length}`);

  } catch(err){
    console.error('[sbSave] ì˜¤ë¥˜:', err);
    sbUpdateStatus('error', 'ì €ì¥ ì‹¤íŒ¨ (ë¡œì»¬ ë°±ì—…ë¨): ' + err.message);
  } finally {
    sbSyncing = false;
    if(sbPendingSave){ sbPendingSave=false; sbSave(); }
  }
}

// â”€â”€ ë°ì´í„° ë³€í™˜ í—¬í¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function contactToSbRow(c){
  return {
    id: c.id, company: c.company||'', dept: c.dept||'',
    position: c.position||'', last: c.last||'', first: c.first||'',
    email: c.email||'', office: c.office||'', mobile: c.mobile||'',
    extra: c.extra||'', address: c.address||'', memo: c.memo||'',
    created_at: c.createdAt || new Date().toISOString()
  };
}
function sbRowToContact(r){
  return {
    id: r.id, company: r.company, dept: r.dept, position: r.position,
    last: r.last, first: r.first, email: r.email, office: r.office,
    mobile: r.mobile, extra: r.extra, address: r.address, memo: r.memo,
    createdAt: r.created_at
  };
}
function activityToSbRow(a){
  return {
    id: a.id, contact_id: a.contactId, type: a.type||'other',
    date: a.date||'', title: a.title||'', content: a.content||'',
    amount: a.amount||'', created_at: a.createdAt||new Date().toISOString()
  };
}
function sbRowToActivity(r){
  return {
    id: r.id, contactId: r.contact_id, type: r.type,
    date: r.date, title: r.title, content: r.content,
    amount: r.amount, createdAt: r.created_at
  };
}

// â”€â”€ ë¡œì»¬ ì €ì¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function localPersist(){
  localStorage.setItem('crm_contacts',  JSON.stringify(contacts));
  localStorage.setItem('crm_activities',JSON.stringify(activities));
  localStorage.setItem('crm_companies', JSON.stringify(companies));
}

function persist(){
  localPersist();
  renderStats();
  refreshTeamFilterBars();
  if(sbIsConnected()) sbSave();
}

let editCid = null;       // editing contact id
let editCoName = null;    // editing company name
let actCid = null;        // activity target contact id
let currentCid = null;    // currently viewed contact

let viewMode = 'group';
let expanded = new Set();

// â”€â”€ í™œë™ ìœ í˜• (ì‚¬ìš©ì ì •ì˜ ê°€ëŠ¥) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEFAULT_TYPES = [
  {id:'order', label:'ë°œì£¼', emoji:'ğŸ“¦', color:'#43e97b'},
  {id:'quote', label:'ê²¬ì ', emoji:'ğŸ“„', color:'#f7971e'},
  {id:'visit', label:'ë°©ë¬¸', emoji:'ğŸ¤', color:'#ff6b6b'},
  {id:'call',  label:'í†µí™”', emoji:'ğŸ“', color:'#4f7cff'},
  {id:'other', label:'ê¸°íƒ€', emoji:'ğŸ“Œ', color:'#7986cb'},
];

function loadTypes(){
  try { return JSON.parse(localStorage.getItem('crm_types')) || DEFAULT_TYPES; }
  catch(e){ return DEFAULT_TYPES; }
}
function saveTypes(types){ localStorage.setItem('crm_types',JSON.stringify(types)); }

let actTypes = loadTypes();

function buildTypeMaps(){
  const TL={}, TE={}, TB={}, TD={};
  actTypes.forEach(t=>{
    TL[t.id] = t.label;
    TE[t.id] = t.emoji;
    TB[t.id] = 'badge-type-'+t.id;
    TD[t.id] = 'dot-type-'+t.id;
  });
  return {TL,TE,TB,TD};
}
let {TL,TE,TB,TD} = buildTypeMaps();

function rebuildTypeMaps(){
  const maps = buildTypeMaps();
  Object.assign(TL, maps.TL); Object.keys(TL).forEach(k=>{ if(!maps.TL[k]) delete TL[k]; });
  Object.assign(TE, maps.TE); Object.keys(TE).forEach(k=>{ if(!maps.TE[k]) delete TE[k]; });
  Object.assign(TB, maps.TB); Object.keys(TB).forEach(k=>{ if(!maps.TB[k]) delete TB[k]; });
  Object.assign(TD, maps.TD); Object.keys(TD).forEach(k=>{ if(!maps.TD[k]) delete TD[k]; });
}

function injectTypeStyles(){
  let s = document.getElementById('dynamicTypeStyles');
  if(!s){ s=document.createElement('style'); s.id='dynamicTypeStyles'; document.head.appendChild(s); }
  s.textContent = actTypes.map(t=>{
    const hex = t.color||'#7986cb';
    const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16);
    return `.badge-type-${t.id}{background:rgba(${r},${g},${b},0.15);color:${hex}}
.dot-type-${t.id}{background:rgba(${r},${g},${b},0.15);color:${hex};border:1px solid ${hex}}`;
  }).join('\n');
}

function uid() { return Date.now().toString(36)+Math.random().toString(36).slice(2); }
function esc(s){ return (s||'').replace(/\\/g,'\\\\').replace(/'/g,"\\'"); }
function ac(s){ // avatar color
  const c=['#4f7cff','#ff6b6b','#43e97b','#f7971e','#a855f7','#06b6d4','#f43f5e','#84cc16'];
  let h=0; for(let ch of (s||''))h=(h*31+ch.charCodeAt(0))%c.length; return c[h];
}
function fmtMoney(s){ return Number((s||'').toString().replace(/[^0-9]/g,'')||0).toLocaleString(); }

// â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function nav(p){
  document.getElementById('contactsView').style.display   = p==='contacts'   ? '' : 'none';
  document.getElementById('activitiesView').style.display = p==='activities' ? '' : 'none';
  document.getElementById('detailView').classList.remove('open');
  // PC ì‚¬ì´ë“œë°”
  document.getElementById('navContacts').classList.toggle('active', p==='contacts');
  document.getElementById('navActivities').classList.toggle('active', p==='activities');
  // ëª¨ë°”ì¼ íƒ­ë°”
  document.getElementById('mTabContacts').classList.toggle('active', p==='contacts');
  document.getElementById('mTabActivities').classList.toggle('active', p==='activities');
  // ì—°ë½ì²˜ íƒ­ì¼ ë•Œë§Œ ê²€ìƒ‰/ë·°í† ê¸€ topbar í‘œì‹œ
  const topbar = document.getElementById('mainTopbar');
  if(topbar) topbar.style.display = p==='contacts' ? '' : 'none';

  currentCid = null;
  if(p==='contacts')   renderContacts();
  if(p==='activities') renderAllActs();
}
function backToList(){
  document.getElementById('detailView').classList.remove('open');
  document.getElementById('contactsView').style.display='';
  currentCid=null; renderContacts();
}
function setViewMode(m){
  viewMode=m;
  document.querySelectorAll('.toggle-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('vBtn-'+m).classList.add('active');
  renderContacts();
}
// â”€â”€ í•„í„° ìƒíƒœ (Set ê¸°ë°˜ ë‹¤ì¤‘ì„ íƒ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let actFilter    = new Set(); // í™œë™ ìœ í˜• í•„í„° (ë¹ˆ Set = ì „ì²´)
let teamFilter   = new Set(); // ì—°ë½ì²˜ íŒ€ í•„í„°
let actTeamFilter= new Set(); // í™œë™ íŒ€ í•„í„°

// Set í•„í„° í† ê¸€ í—¬í¼
function toggleFilter(set, val){
  if(val==='all'){ set.clear(); return; }
  if(set.has(val)) set.delete(val);
  else set.add(val);
}
// Set í•„í„° ì ìš© í—¬í¼: arrì„ í•„í„°ë§ (ë¹ˆ Set = ì „ì²´)
function applySetFilter(arr, set, keyFn){
  if(!set.size) return arr;
  return arr.filter(item => set.has(keyFn(item)));
}
// ì¹© active ë™ê¸°í™”
function syncChips(barSelector, set){
  document.querySelectorAll(barSelector+' .filter-chip').forEach(b=>{
    const v = b.dataset.val;
    if(v==='all') b.classList.toggle('active', set.size===0);
    else          b.classList.toggle('active', set.has(v));
  });
}

// íŒ€ ëª©ë¡ ì¶”ì¶œ (companiesì—ì„œ ourTeam ê°’ë“¤)
function getTeamList(){
  return [...new Set(
    Object.values(companies)
      .map(c=>c.ourTeam||'')
      .filter(Boolean)
  )].sort();
}

// íŒ€ í•„í„°ê°€ ì ìš©ë  íšŒì‚¬ ëª©ë¡ ë°˜í™˜
function getCosByTeam(teamSet){
  if(!teamSet || !teamSet.size) return null;
  return Object.entries(companies)
    .filter(([,ci])=>teamSet.has(ci.ourTeam||''))
    .map(([name])=>name);
}

function setActFilter(f, btn){
  toggleFilter(actFilter, f);
  syncChips('#actFilterBar', actFilter);
  renderAllActs();
}

function setTeamFilter(f, btn){
  toggleFilter(teamFilter, f);
  syncChips('#teamFilterBar', teamFilter);
  renderContacts();
}

function setActTeamFilter(f, btn){
  toggleFilter(actTeamFilter, f);
  syncChips('#actTeamFilterBar', actTeamFilter);
  renderAllActs();
}

function refreshTeamFilterBars(){
  const teams = getTeamList();
  const makeChips = (barId, set, fnName) => {
    const bar = document.getElementById(barId);
    if(!bar) return;
    if(!teams.length){
      bar.style.display='';
      bar.innerHTML = `<span style="font-size:11px;color:var(--muted);padding:2px 6px">íŒ€ ë¯¸ë“±ë¡ â€” íšŒì‚¬ ìˆ˜ì •ì—ì„œ ìš°ë¦¬ íŒ€ ë‹´ë‹¹ìë¥¼ ì…ë ¥í•˜ë©´ í•„í„°ê°€ ìƒê¹ë‹ˆë‹¤</span>`;
      return;
    }
    bar.style.display='';
    bar.innerHTML = `<span style="font-size:10px;color:var(--muted);font-family:'IBM Plex Mono',monospace;align-self:center;margin-right:4px;white-space:nowrap">ğŸ‘¥ íŒ€</span>`
      + `<button class="filter-chip${set.size===0?' active':''}" data-val="all" onclick="${fnName}('all',this)">ì „ì²´</button>`
      + teams.map(t=>`<button class="filter-chip${set.has(t)?' active':''}" data-val="${t.replace(/"/g,'&quot;')}" onclick="${fnName}('${t.replace(/'/g,"\\'")}',this)">ğŸ‘¥ ${t}</button>`).join('');
  };
  makeChips('teamFilterBar',    teamFilter,    'setTeamFilter');
  makeChips('actTeamFilterBar', actTeamFilter, 'setActTeamFilter');
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function coActivities(coName){
  const ids = contacts.filter(c=>(c.company||'').trim()===coName).map(c=>c.id);
  return activities.filter(a=>ids.includes(a.contactId)).sort((a,b)=>b.date.localeCompare(a.date));
}
function contactActivities(cid){ return activities.filter(a=>a.contactId===cid).sort((a,b)=>b.date.localeCompare(a.date)); }

// â”€â”€ RENDER CONTACTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderContacts(){
  const q = document.getElementById('searchInput').value.toLowerCase();
  let list = contacts.filter(c=>{
    const s=(c.company+c.last+c.first+c.email+c.mobile+c.office).toLowerCase();
    return s.includes(q);
  });
  // íŒ€ í•„í„° (ë‹¤ì¤‘ì„ íƒ)
  if(teamFilter.size){
    const cos = getCosByTeam(teamFilter);
    if(cos) list = list.filter(c => cos.includes(c.company||''));
  }
  document.getElementById('viewSub').textContent = `ì´ ${list.length}ëª…`;
  if(viewMode==='list')  { renderFlatList(list); return; }
  if(viewMode==='glist') { renderGroupList(list); return; }
  renderGroupView(list);
}

function renderGroupView(list){
  const groups={};
  for(const c of list){ const k=(c.company||'').trim()||'__none__'; (groups[k]=groups[k]||[]).push(c); }
  const named = Object.keys(groups).filter(k=>k!=='__none__').sort();
  const none  = groups['__none__']||[];
  let html='';

  for(const co of named){
    const members = groups[co];
    const ci = companies[co]||{};
    const coActs = coActivities(co);
    const types = actTypes.map(t=>t.id).filter(id=>coActs.some(a=>a.type===id));
    const isExp = expanded.has(co);
    const col = ac(co);
    const preview = coActs.slice(0,5);

    html+=`
    <div class="company-group${isExp?'':' collapsed'}" id="cg-${CSS.escape(co)}">
      <div class="company-header" onclick="toggleCo('${esc(co)}')">
        <div class="company-logo" style="background:linear-gradient(135deg,${col},${col}bb)">${co[0]}</div>
        <div class="company-info">
          <div class="company-name">${co}</div>
          <div class="company-meta">
            <span>ğŸ‘¤ ${members.length}ëª…</span>
            ${ci.phone?`<span>â˜ ${ci.phone}</span>`:''}
            ${coActs.length?`<span>ğŸ“‹ ${coActs.length}ê±´</span>`:''}
          </div>
        </div>
        <div class="company-badges">${types.map(t=>`<span class="activity-badge ${TB[t]}">${TE[t]} ${coActs.filter(a=>a.type===t).length}</span>`).join('')}</div>
        <span class="company-toggle">â–¾</span>
      </div>
      <div class="company-body">
        <!-- shared bar -->
        <div class="shared-bar">
          <span class="shared-tag">ê³µí†µ</span>
          ${ci.phone?`<span>â˜ ${ci.phone}</span>`:'<span style="opacity:.4">ëŒ€í‘œì „í™” ì—†ìŒ</span>'}
          ${ci.fax?`<span>ğŸ“  ${ci.fax}</span>`:''}
          ${ci.address?`<span>ğŸ“ ${ci.address}</span>`:'<span style="opacity:.4">ì£¼ì†Œ ì—†ìŒ</span>'}
          ${ci.ourName?`<span style="color:var(--accent3)">ğŸ‘¤ ë‹´ë‹¹ ${ci.ourTeam?ci.ourTeam+' ':''}<strong>${ci.ourName}</strong></span>`:''}
          <button class="shared-edit-btn" onclick="openCompanyModal('${esc(co)}')">âœ ìˆ˜ì •</button>
        </div>
        <!-- ì¬ë¬´ ìš”ì•½ (1ì¤„ + í¼ì¹˜ê¸°) -->
        ${(()=>{
          const fin=(ci.finance||[]).slice().sort((a,b)=>Number(b.year)-Number(a.year));
          if(!fin.length) return '';
          const r=fin[0];
          const fmtFin=v=>v?(Number(v.toString().replace(/[^0-9.-]/g,''))||0).toLocaleString()+'M':'â€”';
          const profitVal=Number((r.net_profit||'').toString().replace(/[^0-9.-]/g,'')||0);
          const coId=CSS.escape(co);
          const chips=[
            r.headcount?`<div class="fin-chip"><span class="fin-chip-label">ì¸ì›</span><span class="fin-chip-value neu">${r.headcount}ëª…</span></div>`:'',
            r.revenue?`<div class="fin-chip"><span class="fin-chip-label">ë§¤ì¶œ</span><span class="fin-chip-value neu">${fmtFin(r.revenue)}</span></div>`:'',
            r.op_profit?`<div class="fin-chip"><span class="fin-chip-label">ì˜ì—…ì´ìµ</span><span class="fin-chip-value ${Number((r.op_profit||'').toString().replace(/[^0-9.-]/g,''))||0>=0?'pos':'neg'}">${fmtFin(r.op_profit)}</span></div>`:'',
            r.net_profit?`<div class="fin-chip"><span class="fin-chip-label">ìˆœì´ìµ</span><span class="fin-chip-value ${profitVal>=0?'pos':'neg'}">${fmtFin(r.net_profit)}</span></div>`:'',
            r.assets?`<div class="fin-chip"><span class="fin-chip-label">ìì‚°</span><span class="fin-chip-value neu">${fmtFin(r.assets)}</span></div>`:'',
            r.liabilities?`<div class="fin-chip"><span class="fin-chip-label">ë¶€ì±„</span><span class="fin-chip-value neg">${fmtFin(r.liabilities)}</span></div>`:'',
          ].filter(Boolean).join('');
          const allRows=fin.map(yr=>{
            const fv=v=>v?(Number(v.toString().replace(/[^0-9.-]/g,''))||0).toLocaleString():'â€”';
            return `<tr>
              <td>${yr.year}</td>
              <td>${yr.headcount?yr.headcount+'ëª…':'â€”'}</td>
              <td>${fv(yr.revenue)}</td>
              <td class="${Number((yr.op_profit||'').toString().replace(/[^0-9.-]/g,'')||0)>=0?'pos':'neg'}">${fv(yr.op_profit)}</td>
              <td class="${Number((yr.net_profit||'').toString().replace(/[^0-9.-]/g,'')||0)>=0?'pos':'neg'}">${fv(yr.net_profit)}</td>
              <td>${fv(yr.assets)}</td>
              <td>${fv(yr.liabilities)}</td>
            </tr>`;
          }).join('');
          return `<div class="fin-summary" id="fin-wrap-${coId}">
            <div class="fin-summary-preview" onclick="toggleFinDetail('${coId}')">
              <span style="font-size:10px;color:var(--muted);font-family:'IBM Plex Mono',monospace;padding-right:10px;border-right:1px solid var(--border);flex-shrink:0">${r.year}ë…„</span>
              ${chips}
            </div>
            ${fin.length>1?`<button class="fin-expand-btn" id="fin-btn-${coId}" onclick="toggleFinDetail('${coId}')">ì „ì²´ ${fin.length}ë…„ â–¾</button>`:''}
          </div>
          <div class="fin-detail" id="fin-detail-${coId}">
            <table class="fin-table">
              <thead><tr><th>ì—°ë„</th><th>ì¸ì›</th><th>ë§¤ì¶œ(M)</th><th>ì˜ì—…ì´ìµ</th><th>ìˆœì´ìµ</th><th>ìì‚°</th><th>ë¶€ì±„</th></tr></thead>
              <tbody>${allRows}</tbody>
            </table>
          </div>`;
        })()}
        <!-- ëŒ€í‘œì´ì‚¬ (1ì¤„ + í¼ì¹˜ê¸°) -->
        ${(()=>{
          const ceos=(ci.ceoHistory||[]).slice().sort((a,b)=>{
            const ya=Number((a.from||'0').toString().replace(/[^0-9]/g,''));
            const yb=Number((b.from||'0').toString().replace(/[^0-9]/g,''));
            return yb-ya;
          });
          if(!ceos.length) return '';
          const cur=ceos.find(ceo=>!ceo.to||ceo.to==='í˜„ì¬')||ceos[0];
          const coId=CSS.escape(co);
          const allRows=ceos.map(ceo=>`<div class="ceo-row-item">
            <span class="ceo-row-name">${ceo.name}</span>
            <span class="ceo-row-period">${ceo.from||''}${ceo.from&&(ceo.to||'í˜„ì¬')?' ~ '+(ceo.to||'í˜„ì¬'):ceo.to?'~ '+ceo.to:''}</span>
            ${ceo.memo?`<span class="ceo-row-memo">${ceo.memo}</span>`:''}
          </div>`).join('');
          return `<div class="ceo-bar" onclick="toggleCeoDetail('${coId}')">
            <span>ğŸ‘” ëŒ€í‘œì´ì‚¬</span>
            <span class="ceo-bar-name">${cur.name}</span>
            ${cur.from?`<span style="font-size:11px;font-family:'IBM Plex Mono',monospace;color:var(--accent)">${cur.from} ~ ${cur.to&&cur.to!=='í˜„ì¬'?cur.to:'í˜„ì¬'}</span>`:''}
            <span style="margin-left:auto;font-size:10px;color:var(--muted)">${ceos.length>1?`ì´ ${ceos.length}ëª… `:''} â–¾</span>
          </div>
          <div class="ceo-detail" id="ceo-detail-${coId}">
            ${allRows}
          </div>`;
        })()}
        <!-- members -->
        <div class="members-row">
          ${members.map(c=>personCard(c)).join('')}
          <button class="add-card" onclick="openAddContact('${esc(co)}')">ï¼‹ ë‹´ë‹¹ì ì¶”ê°€</button>
        </div>
        <!-- timeline -->
        <div class="co-timeline-section">
          <div class="co-timeline-head">
            <span class="co-timeline-label">ğŸ“‹ íšŒì‚¬ ì „ì²´ í™œë™ (${coActs.length}ê±´)</span>
            <button class="btn btn-primary btn-xs" onclick="openActModal_co('${esc(co)}')">ï¼‹ ì¶”ê°€</button>
          </div>
          ${coActs.length===0
            ? `<div style="font-size:12px;color:var(--muted);text-align:center;padding:12px">í™œë™ ì—†ìŒ</div>`
            : `<div class="acts-filter" id="coActsFilter-${CSS.escape(co)}"></div>
               <div id="tl-${CSS.escape(co)}"></div>`
          }
        </div>
      </div>
    </div>`;
  }

  if(none.length){
    html+=`<div style="margin-top:16px">
      <div class="ungrouped-label">â”€â”€ íšŒì‚¬ ë¯¸ì§€ì • (${none.length}ëª…)</div>
      <div class="ungrouped-grid">${none.map(c=>personCard(c,true)).join('')}</div>
    </div>`;
  }

  if(!named.length&&!none.length) html=`<div class="empty-state"><div class="empty-icon">ğŸ‘¥</div><p>ì—°ë½ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>`;
  document.getElementById('mainGrid').innerHTML=html;

  // íšŒì‚¬ë³„ í™œë™ í•„í„° ì´ˆê¸°í™”
  named.forEach(co=>{
    const filterBar = document.getElementById('coActsFilter-'+CSS.escape(co));
    if(!filterBar) return;
    const allActs = coActivities(co);
    if(!allActs.length) return;
    filterBar.innerHTML =
      `<button class="filter-chip active" data-val="all" onclick="setCoActFilter('${esc(co)}',this,'all')">ì „ì²´</button>`
      + actTypes.map(t=>{
          const cnt = allActs.filter(a=>a.type===t.id).length;
          return cnt ? `<button class="filter-chip" data-val="${t.id}" onclick="setCoActFilter('${esc(co)}',this,'${t.id}')">${t.emoji} ${t.label}</button>` : '';
        }).join('');
    if(!_coActFilters[co]) _coActFilters[co] = new Set();
    _renderCoActs(co);
  });
}

const _coActFilters = {}; // co â†’ Set
function setCoActFilter(co, btn, f){
  if(!_coActFilters[co]) _coActFilters[co] = new Set();
  toggleFilter(_coActFilters[co], f);
  const filterBar = document.getElementById('coActsFilter-'+CSS.escape(co));
  if(filterBar) filterBar.querySelectorAll('.filter-chip').forEach(b=>{
    const v = b.dataset.val || b.getAttribute('onclick')?.match(/'([^']+)',this\)$/)?.[1] || '';
    if(v==='all') b.classList.toggle('active', _coActFilters[co].size===0);
    else b.classList.toggle('active', _coActFilters[co].has(v));
  });
  _renderCoActs(co);
}
function _renderCoActs(co){
  const tl = document.getElementById('tl-'+CSS.escape(co));
  if(!tl) return;
  const set = _coActFilters[co] || new Set();
  const all = coActivities(co);
  const filtered = set.size===0 ? all : all.filter(a=>set.has(a.type));
  tl.innerHTML = filtered.length===0
    ? `<div style="font-size:12px;color:var(--muted);text-align:center;padding:12px">í•´ë‹¹ ìœ í˜•ì˜ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.</div>`
    : `<div class="timeline">${filtered.map(a=>tlItem(a,{showWho:true})).join('')}</div>`;
}

function personCard(c, standalone=false){
  const acts=activities.filter(a=>a.contactId===c.id);
  const types=actTypes.map(t=>t.id).filter(id=>acts.some(a=>a.type===id));
  const init=(c.last||c.first||'?')[0];
  const bg=ac(c.last+c.first);
  const title=[c.dept,c.position].filter(Boolean).join(' / ');
  return `<div class="person-card" onclick="showDetail('${c.id}')">
    <div class="person-head">
      <div class="avatar" style="background:${bg}">${init}</div>
      <div>
        <div class="person-name">${c.last}${c.first}</div>
        <div class="person-dept">${title||'&mdash;'}</div>
      </div>
    </div>
    <div class="person-contacts">
      ${c.mobile
        ? `<span><span class="pc-label">í•¸ë“œí°</span>${c.mobile}</span>`
        : c.office ? `<span><span class="pc-label">ì§í†µ</span>${c.office}</span>` : ''}
      ${c.email?`<span><span class="pc-label">ì´ë©”ì¼</span>${c.email}</span>`:''}
      ${!c.mobile&&!c.office&&!c.email?`<span style="opacity:.4">ì—°ë½ì²˜ ì—†ìŒ</span>`:''}
    </div>
    ${types.length?`<div class="person-badges">${types.map(t=>`<span class="activity-badge ${TB[t]}">${TE[t]} ${acts.filter(a=>a.type===t).length}</span>`).join('')}</div>`:''}
  </div>`;
}

// â”€â”€ ì ‘ì´ì‹ íƒ€ì„ë¼ì¸ ì•„ì´í…œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function tlItem(a, opts){
  // opts: { showWho, fromDetail }
  opts = opts || {};
  const c = contacts.find(x=>x.id===a.contactId);
  const isAmountType = (a.type==='order'||a.type==='quote');
  const amountBadge  = (isAmountType && a.amount)
    ? `<span class="tl-amount-badge">â‚©${fmtMoney(a.amount)}</span>` : '';
  const whoHtml = opts.showWho && c
    ? `<div class="tl-who" onclick="showDetail('${c.id}')">ğŸ‘¤ ${c.last}${c.first}${c.company?' <span style="color:var(--muted)">Â· '+c.company+'</span>':''}</div>` : '';

  const titlePreview = a.title
    ? `<span class="tl-title-preview">${a.title}</span>` : '';

  return `<div class="timeline-item">
    <div class="timeline-dot ${TD[a.type]||'dot-call'}">${TE[a.type]||'â€¢'}</div>
    <div class="tl-body">
      <div class="tl-summary" onclick="tlToggle(this)">
        <div class="tl-summary-left">
          <span class="tl-type">${TL[a.type]||a.type}</span>
          ${titlePreview}
        </div>
        <div class="tl-summary-right">
          ${amountBadge}
          <span class="tl-date">${a.date}</span>
          <span class="tl-chevron">â–¶</span>
        </div>
      </div>
      <div class="tl-detail">
        ${whoHtml}
        ${a.title?`<div style="font-size:13px;font-weight:600;margin-bottom:4px">${a.title}</div>`:''}
        ${a.content?`<div class="tl-text">${a.content}</div>`:''}
        ${a.amount?`<div class="tl-amount">â‚© ${fmtMoney(a.amount)}</div>`:''}
        <div class="tl-actions">
          <button class="tl-act-btn" onclick="openEditAct('${a.id}')">âœ ìˆ˜ì •</button>
          <button class="tl-act-btn danger" onclick="delAct('${a.id}',${opts.fromDetail?'true':'false'})">ğŸ—‘ ì‚­ì œ</button>
        </div>
      </div>
    </div>
  </div>`;
}

function tlToggle(summaryEl){
  const detail  = summaryEl.nextElementSibling;
  const chevron = summaryEl.querySelector('.tl-chevron');
  const isOpen  = detail.classList.toggle('open');
  if(chevron) chevron.style.transform = isOpen ? 'rotate(90deg)' : '';
}

// â”€â”€ í™œë™ í•„í„° ë Œë” í—¬í¼ (ê°œì¸/íšŒì‚¬ ìƒì„¸ìš©) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderActsFilter(containerId, filterSet, onChangeFn){
  const bar = document.getElementById(containerId);
  if(!bar) return;
  bar.innerHTML =
    `<button class="filter-chip${filterSet.size===0?' active':''}" data-val="all" onclick="${onChangeFn}('all',this)">ì „ì²´</button>`
    + actTypes.map(t=>`<button class="filter-chip${filterSet.has(t.id)?' active':''}" data-val="${t.id}" onclick="${onChangeFn}('${t.id}',this)">${t.emoji} ${t.label}</button>`).join('');
}

// ê°œì¸ ìƒì„¸ í™œë™ í•„í„°
let detailActFilter = new Set();
function setDetailActFilter(f, btn){
  toggleFilter(detailActFilter, f);
  syncChips('#detailActsFilter', detailActFilter);
  if(currentCid) _renderDetailActs(currentCid);
}

// íšŒì‚¬ ìƒì„¸ í™œë™ í•„í„°
let coDetailActFilter = new Set();
function setCoDetailActFilter(f, btn){
  toggleFilter(coDetailActFilter, f);
  syncChips('#coDetailActsFilter', coDetailActFilter);
  _renderCoDetailActs();
}
let _currentCoDetail = '';

function _renderDetailActs(id){
  const allActs = contactActivities(id);
  const filtered = detailActFilter.size===0 ? allActs : allActs.filter(a=>detailActFilter.has(a.type));
  const el = document.getElementById('detailActsList');
  if(!el) return;
  el.innerHTML = filtered.length===0
    ? `<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><p>${detailActFilter.size===0?'ì•„ì§ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.':'í•´ë‹¹ ìœ í˜•ì˜ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.'}</p></div>`
    : `<div class="timeline">${filtered.map(a=>tlItem(a,{fromDetail:true})).join('')}</div>`;
}

function _renderCoDetailActs(){
  const allActs = coActivities(_currentCoDetail);
  const filtered = coDetailActFilter.size===0 ? allActs : allActs.filter(a=>coDetailActFilter.has(a.type));
  const el = document.getElementById('coDetailActsList');
  if(!el) return;
  el.innerHTML = filtered.length===0
    ? `<div class="empty-state" style="padding:20px"><div class="empty-icon">ğŸ“‹</div><p>${coDetailActFilter.size===0?'í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.':'í•´ë‹¹ ìœ í˜•ì˜ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.'}</p></div>`
    : `<div class="timeline">${filtered.map(a=>tlItem(a,{showWho:true})).join('')}</div>`;
}

function showAll(co){
  _renderCoActs(co);
}

function toggleFinDetail(coId){
  const el  = document.getElementById('fin-detail-'+coId);
  const btn = document.getElementById('fin-btn-'+coId);
  if(!el) return;
  const open = el.classList.toggle('open');
  if(btn) btn.textContent = btn.textContent.replace(open?'â–¾':'â–´', open?'â–´':'â–¾');
}
function toggleCeoDetail(coId){
  const el = document.getElementById('ceo-detail-'+coId);
  if(!el) return;
  el.classList.toggle('open');
}
function toggleCo(co){
  const el=document.getElementById('cg-'+CSS.escape(co));
  if(!el) return;
  if(el.classList.contains('collapsed')){ el.classList.remove('collapsed'); expanded.add(co); }
  else { el.classList.add('collapsed'); expanded.delete(co); }
}

// â”€â”€ GROUP LIST VIEW (íšŒì‚¬ë³„ ëª©ë¡) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderGroupList(list){
  const groups={};
  for(const c of list){ const k=(c.company||'').trim()||'__none__'; (groups[k]=groups[k]||[]).push(c); }
  const named=Object.keys(groups).filter(k=>k!=='__none__').sort();
  const none=groups['__none__']||[];
  let html='';

  for(const co of named){
    const members=groups[co];
    const ci=companies[co]||{};
    const coActs=coActivities(co);
    const types=actTypes.map(t=>t.id).filter(id=>coActs.some(a=>a.type===id));
    const isExp=expanded.has(co);
    const col=ac(co);

    html+=`
    <div class="company-group${isExp?'':' collapsed'}" id="cg-${CSS.escape(co)}">
      <div class="company-header" onclick="toggleCo('${esc(co)}')">
        <div class="company-logo" style="background:linear-gradient(135deg,${col},${col}bb)">${co[0]}</div>
        <div class="company-info">
          <div class="company-name">${co}</div>
          <div class="company-meta">
            <span>ğŸ‘¤ ${members.length}ëª…</span>
            ${ci.phone?`<span>â˜ ${ci.phone}</span>`:''}
            ${coActs.length?`<span>ğŸ“‹ ${coActs.length}ê±´</span>`:''}
          </div>
        </div>
        <div class="company-badges">${types.map(t=>`<span class="activity-badge ${TB[t]}">${TE[t]} ${coActs.filter(a=>a.type===t).length}</span>`).join('')}</div>
        <button class="shared-edit-btn" style="margin-right:4px" onclick="event.stopPropagation();openCompanyModal('${esc(co)}')">âœ</button>
        <span class="company-toggle">â–¾</span>
      </div>
      <div class="company-body">
        <div class="shared-bar">
          <span class="shared-tag">ê³µí†µ</span>
          ${ci.phone?`<span>â˜ ${ci.phone}</span>`:'<span style="opacity:.4">ëŒ€í‘œì „í™” ì—†ìŒ</span>'}
          ${ci.fax?`<span>ğŸ“  ${ci.fax}</span>`:''}
          ${ci.address?`<span>ğŸ“ ${ci.address}</span>`:'<span style="opacity:.4">ì£¼ì†Œ ì—†ìŒ</span>'}
          <button class="shared-edit-btn" onclick="openAddContact('${esc(co)}')">ï¼‹ ë‹´ë‹¹ì</button>
        </div>
        <div class="list-wrap" style="margin:0;border-radius:0;border-left:none;border-right:none;border-bottom:none">
          <table class="list-table">
            <thead><tr>
              <th style="width:130px">ì´ë¦„</th>
              <th style="width:160px">ì§í•¨</th>
              <th style="width:150px">í•¸ë“œí°</th>
              <th style="width:150px">ì´ë©”ì¼</th>
              <th style="width:110px">í™œë™</th>
            </tr></thead>
            <tbody>
              ${members.map(c=>personListRow(c)).join('')}
            </tbody>
          </table>
        </div>
      </div>
    </div>`;
  }

  if(none.length){
    html+=`<div style="margin-top:16px">
      <div class="ungrouped-label">â”€â”€ íšŒì‚¬ ë¯¸ì§€ì • (${none.length}ëª…)</div>
      <div class="list-wrap">
        <table class="list-table">
          <thead><tr><th style="width:130px">ì´ë¦„</th><th style="width:160px">ì§í•¨</th><th style="width:150px">í•¸ë“œí°</th><th style="width:150px">ì´ë©”ì¼</th><th style="width:110px">í™œë™</th></tr></thead>
          <tbody>${none.map(c=>personListRow(c)).join('')}</tbody>
        </table>
      </div>
    </div>`;
  }

  if(!named.length&&!none.length) html=`<div class="empty-state"><div class="empty-icon">ğŸ‘¥</div><p>ì—°ë½ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>`;
  document.getElementById('mainGrid').innerHTML=html;
}

// â”€â”€ FLAT LIST VIEW (ì „ì²´ ëª©ë¡) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFlatList(list){
  // sort by company then name
  const sorted=[...list].sort((a,b)=>{
    const ca=(a.company||'ã…¿').localeCompare(b.company||'ã…¿','ko');
    if(ca!==0) return ca;
    return (a.last+a.first).localeCompare(b.last+b.first,'ko');
  });

  if(!sorted.length){
    document.getElementById('mainGrid').innerHTML=`<div class="empty-state"><div class="empty-icon">ğŸ‘¥</div><p>ì—°ë½ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>`;
    return;
  }

  // Group header rows mixed in
  let rows=''; let lastCo=null;
  for(const c of sorted){
    const co=(c.company||'').trim();
    if(co && co!==lastCo){
      const ci=companies[co]||{};
      const cnt=list.filter(x=>x.company===co).length;
      rows+=`<tr class="co-row" onclick="setViewMode('group');setTimeout(()=>{expanded.add('${esc(co)}');const el=document.getElementById('cg-'+CSS.escape('${esc(co)}'));if(el){el.classList.remove('collapsed');el.scrollIntoView({behavior:'smooth',block:'start'});}},80)">
        <td colspan="6" style="padding:9px 16px">
          <div style="display:flex;align-items:center;gap:10px">
            <div style="width:26px;height:26px;border-radius:6px;background:${ac(co)};display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff;flex-shrink:0">${co[0]}</div>
            <span>${co}</span>
            <span style="font-size:11px;color:var(--muted);font-weight:400">${cnt}ëª…${ci.phone?' Â· â˜ '+ci.phone:''}</span>
          </div>
        </td>
      </tr>`;
      lastCo=co;
    }
    rows+=personListRow(c, co?true:false);
  }

  document.getElementById('mainGrid').innerHTML=`
    <div class="list-wrap">
      <table class="list-table">
        <thead><tr>
          <th style="width:130px">ì´ë¦„</th>
          <th style="width:160px">ì§í•¨</th>
          <th style="width:150px">í•¸ë“œí°</th>
          <th style="width:180px">ì´ë©”ì¼</th>
          <th style="width:110px">í™œë™</th>
        </tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;
}

// â”€â”€ PERSON LIST ROW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function personListRow(c, indented=true){
  const acts=activities.filter(a=>a.contactId===c.id);
  const types=actTypes.map(t=>t.id).filter(id=>acts.some(a=>a.type===id));
  const bg=ac(c.last+c.first);
  const init=(c.last||c.first||'?')[0];
  const title=[c.dept,c.position].filter(Boolean).join(' / ')||'â€”';
  // í•¸ë“œí° ì—†ìœ¼ë©´ ì§í†µ í‘œì‹œ
  const phoneVal = c.mobile || c.office || '';
  const emailVal = c.email || '';
  return `<tr onclick="showDetail('${c.id}')" style="cursor:pointer">
    <td style="padding-left:${indented?26:14}px">
      <div style="display:flex;align-items:center;gap:8px">
        <div style="width:28px;height:28px;border-radius:50%;background:${bg};display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;flex-shrink:0">${init}</div>
        <span style="font-weight:500">${c.last}${c.first}</span>
      </div>
    </td>
    <td style="color:var(--muted);font-size:12px">${title}</td>
    <td style="font-family:'IBM Plex Mono',monospace;font-size:12px;color:var(--text)">${phoneVal||'<span style="opacity:.3">â€”</span>'}</td>
    <td style="font-family:'IBM Plex Mono',monospace;font-size:12px;color:var(--text)">${emailVal||'<span style="opacity:.3">â€”</span>'}</td>
    <td>${types.map(t=>`<span class="activity-badge ${TB[t]}">${TE[t]}${acts.filter(a=>a.type===t).length}</span>`).join(' ')||'<span style="color:var(--border);font-size:11px">â€”</span>'}</td>
  </tr>`;
}

// â”€â”€ DETAIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showDetail(id){
  currentCid=id;
  const c=contacts.find(x=>x.id===id);
  if(!c) return;
  const acts=contactActivities(id);
  const bg=ac(c.last+c.first);
  const init=(c.last||c.first||'?')[0];
  const ci=c.company?(companies[c.company]||{}):{};

  const info=[
    {l:'ì´ë©”ì¼',v:c.email||'â€”'},{l:'íœ´ëŒ€í°',v:c.mobile||'â€”'},
    {l:'ì‚¬ë¬´ì‹¤',v:c.office||'â€”'},{l:'ì¶”ê°€ ì—°ë½ì²˜',v:c.extra||'â€”'},
    {l:'ì£¼ì†Œ',v:ci.address||c.address||'â€”'},
  ];

  document.getElementById('detailContent').innerHTML=`
    <div class="detail-header">
      <div class="detail-avatar" style="background:${bg}">${init}</div>
      <div>
        <div class="detail-name">${c.last}${c.first}</div>
        <div class="detail-sub">${c.company||''}${c.dept?' Â· '+c.dept:''}${c.position?' / '+c.position:''}</div>
      </div>
      <div class="detail-actions">
        <button class="btn btn-outline btn-sm" onclick="openEditContact('${id}')">âœ ìˆ˜ì •</button>
        <button class="btn btn-primary btn-sm" onclick="openActModal_contact('${id}')">ï¼‹ í™œë™</button>
        <button class="btn btn-danger btn-sm" onclick="delContact('${id}')">ğŸ—‘</button>
      </div>
    </div>
    <div class="info-grid">
      ${info.map(i=>`<div class="info-card"><div class="info-card-label">${i.l}</div><div class="info-card-value">${i.v}</div></div>`).join('')}
    </div>
    ${c.memo||ci.memo?`<div class="info-card" style="margin-bottom:16px;border:1px solid var(--border);border-radius:9px;padding:14px 16px">
      <div class="info-card-label">ë©”ëª¨</div>
      <div style="font-size:13px;line-height:1.8;color:var(--text);white-space:pre-wrap;margin-top:6px">${c.memo||ci.memo||''}</div>
    </div>`:''}
    <div class="acts-section">
      <div class="acts-head"><span class="acts-title">í™œë™ (${acts.length})</span>
        <button class="btn btn-primary btn-sm" onclick="openActModal_contact('${id}')">ï¼‹ ì¶”ê°€</button>
      </div>
      <div class="acts-filter" id="detailActsFilter"></div>
      <div id="detailActsList"></div>
    </div>`;

  // Company back button
  const coBtn=document.getElementById('detailCoBtn');
  if(c.company){
    coBtn.style.display='';
    coBtn.onclick=()=>{
      backToList();
      setTimeout(()=>{
        expanded.add(c.company);
        const el=document.getElementById('cg-'+CSS.escape(c.company));
        if(el){ el.classList.remove('collapsed'); el.scrollIntoView({behavior:'smooth',block:'start'}); }
      },80);
    };
  } else coBtn.style.display='none';

  // í™œë™ í•„í„° ì´ˆê¸°í™” ë° ë Œë”
  detailActFilter = new Set();
  renderActsFilter('detailActsFilter', detailActFilter, 'setDetailActFilter');
  _renderDetailActs(id);

  document.getElementById('contactsView').style.display='none';
  document.getElementById('detailView').classList.add('open');
}

// â”€â”€ ALL ACTIVITIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAllActs(){
  let allSorted = [...activities].sort((a,b)=>b.date.localeCompare(a.date));
  // ìœ í˜• í•„í„° (ë‹¤ì¤‘ì„ íƒ)
  if(actFilter.size) allSorted = allSorted.filter(a=>actFilter.has(a.type));
  // íŒ€ í•„í„° (ë‹¤ì¤‘ì„ íƒ)
  if(actTeamFilter.size){
    const cos = getCosByTeam(actTeamFilter);
    if(cos){
      const cids = contacts.filter(c=>cos.includes(c.company||'')).map(c=>c.id);
      allSorted = allSorted.filter(a=>cids.includes(a.contactId));
    }
  }
  const acts = allSorted;
  const div = document.getElementById('allActsContent');
  const total = activities.length;

  // ê±´ìˆ˜ í‘œì‹œ
  const subEl = document.getElementById('actsSub');
  if(subEl){
    let desc = actFilter.size===0 ? 'ì „ì²´'
      : [...actFilter].map(f=>TL[f]||f).join('+');
    if(actTeamFilter.size) desc += ` Â· ğŸ‘¥ ${[...actTeamFilter].join('+')}íŒ€`;
    subEl.textContent = `${desc} ${acts.length}ê±´ / ì „ì²´ ${total}ê±´`;
  }

  if(!acts.length){ div.innerHTML=`<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><p>${actFilter.size===0?'í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.':'í•´ë‹¹ ìœ í˜•ì˜ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.'}</p></div>`; return; }
  div.innerHTML=`<div class="timeline">${acts.map(a=>tlItem(a,{showWho:true})).join('')}</div>`;
}

// â”€â”€ CONTACT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function refreshCoSuggestions(){
  const dl=document.getElementById('coSuggestions');
  dl.innerHTML=[...new Set(contacts.map(c=>c.company).filter(Boolean))].map(n=>`<option value="${n}">`).join('');
}
function onCompanyInput(){
  const co=document.getElementById('f_company').value.trim();
  const ci=companies[co];
  const notice=document.getElementById('addrNotice');
  const addrInput=document.getElementById('f_address');
  if(co&&ci&&ci.address){ notice.style.display=''; addrInput.value=ci.address; addrInput.style.borderColor='var(--accent)'; }
  else { notice.style.display='none'; addrInput.style.borderColor=''; }
}

function openAddContact(preCo){
  editCid=null;
  document.getElementById('cModalTitle').textContent='ìƒˆ ì—°ë½ì²˜';
  ['f_dept','f_position','f_last','f_first','f_email','f_office','f_mobile','f_extra','f_address','f_memo']
    .forEach(id=>document.getElementById(id).value='');
  document.getElementById('f_company').value=preCo||'';
  document.getElementById('addrNotice').style.display='none';
  refreshCoSuggestions();
  if(preCo) onCompanyInput();
  document.getElementById('contactModal').classList.add('open');
}
function openEditContact(id){
  editCid=id;
  const c=contacts.find(x=>x.id===id);
  document.getElementById('cModalTitle').textContent='ì—°ë½ì²˜ ìˆ˜ì •';
  document.getElementById('f_company').value=c.company||'';
  document.getElementById('f_dept').value=c.dept||'';
  document.getElementById('f_position').value=c.position||'';
  document.getElementById('f_last').value=c.last||'';
  document.getElementById('f_first').value=c.first||'';
  document.getElementById('f_email').value=c.email||'';
  document.getElementById('f_office').value=c.office||'';
  document.getElementById('f_mobile').value=c.mobile||'';
  document.getElementById('f_extra').value=c.extra||'';
  document.getElementById('f_address').value=c.address||'';
  document.getElementById('f_memo').value=c.memo||'';
  document.getElementById('addrNotice').style.display='none';
  refreshCoSuggestions();
  document.getElementById('contactModal').classList.add('open');
}
function saveContact(){
  const last=document.getElementById('f_last').value.trim();
  const first=document.getElementById('f_first').value.trim();
  if(!last&&!first){ alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  const co=document.getElementById('f_company').value.trim();
  const addr=document.getElementById('f_address').value.trim();
  // Sync address to company info
  if(co&&addr){ if(!companies[co]) companies[co]={}; if(!companies[co].address) companies[co].address=addr; }
  const data={company:co, dept:document.getElementById('f_dept').value.trim(),
    position:document.getElementById('f_position').value.trim(), last, first,
    email:document.getElementById('f_email').value.trim(), office:document.getElementById('f_office').value.trim(),
    mobile:document.getElementById('f_mobile').value.trim(), extra:document.getElementById('f_extra').value.trim(),
    address:addr, memo:document.getElementById('f_memo').value.trim()};
  if(editCid){ const i=contacts.findIndex(x=>x.id===editCid); contacts[i]={...contacts[i],...data}; persist(); closeModal('contactModal'); showDetail(editCid); }
  else { contacts.unshift({id:uid(),createdAt:new Date().toISOString(),...data}); persist(); closeModal('contactModal'); renderContacts(); }
}
function delContact(id){
  const c = contacts.find(x=>x.id===id);
  if(!c) return;
  const actCnt = activities.filter(a=>a.contactId===id).length;
  document.getElementById('delContactInfo').innerHTML =
    `<strong>${c.last}${c.first}</strong>${c.company?' Â· '+c.company:''}<br>
     <span style="font-size:12px;color:var(--muted)">ê´€ë ¨ í™œë™ ${actCnt}ê±´ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.</span>`;
  document.getElementById('delContactConfirmBtn').onclick = ()=>{
    contacts = contacts.filter(x=>x.id!==id);
    activities = activities.filter(a=>a.contactId!==id);
    persist();
    closeModal('delContactModal');
    backToList();
  };
  document.getElementById('delContactModal').classList.add('open');
}

// â”€â”€ COMPANY MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _finRows=[];  // [{year,headcount,revenue,op_profit,net_profit,assets,liabilities}]
let _ceoRows=[];  // [{from,to,name,memo}]

function switchCoTab(tab){
  ['basic','finance','ceo'].forEach(t=>{
    document.getElementById('coTab-'+t).classList.toggle('active',t===tab);
    document.getElementById('coPanel-'+t).style.display=t===tab?'':'none';
  });
}

function addFinanceRow(data={}){
  const yr=data.year||(new Date().getFullYear());
  _finRows.push({...{year:yr,headcount:'',revenue:'',op_profit:'',net_profit:'',assets:'',liabilities:''},...data});
  renderFinTable();
}
function renderFinTable(){
  // sort by year desc
  _finRows.sort((a,b)=>Number(b.year)-Number(a.year));
  const tbody=document.getElementById('finBody');
  tbody.innerHTML=_finRows.map((r,i)=>`
    <tr>
      <td><input class="fin-year" value="${r.year}" onchange="_finRows[${i}].year=this.value" onblur="renderFinTable()" placeholder="2024"></td>
      <td><input class="fin-input" value="${r.headcount}" onchange="_finRows[${i}].headcount=this.value" placeholder="â€”"></td>
      <td><input class="fin-input" value="${r.revenue}" onchange="_finRows[${i}].revenue=this.value" placeholder="â€”"></td>
      <td><input class="fin-input" value="${r.op_profit}" onchange="_finRows[${i}].op_profit=this.value" placeholder="â€”"></td>
      <td><input class="fin-input" value="${r.net_profit}" onchange="_finRows[${i}].net_profit=this.value" placeholder="â€”"></td>
      <td><input class="fin-input" value="${r.assets}" onchange="_finRows[${i}].assets=this.value" placeholder="â€”"></td>
      <td><input class="fin-input" value="${r.liabilities}" onchange="_finRows[${i}].liabilities=this.value" placeholder="â€”"></td>
      <td><button class="fin-del" onclick="_finRows.splice(${i},1);renderFinTable()">âœ•</button></td>
    </tr>`).join('');
}

function addCeoRow(data={}){
  _ceoRows.unshift({...{from:'',to:'',name:'',memo:''},...data});
  renderCeoList();
}
function renderCeoList(){
  const div=document.getElementById('ceoList');
  if(!_ceoRows.length){
    div.innerHTML=`<div style="text-align:center;padding:24px;color:var(--muted);font-size:13px">ë“±ë¡ëœ ëŒ€í‘œì´ì‚¬ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
    return;
  }
  div.innerHTML=`
    <div class="ceo-header"><span>ì·¨ì„ì—°ë„</span><span>ì´ë¦„</span><span>í‡´ì„ì—°ë„</span><span>ë¹„ê³ </span><span></span></div>
    ${_ceoRows.map((r,i)=>`
    <div class="ceo-row">
      <input class="ceo-input" value="${r.from}" onchange="_ceoRows[${i}].from=this.value" placeholder="2020">
      <input class="ceo-input" value="${r.name}" onchange="_ceoRows[${i}].name=this.value" placeholder="í™ê¸¸ë™">
      <input class="ceo-input" value="${r.to}" onchange="_ceoRows[${i}].to=this.value" placeholder="í˜„ì¬">
      <input class="ceo-input" value="${r.memo}" onchange="_ceoRows[${i}].memo=this.value" placeholder="ë©”ëª¨">
      <button class="ceo-del" onclick="_ceoRows.splice(${i},1);renderCeoList()">âœ•</button>
    </div>`).join('')}`;
}

function openCompanyModal(co){
  editCoName=co;
  const ci=companies[co]||{};
  document.getElementById('coModalTitle').textContent=co;
  document.getElementById('co_name').value=co;
  document.getElementById('co_phone').value=ci.phone||'';
  document.getElementById('co_fax').value=ci.fax||'';
  document.getElementById('co_address').value=ci.address||'';
  document.getElementById('co_memo').value=ci.memo||'';
  document.getElementById('co_our_team').value=ci.ourTeam||'';
  document.getElementById('co_our_name').value=ci.ourName||'';
  document.getElementById('co_our_memo').value=ci.ourMemo||'';

  // ì¬ë¬´ ë°ì´í„° ë¡œë“œ
  _finRows=(ci.finance||[]).map(r=>({...r}));
  renderFinTable();
  if(!_finRows.length) addFinanceRow({year:new Date().getFullYear()});

  // ëŒ€í‘œì´ì‚¬ ì´ë ¥ ë¡œë“œ
  _ceoRows=(ci.ceoHistory||[]).map(r=>({...r}));
  renderCeoList();

  // ë³‘í•© ëŒ€ìƒ ëª©ë¡
  const sel=document.getElementById('co_merge_target');
  const allCos=[...new Set(contacts.map(c=>c.company).filter(Boolean))].sort();
  sel.innerHTML='<option value="">â€” ë³‘í•© ì•ˆ í•¨ â€”</option>'
    +allCos.filter(n=>n!==co).map(n=>{
      const cnt=contacts.filter(c=>c.company===n).length;
      return `<option value="${n.replace(/"/g,'&quot;')}">${n} (${cnt}ëª…)</option>`;
    }).join('');
  sel.value='';
  document.getElementById('co_merge_preview').style.display='none';
  sel.onchange=()=>{
    const target=sel.value;
    const prev=document.getElementById('co_merge_preview');
    if(!target){ prev.style.display='none'; return; }
    const cnt=contacts.filter(c=>c.company===target).length;
    prev.style.display='';
    prev.textContent=`âš  "${target}" ì†Œì† ${cnt}ëª…ì´ "${co}"ë¡œ ì´ë™ë©ë‹ˆë‹¤. ì €ì¥ ì‹œ ì ìš©ë©ë‹ˆë‹¤.`;
  };

  switchCoTab('basic');
  document.getElementById('companyModal').classList.add('open');
}

function saveCompany(){
  if(!editCoName) return;
  const newName=document.getElementById('co_name').value.trim();
  const mergeTarget=document.getElementById('co_merge_target').value;
  if(!newName){ alert('íšŒì‚¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }

  // â‘  ë³‘í•© â€” confirm ëŒ€ì‹  ì „ìš© ëª¨ë‹¬
  if(mergeTarget){
    const cnt=contacts.filter(c=>c.company===mergeTarget).length;
    document.getElementById('mergeConfirmInfo').innerHTML=
      `<div>ì—†ì•¨ íšŒì‚¬&nbsp;&nbsp;<strong style="color:var(--accent2)">${mergeTarget}</strong> <span style="color:var(--muted)">(${cnt}ëª…)</span></div>
       <div>í•©ì¹  íšŒì‚¬&nbsp;&nbsp;<strong style="color:var(--accent3)">${newName}</strong></div>
       <div style="margin-top:8px;font-size:12px;color:var(--muted)">â†’ "${mergeTarget}" ì†Œì† ${cnt}ëª…ì´ "${newName}"ìœ¼ë¡œ ì´ë™ë©ë‹ˆë‹¤.</div>`;
    document.getElementById('mergeConfirmBtn').onclick=()=>{
      closeModal('mergeConfirmModal');
      _doSaveCompany(newName, mergeTarget);
    };
    document.getElementById('mergeConfirmModal').classList.add('open');
    return;
  }

  _doSaveCompany(newName, null);
}

function _doSaveCompany(newName, mergeTarget){
  // â‘  ë³‘í•©
  if(mergeTarget){
    contacts.forEach(c=>{ if(c.company===mergeTarget) c.company=newName; });
    // ë³‘í•© ëŒ€ìƒ í™œë™ë„ ì´ì „
    const mergedInfo = companies[mergeTarget]||{};
    delete companies[mergeTarget];
    // ì¬ë¬´/ëŒ€í‘œì´ì‚¬ ë°ì´í„° ë³‘í•© (ê¸°ì¡´ ë°ì´í„° ë³´ì¡´)
    if(!companies[newName]) companies[newName]={};
    if(mergedInfo.finance?.length && !companies[newName].finance?.length)
      companies[newName].finance = mergedInfo.finance;
    if(mergedInfo.ceoHistory?.length && !companies[newName].ceoHistory?.length)
      companies[newName].ceoHistory = mergedInfo.ceoHistory;
  }

  // â‘¡ íšŒì‚¬ëª… ë³€ê²½
  if(newName!==editCoName){
    contacts.forEach(c=>{ if(c.company===editCoName) c.company=newName; });
    const oldInfo=companies[editCoName]||{};
    delete companies[editCoName];
    if(!companies[newName]) companies[newName]={};
    companies[newName]={...oldInfo,...companies[newName]};
  }

  // â‘¢ ê³µí†µ ì •ë³´ ì €ì¥
  if(!companies[newName]) companies[newName]={};
  companies[newName].phone     = document.getElementById('co_phone').value.trim();
  companies[newName].fax       = document.getElementById('co_fax').value.trim();
  companies[newName].address   = document.getElementById('co_address').value.trim();
  companies[newName].memo      = document.getElementById('co_memo').value.trim();
  companies[newName].ourTeam   = document.getElementById('co_our_team').value.trim();
  companies[newName].ourName   = document.getElementById('co_our_name').value.trim();
  companies[newName].ourMemo   = document.getElementById('co_our_memo').value.trim();
  companies[newName].finance   = _finRows.filter(r=>r.year).map(r=>({
    year:r.year, headcount:r.headcount, revenue:r.revenue,
    op_profit:r.op_profit, net_profit:r.net_profit,
    assets:r.assets, liabilities:r.liabilities
  }));
  companies[newName].ceoHistory= _ceoRows.filter(r=>r.name);

  persist();
  closeModal('companyModal');
  renderContacts();
}

// â”€â”€ ACTIVITY MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let editActId = null;

function openActModal_contact(cid){
  editActId = null;
  actCid = cid;
  const c = contacts.find(x=>x.id===cid);
  document.getElementById('actModalTitle').textContent = 'í™œë™ ì¶”ê°€';
  document.getElementById('actWhoSection').style.display = '';
  document.getElementById('actWho').innerHTML = `${c?c.last+c.first:''} ${c&&c.company?'<span style="font-size:12px;color:var(--muted)">Â· '+c.company+'</span>':''}`;
  _resetActForm();
  document.getElementById('activityModal').classList.add('open');
}

function openActModal_co(co){
  const members = contacts.filter(c=>(c.company||'').trim()===co);
  if(!members.length){ alert('ë¨¼ì € ë‹´ë‹¹ìë¥¼ ì¶”ê°€í•˜ì„¸ìš”.'); return; }
  editActId = null;
  actCid = members[0].id;
  document.getElementById('actModalTitle').textContent = 'í™œë™ ì¶”ê°€';
  document.getElementById('actWhoSection').style.display = '';
  if(members.length===1){
    const c = members[0];
    document.getElementById('actWho').innerHTML = `${c.last+c.first} <span style="font-size:12px;color:var(--muted)">Â· ${co}</span>`;
    _resetActForm();
    document.getElementById('activityModal').classList.add('open');
  } else {
    document.getElementById('actWho').innerHTML =
      `<select id="actPicker" onchange="actCid=this.value" style="background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:5px 8px;font-family:inherit;font-size:13px;outline:none;width:100%">
        ${members.map(m=>`<option value="${m.id}">${m.last}${m.first} (${m.dept||m.position||''})</option>`).join('')}
      </select>`;
    _resetActForm();
    document.getElementById('activityModal').classList.add('open');
  }
}

function openEditAct(id){
  const a = activities.find(x=>x.id===id);
  if(!a) return;
  editActId = id;
  actCid = a.contactId;
  const c = contacts.find(x=>x.id===a.contactId);
  document.getElementById('actModalTitle').textContent = 'í™œë™ ìˆ˜ì •';
  document.getElementById('actWhoSection').style.display = '';
  document.getElementById('actWho').innerHTML = c ? `${c.last}${c.first} <span style="font-size:12px;color:var(--muted)">Â· ${c.company||''}</span>` : '';
  document.getElementById('a_type').value   = a.type  || 'other';
  document.getElementById('a_date').value   = a.date  || '';
  document.getElementById('a_title').value  = a.title || '';
  document.getElementById('a_content').value= a.content|| '';
  document.getElementById('a_amount').value = a.amount || '';
  document.getElementById('activityModal').classList.add('open');
}

function _resetActForm(){
  refreshTypeSelect();
  document.getElementById('a_date').value   = new Date().toISOString().slice(0,10);
  document.getElementById('a_type').value   = actTypes[0]?.id || 'order';
  ['a_title','a_content','a_amount'].forEach(id=>document.getElementById(id).value='');
}

function saveActivity(){
  const picker = document.getElementById('actPicker');
  if(picker) actCid = picker.value;
  if(!actCid){ alert('ë‹´ë‹¹ìë¥¼ ì„ íƒí•˜ì„¸ìš”.'); return; }
  const date = document.getElementById('a_date').value;
  if(!date){ alert('ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  const data = {
    contactId: actCid,
    type:    document.getElementById('a_type').value,
    date,
    title:   document.getElementById('a_title').value.trim(),
    content: document.getElementById('a_content').value.trim(),
    amount:  document.getElementById('a_amount').value.trim(),
  };
  if(editActId){
    // ìˆ˜ì •
    const idx = activities.findIndex(a=>a.id===editActId);
    if(idx>-1) activities[idx] = {...activities[idx], ...data};
  } else {
    // ì‹ ê·œ
    activities.push({id:uid(), createdAt:new Date().toISOString(), ...data});
  }
  editActId = null;
  persist();
  closeModal('activityModal');
  if(currentCid) showDetail(currentCid); else renderContacts();
}

function delAct(id, fromDetail=false){
  const a = activities.find(x=>x.id===id);
  if(!a) return;
  const c = contacts.find(x=>x.id===a.contactId);
  const typeLabel = {visit:'ğŸ¤ ë°©ë¬¸', call:'ğŸ“ í†µí™”', quote:'ğŸ“„ ê²¬ì ', order:'ğŸ“¦ ë°œì£¼', other:'ğŸ“Œ ê¸°íƒ€'};
  document.getElementById('delActInfo').innerHTML = `
    <div style="display:flex;flex-direction:column;gap:4px">
      <div><span style="color:var(--muted);font-size:11px;font-family:'IBM Plex Mono',monospace">ìœ í˜•</span>&nbsp;&nbsp;${typeLabel[a.type]||a.type}</div>
      <div><span style="color:var(--muted);font-size:11px;font-family:'IBM Plex Mono',monospace">ë‚ ì§œ</span>&nbsp;&nbsp;${a.date}</div>
      ${a.title?`<div><span style="color:var(--muted);font-size:11px;font-family:'IBM Plex Mono',monospace">ì œëª©</span>&nbsp;&nbsp;${a.title}</div>`:''}
      ${a.content?`<div><span style="color:var(--muted);font-size:11px;font-family:'IBM Plex Mono',monospace">ë‚´ìš©</span>&nbsp;&nbsp;<span style="color:var(--muted)">${a.content.length>50?a.content.slice(0,50)+'â€¦':a.content}</span></div>`:''}
      ${c?`<div><span style="color:var(--muted);font-size:11px;font-family:'IBM Plex Mono',monospace">ë‹´ë‹¹ì</span>&nbsp;&nbsp;${c.last}${c.first}${c.company?' Â· '+c.company:''}</div>`:''}
    </div>`;
  document.getElementById('delActConfirmBtn').onclick = ()=>{
    activities = activities.filter(x=>x.id!==id);
    persist();
    closeModal('delActModal');
    if(fromDetail && currentCid) showDetail(currentCid);
    else { renderContacts(); renderAllActs(); }
  };
  document.getElementById('delActModal').classList.add('open');
}

// â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function closeModal(id){ document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.modal-overlay').forEach(o=>{ o.addEventListener('click',e=>{ if(e.target===o) o.classList.remove('open'); }); });

function renderStats(){
  const today = new Date();
  const todayStr = today.toISOString().slice(0,10);

  // 1ì£¼ì¼ ì „ ë‚ ì§œ (ì˜¤ëŠ˜ í¬í•¨ 7ì¼)
  const weekAgo = new Date(today);
  weekAgo.setDate(weekAgo.getDate() - 6);
  const weekAgoStr = weekAgo.toISOString().slice(0,10);

  const cos = [...new Set(contacts.map(c=>c.company).filter(Boolean))];

  // ë‹¹ì¼ ì‹ ê·œ ì—°ë½ì²˜ (createdAt ê¸°ì¤€)
  const newContacts = contacts.filter(c=>(c.createdAt||'').slice(0,10)===todayStr).length;
  // ë‹¹ì¼ ì‹ ê·œ í™œë™ (ë“±ë¡ì¼ createdAt ê¸°ì¤€)
  const newActs = activities.filter(a=>(a.createdAt||'').slice(0,10)===todayStr).length;

  // í™œë™ ìœ í˜•ë³„ â€” í™œë™ì˜ date í•„ë“œ ê¸°ì¤€, ìµœê·¼ 7ì¼
  const weekActs = activities.filter(a=>{
    const d = (a.date||'').slice(0,10);
    return d >= weekAgoStr && d <= todayStr;
  });

  // ì‚¬ì´ë“œë°” ë°°ì§€ ì—…ë°ì´íŠ¸
  const cBadge  = document.getElementById('todayContacts');
  const aBadge  = document.getElementById('todayActivities');
  const mcBadge = document.getElementById('mTodayContacts');
  const maBadge = document.getElementById('mTodayActivities');
  [cBadge, mcBadge].forEach(b=>{ if(b){ b.textContent='+'+newContacts; b.style.display=newContacts>0?'inline-block':'none'; }});
  [aBadge, maBadge].forEach(b=>{ if(b){ b.textContent='+'+newActs;     b.style.display=newActs>0?'inline-block':'none'; }});

  const typeRows = actTypes.map(t=>{
    const cnt = weekActs.filter(a=>a.type===t.id).length;
    if(!cnt) return '';
    return `<div class="stat-row"><span>${t.emoji} ${t.label}</span><span>${cnt}</span></div>`;
  }).join('');

  document.getElementById('sidebarStats').innerHTML=`
    <div class="stat-row"><span>íšŒì‚¬</span><span>${cos.length}</span></div>
    <div class="stat-row">
      <span>ì—°ë½ì²˜</span>
      <span>${contacts.length}${newContacts>0?` <span style="color:#ff6b6b;font-size:10px;font-weight:700">+${newContacts}ì˜¤ëŠ˜</span>`:''}</span>
    </div>
    <div class="stat-row">
      <span>ì´ í™œë™</span>
      <span>${activities.length}${newActs>0?` <span style="color:#ff6b6b;font-size:10px;font-weight:700">+${newActs}ì˜¤ëŠ˜</span>`:''}</span>
    </div>
    <div style="border-top:1px solid var(--border);margin:6px 0;opacity:.3"></div>
    <div style="font-size:10px;color:var(--muted);margin-bottom:4px;font-family:'IBM Plex Mono',monospace">
      í™œë™ ìœ í˜•ë³„ <span style="opacity:.6">(ìµœê·¼ 7ì¼)</span>
    </div>
    ${typeRows || `<div style="font-size:10px;color:var(--border);padding:2px 0">ìµœê·¼ 7ì¼ í™œë™ ì—†ìŒ</div>`}
    <div style="border-top:1px solid var(--border);margin:6px 0;opacity:.3"></div>
    <div style="font-size:10px;color:var(--muted);font-family:'IBM Plex Mono',monospace;text-align:right">
      ${weekAgoStr} ~ ${todayStr}
    </div>`;
}

// â”€â”€ PDF IMPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let pdfBase64 = null;
let pdfFileType = null;
let pdfExtracted = [];
let pdfActivities = [];

function pdfShowStep(n){
  for(let i=0;i<=7;i++){
    const el = document.getElementById('pdfStep'+i);
    if(el) el.style.display = i===n ? '' : 'none';
  }
}

function openPdfModal(){
  pdfBase64 = null;
  pdfFileType = null;
  pdfExtracted = [];
  pdfActivities = [];
  _csvFile = null;
  _csvRawRows = []; _csvHeaders = []; _csvMapping = {};
  document.getElementById('pdfFileInput').value='';
  document.getElementById('pdfFileName').style.display='none';
  document.getElementById('pdfFileTypeNote').style.display='none';
  const analyzeBtn = document.getElementById('pdfAnalyzeBtn');
  analyzeBtn.disabled = true;
  analyzeBtn.textContent = 'ğŸ” ë¶„ì„ ì‹œì‘';
  analyzeBtn.onclick = pdfAnalyze;
  document.getElementById('dropIcon').textContent='ğŸ—‚';
  const key = localStorage.getItem('crm_api_key');
  // í‚¤ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
  const prev = document.getElementById('keyPreview');
  if(prev && key) prev.textContent = '(í˜„ì¬: ' + key.slice(0,12) + '...)';
  pdfShowStep(key ? 1 : 0);
  document.getElementById('pdfModal').classList.add('open');
}

function pdfSaveKey(){
  const key = document.getElementById('pdfApiKey').value.trim();
  if(!key){ alert('API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
  if(!key.startsWith('sk-')){ alert('ì˜¬ë°”ë¥¸ API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.\ní‚¤ëŠ” sk- ë¡œ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤.'); return; }
  localStorage.setItem('crm_api_key', key);
  pdfShowStep(1);
}

function pdfChangeKey(){
  const key = localStorage.getItem('crm_api_key')||'';
  const input = document.getElementById('pdfApiKey');
  input.value = key;
  input.type = 'password';
  const prev = document.getElementById('keyPreview');
  if(prev && key) prev.textContent = '(í˜„ì¬: ' + key.slice(0,12) + '...)';
  pdfShowStep(0);
}

// íŒŒì¼ ìœ í˜• ê°ì§€
function detectFileType(file){
  const name = file.name.toLowerCase();
  const mime = file.type;
  if(mime==='application/pdf' || name.endsWith('.pdf'))
    return {kind:'pdf', mediaType:'application/pdf', icon:'ğŸ“„', label:'PDF ë¬¸ì„œ'};
  if(['image/jpeg','image/jpg','image/png','image/webp','image/gif'].includes(mime) ||
     /\.(jpg|jpeg|png|webp|gif)$/.test(name))
    return {kind:'image', mediaType: mime||'image/jpeg', icon:'ğŸ–¼', label:'ì´ë¯¸ì§€ (ëª…í•¨Â·ì‚¬ì§„)'};
  if(mime==='text/plain' || name.endsWith('.txt'))
    return {kind:'text', mediaType:'text/plain', icon:'ğŸ“', label:'í…ìŠ¤íŠ¸ íŒŒì¼'};
  if(mime==='text/csv' || name.endsWith('.csv'))
    return {kind:'text', mediaType:'text/csv', icon:'ğŸ“Š', label:'CSV íŒŒì¼'};
  if(/\.(xls|xlsx)$/.test(name))
    return {kind:'text', mediaType:'text/plain', icon:'ğŸ“Š', label:'ì—‘ì…€ íŒŒì¼'};
  if(/\.(doc|docx)$/.test(name))
    return {kind:'text', mediaType:'text/plain', icon:'ğŸ“‹', label:'Word íŒŒì¼'};
  return {kind:'text', mediaType:'text/plain', icon:'ğŸ“', label:'íŒŒì¼'};
}



function onPdfSelected(input){
  const file = input.files[0];
  if(!file) return;

  // CSVëŠ” ì „ìš© í”Œë¡œìš° (pdfModal ë‚´ Step5~7)
  if(file.name.toLowerCase().endsWith('.csv') || file.type==='text/csv'){
    _csvFile = file;
    const sizeMB = (file.size/1024/1024).toFixed(1);
    const nameEl = document.getElementById('pdfFileName');
    nameEl.innerHTML = `ğŸ“Š <strong>${file.name}</strong> <span style="color:var(--muted)">(${sizeMB}MB Â· CSV ìë™ ì²˜ë¦¬)</span>`;
    nameEl.style.display = '';
    document.getElementById('pdfFileTypeNote').innerHTML =
      `ê°ì§€ëœ ìœ í˜•: <span style="color:var(--accent3)">CSV íŒŒì¼ â€” ëŒ€ìš©ëŸ‰ ì§ì ‘ íŒŒì‹± ëª¨ë“œ</span>`;
    document.getElementById('pdfFileTypeNote').style.display = '';
    document.getElementById('dropIcon').textContent = 'ğŸ“Š';
    // ë¶„ì„ ë²„íŠ¼ì„ CSV íŒŒì‹± ë²„íŠ¼ìœ¼ë¡œ êµì²´
    const btn = document.getElementById('pdfAnalyzeBtn');
    btn.disabled = false;
    btn.textContent = 'â¡ CSV ë¶„ì„í•˜ê¸°';
    btn.onclick = csvParse;
    return;
  }

  if(file.size > 10*1024*1024){ alert('íŒŒì¼ í¬ê¸°ê°€ 10MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.\nCSV íŒŒì¼ì€ í¬ê¸° ì œí•œ ì—†ì´ ìë™ ì²˜ë¦¬ë©ë‹ˆë‹¤.'); return; }

  const ft = detectFileType(file);
  pdfFileType = ft;

  const nameEl = document.getElementById('pdfFileName');
  nameEl.innerHTML = ft.icon + ' <strong>' + file.name + '</strong> <span style="color:var(--muted)">(' + (file.size/1024).toFixed(0) + 'KB)</span>';
  nameEl.style.display = '';

  const noteEl = document.getElementById('pdfFileTypeNote');
  noteEl.innerHTML = 'ê°ì§€ëœ ìœ í˜•: <span style="color:var(--accent)">' + ft.label + '</span>';
  noteEl.style.display = '';

  document.getElementById('dropIcon').textContent = ft.icon;
  document.getElementById('pdfAnalyzeBtn').disabled = false;

  const reader = new FileReader();
  if(ft.kind === 'text'){
    reader.onload = e => {
      try { pdfBase64 = btoa(unescape(encodeURIComponent(e.target.result))); }
      catch(ex){ pdfBase64 = btoa(e.target.result); }
    };
    reader.readAsText(file, 'UTF-8');
  } else {
    reader.onload = e => { pdfBase64 = e.target.result.split(',')[1]; };
    reader.readAsDataURL(file);
  }
}

// Drag & drop support
(function(){
  const dz = document.getElementById('pdfDropzone');
  if(!dz) return;
  dz.addEventListener('dragover', e=>{ e.preventDefault(); dz.classList.add('drag'); });
  dz.addEventListener('dragleave', ()=> dz.classList.remove('drag'));
  dz.addEventListener('drop', e=>{
    e.preventDefault(); dz.classList.remove('drag');
    const file = e.dataTransfer.files[0];
    if(!file) return;
    const fi = document.getElementById('pdfFileInput');
    const dt = new DataTransfer();
    dt.items.add(file);
    fi.files = dt.files;
    onPdfSelected(fi);
  });
})();

async function pdfAnalyze(){
  if(!pdfBase64){ alert('íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
  const apiKey = localStorage.getItem('crm_api_key');
  if(!apiKey){ alert('API í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.'); pdfShowStep(0); return; }

  const ft = pdfFileType || {kind:'pdf', mediaType:'application/pdf', icon:'ğŸ“„', label:'íŒŒì¼'};
  const loadMsg = document.getElementById('pdfLoadingMsg');
  if(loadMsg) loadMsg.textContent = ft.icon + ' ' + ft.label + ' ë¶„ì„ ì¤‘...';
  pdfShowStep(2);

  const prompt = `ì´ íŒŒì¼ì—ì„œ ì—°ë½ì²˜ ì •ë³´ì™€ ê±°ë˜/í™œë™ ë‚´ì—­ì„ ëª¨ë‘ ì¶”ì¶œí•´ì£¼ì„¸ìš”.
ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”. ë‹¤ë¥¸ ì„¤ëª… í…ìŠ¤íŠ¸ ì—†ì´ JSONë§Œ:

{
  "contacts": [
    {
      "company": "íšŒì‚¬ëª…",
      "dept": "ë¶€ì„œ",
      "position": "ì§ì±…",
      "last": "ì„±",
      "first": "ì´ë¦„",
      "email": "ì´ë©”ì¼",
      "office": "ì‚¬ë¬´ì‹¤ì „í™”",
      "mobile": "íœ´ëŒ€í°",
      "extra": "íŒ©ìŠ¤ ë“± ì¶”ê°€ì—°ë½ì²˜",
      "address": "ì£¼ì†Œ",
      "memo": "ê¸°íƒ€ì •ë³´"
    }
  ],
  "activities": [
    {
      "date": "YYYY-MM-DD",
      "type": "visit ë˜ëŠ” call ë˜ëŠ” quote ë˜ëŠ” order ë˜ëŠ” other",
      "title": "í•œ ì¤„ ì œëª©",
      "content": "ìƒì„¸ ë‚´ìš©",
      "amount": "ê¸ˆì•¡(ìˆ«ìë§Œ, ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)"
    }
  ]
}

ê·œì¹™:
- ëª…í•¨ ì´ë¯¸ì§€ë¼ë©´ ëª…í•¨ì— ë³´ì´ëŠ” ëª¨ë“  ì •ë³´ë¥¼ ì¶”ì¶œí•˜ì„¸ìš”.
- ì—¬ëŸ¬ ëª…í•¨ì´ ìˆìœ¼ë©´ ê°ê° ë¶„ë¦¬í•´ì„œ ì¶”ì¶œí•˜ì„¸ìš”.
- í•œêµ­ ì´ë¦„ì€ ì„±(last)ê³¼ ì´ë¦„(first)ì„ ë¶„ë¦¬. ì˜ˆ: ê¹€ì² ìˆ˜ â†’ last:"ê¹€", first:"ì² ìˆ˜"
- ë‚ ì§œëŠ” ë°˜ë“œì‹œ YYYY-MM-DD í˜•ì‹. ì˜ˆ: 2024.06.26 â†’ "2024-06-26"
- ê±°ë˜ ìœ í˜• ë§¤í•‘: ë°©ë¬¸â†’visit, í†µí™”â†’call, ê²¬ì â†’quote, ë°œì£¼â†’order, ê¸°íƒ€â†’other
- ê¸ˆì•¡: ìˆ«ìë§Œ. ì˜ˆ: "3880ë§Œ" â†’ "38800000"
- ì—†ëŠ” í•­ëª©ì€ ë¹ˆ ë¬¸ìì—´("")ë¡œ ë‘ì„¸ìš”.
- JSON ì™¸ ë‹¤ë¥¸ í…ìŠ¤íŠ¸ëŠ” ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.`;

  try {
    // íŒŒì¼ ìœ í˜•ë³„ content êµ¬ì„±
    let contentParts;
    if(ft.kind === 'image'){
      contentParts = [
        { type:'image', source:{ type:'base64', media_type: ft.mediaType, data: pdfBase64 } },
        { type:'text', text: prompt }
      ];
    } else if(ft.kind === 'text'){
      let textContent = '';
      try { textContent = decodeURIComponent(escape(atob(pdfBase64))); }
      catch(e){ textContent = atob(pdfBase64); }
      contentParts = [
        { type:'text', text: 'ì•„ë˜ëŠ” íŒŒì¼ ë‚´ìš©ì…ë‹ˆë‹¤:\n\n' + textContent + '\n\n' + prompt }
      ];
    } else {
      // PDF
      contentParts = [
        { type:'document', source:{ type:'base64', media_type:'application/pdf', data: pdfBase64 } },
        { type:'text', text: prompt }
      ];
    }

    const reqBody = {
      model: 'claude-opus-4-6',
      max_tokens: 4000,
      messages: [{ role:'user', content: contentParts }]
    };

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify(reqBody)
    });

    let data;
    try { data = await response.json(); }
    catch(e){ throw new Error('ì„œë²„ ì‘ë‹µì„ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (HTTP ' + response.status + ')'); }

    if(!response.ok){
      const errType = data?.error?.type || '';
      const errMsg  = data?.error?.message || JSON.stringify(data);
      if(response.status === 401) throw new Error('API í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. í‚¤ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.\n(' + errMsg + ')');
      if(response.status === 400) throw new Error('ìš”ì²­ ì˜¤ë¥˜ (400): ' + errMsg);
      if(response.status === 429) throw new Error('ìš”ì²­ í•œë„ ì´ˆê³¼ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      throw new Error('API ì˜¤ë¥˜ (' + response.status + '): ' + errMsg);
    }

    const raw = data.content?.find(b=>b.type==='text')?.text || '';
    if(!raw) throw new Error('AI ì‘ë‹µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');

    // JSON ì¶”ì¶œ â€” ë‹¤ì–‘í•œ íŒ¨í„´ ì‹œë„
    let parsed = null;
    const jsonMatch = raw.match(/\{[\s\S]*\}/);
    if(jsonMatch){
      try { parsed = JSON.parse(jsonMatch[0]); } catch(e){}
    }
    if(!parsed) throw new Error('ì‘ë‹µì—ì„œ JSONì„ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì›ë³¸: ' + raw.slice(0,200));

    pdfExtracted  = parsed.contacts   || [];
    pdfActivities = parsed.activities || [];

    if(!pdfExtracted.length && !pdfActivities.length)
      throw new Error('ì¶”ì¶œëœ ì—°ë½ì²˜ë‚˜ í™œë™ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.\níŒŒì¼ì— ì—°ë½ì²˜ ê´€ë ¨ ë‚´ìš©ì´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');

    renderPdfResults();
    pdfShowStep(3);

  } catch(err) {
    const msg = (err.message || String(err)).replace(/\n/g,'<br>');
    document.getElementById('pdfErrorMsg').innerHTML =
      `<div style="background:rgba(255,107,107,0.1);border:1px solid rgba(255,107,107,0.3);border-radius:8px;padding:12px 14px;margin-bottom:12px;text-align:left;word-break:break-all">${msg}</div>
       <div style="font-size:11px;color:var(--muted);line-height:1.8;text-align:left">
         <b>í™•ì¸ ì‚¬í•­:</b><br>
         â€¢ API í‚¤ê°€ <code>sk-ant-</code>ë¡œ ì‹œì‘í•˜ëŠ”ì§€ í™•ì¸<br>
         â€¢ PDFê°€ ì•”í˜¸í™”ë˜ì–´ ìˆì§€ ì•Šì€ì§€ í™•ì¸<br>
         â€¢ ì´ë¯¸ì§€ëŠ” JPG Â· PNG Â· WEBP ê¶Œì¥<br>
         â€¢ íŒŒì¼ì´ ë„ˆë¬´ í¬ê±°ë‚˜ ì†ìƒë˜ì§€ ì•Šì•˜ëŠ”ì§€ í™•ì¸
       </div>`;
    pdfShowStep(4);
  }
}

function pdfRetry(){
  pdfBase64=null; pdfExtracted=[]; pdfActivities=[]; pdfFileType=null;
  document.getElementById('pdfFileInput').value='';
  document.getElementById('pdfFileName').style.display='none';
  document.getElementById('pdfFileTypeNote').style.display='none';
  document.getElementById('pdfAnalyzeBtn').disabled=true;
  document.getElementById('dropIcon').textContent='ğŸ—‚';
  pdfShowStep(1);
}

function esc2(s){ return (s||'').replace(/"/g,'&quot;').replace(/</g,'&lt;'); }

function renderPdfResults(){
  const div = document.getElementById('pdfResults');
  const typeLabel = {};
  actTypes.forEach(t=>{ typeLabel[t.id] = t.emoji+' '+t.label; });

  let html = '';

  // â”€â”€ ì—°ë½ì²˜ ì„¹ì…˜ â”€â”€
  if(pdfExtracted.length){
    html += `<div style="font-size:11px;font-family:'IBM Plex Mono',monospace;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border)">ğŸ‘¤ ì—°ë½ì²˜ (${pdfExtracted.length}ëª…)</div>`;
    html += pdfExtracted.map((p,i)=>{
      const name=(p.last||'')+(p.first||'')||'ì´ë¦„ ì—†ìŒ';
      return `<div class="pdf-contact-card checked" id="pdfCard${i}">
        <div class="pdf-card-header">
          <input type="checkbox" class="pdf-card-check" id="pdfCheck${i}" checked onchange="document.getElementById('pdfCard${i}').classList.toggle('checked',this.checked)">
          <div class="pdf-card-name">${name} ${p.company?'<span style="font-size:12px;color:var(--muted);font-weight:400">Â· '+p.company+'</span>':''}</div>
        </div>
        <div class="pdf-fields">
          <div class="pdf-field"><label>íšŒì‚¬</label><input id="pr${i}_company" value="${esc2(p.company)}"></div>
          <div class="pdf-field"><label>ë¶€ì„œ</label><input id="pr${i}_dept" value="${esc2(p.dept)}"></div>
          <div class="pdf-field"><label>ì§ì±…</label><input id="pr${i}_position" value="${esc2(p.position)}"></div>
          <div class="pdf-field"><label>ì„±</label><input id="pr${i}_last" value="${esc2(p.last)}"></div>
          <div class="pdf-field"><label>ì´ë¦„</label><input id="pr${i}_first" value="${esc2(p.first)}"></div>
          <div class="pdf-field"><label>ì´ë©”ì¼</label><input id="pr${i}_email" value="${esc2(p.email)}"></div>
          <div class="pdf-field"><label>ì‚¬ë¬´ì‹¤</label><input id="pr${i}_office" value="${esc2(p.office)}"></div>
          <div class="pdf-field"><label>íœ´ëŒ€í°</label><input id="pr${i}_mobile" value="${esc2(p.mobile)}"></div>
          <div class="pdf-field"><label>ì¶”ê°€ì—°ë½ì²˜</label><input id="pr${i}_extra" value="${esc2(p.extra)}"></div>
          <div class="pdf-field full"><label>ì£¼ì†Œ</label><input id="pr${i}_address" value="${esc2(p.address)}"></div>
          <div class="pdf-field full"><label>ë©”ëª¨</label><input id="pr${i}_memo" value="${esc2(p.memo)}"></div>
        </div>
      </div>`;
    }).join('');
  }

  // â”€â”€ í™œë™ ì„¹ì…˜ â”€â”€
  if(pdfActivities.length){
    html += `<div style="font-size:11px;font-family:'IBM Plex Mono',monospace;color:var(--accent3);text-transform:uppercase;letter-spacing:1px;margin:18px 0 8px;padding-bottom:6px;border-bottom:1px solid var(--border)">ğŸ“‹ í™œë™ ë‚´ì—­ (${pdfActivities.length}ê±´) â€” ì—°ë½ì²˜ ì €ì¥ í›„ ìë™ ì—°ê²°ë©ë‹ˆë‹¤</div>`;
    html += `<div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;overflow:hidden">
      <table style="width:100%;border-collapse:collapse;font-size:12px">
        <thead><tr style="background:var(--surface)">
          <th style="padding:8px 10px;text-align:left;font-size:10px;color:var(--muted);font-family:'IBM Plex Mono',monospace;font-weight:400;border-bottom:1px solid var(--border);width:28px"></th>
          <th style="padding:8px 10px;text-align:left;font-size:10px;color:var(--muted);font-family:'IBM Plex Mono',monospace;font-weight:400;border-bottom:1px solid var(--border);width:100px">ë‚ ì§œ</th>
          <th style="padding:8px 10px;text-align:left;font-size:10px;color:var(--muted);font-family:'IBM Plex Mono',monospace;font-weight:400;border-bottom:1px solid var(--border);width:80px">ìœ í˜•</th>
          <th style="padding:8px 10px;text-align:left;font-size:10px;color:var(--muted);font-family:'IBM Plex Mono',monospace;font-weight:400;border-bottom:1px solid var(--border)">ë‚´ìš©</th>
          <th style="padding:8px 10px;text-align:right;font-size:10px;color:var(--muted);font-family:'IBM Plex Mono',monospace;font-weight:400;border-bottom:1px solid var(--border);width:90px">ê¸ˆì•¡</th>
        </tr></thead>
        <tbody>
          ${pdfActivities.map((a,i)=>{
            const tl = typeLabel[a.type]||('ğŸ“Œ '+a.type);
            const amtDisp = a.amount ? 'â‚©'+Number(a.amount||0).toLocaleString() : '';
            return `<tr style="border-bottom:1px solid var(--border)">
              <td style="padding:7px 10px"><input type="checkbox" id="paCheck${i}" checked style="accent-color:var(--accent3)"></td>
              <td style="padding:7px 10px;font-family:'IBM Plex Mono',monospace;color:var(--muted)">${a.date||''}</td>
              <td style="padding:7px 10px">${tl}</td>
              <td style="padding:7px 10px;color:var(--text)">${a.title||''}${a.content&&a.content!==a.title?'<div style="font-size:11px;color:var(--muted);margin-top:2px">'+a.content+'</div>':''}</td>
              <td style="padding:7px 10px;text-align:right;font-family:'IBM Plex Mono',monospace;color:var(--accent3);font-size:11px">${amtDisp}</td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>`;
  }

  div.innerHTML = html || '<div style="text-align:center;padding:24px;color:var(--muted)">ì¶”ì¶œëœ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
}

function pdfImportAll(){
  let addedContacts = 0, addedActs = 0;
  const newContactIds = [];

  // â‘  ì—°ë½ì²˜ ì €ì¥
  for(let i=0; i<pdfExtracted.length; i++){
    const chk = document.getElementById('pdfCheck'+i);
    if(!chk || !chk.checked) continue;
    const get = id => document.getElementById(`pr${i}_${id}`)?.value?.trim()||'';
    const last=get('last'), first=get('first');
    if(!last && !first) continue;
    const co=get('company'), addr=get('address');
    if(co && addr){ if(!companies[co]) companies[co]={}; if(!companies[co].address) companies[co].address=addr; }
    const newId = uid();
    contacts.unshift({ id:newId, createdAt:new Date().toISOString(),
      company:co, dept:get('dept'), position:get('position'), last, first,
      email:get('email'), office:get('office'), mobile:get('mobile'),
      extra:get('extra'), address:addr, memo:get('memo') });
    newContactIds.push(newId);
    addedContacts++;
  }

  // â‘¡ í™œë™ ì €ì¥ â€” ì²« ë²ˆì§¸ ì €ì¥ëœ ì—°ë½ì²˜ì— ì—°ê²°
  const targetId = newContactIds[0] || null;
  if(targetId && pdfActivities.length){
    for(let i=0; i<pdfActivities.length; i++){
      const chk = document.getElementById('paCheck'+i);
      if(!chk || !chk.checked) continue;
      const a = pdfActivities[i];
      activities.push({ id:uid(), contactId:targetId,
        type:a.type||'other', date:a.date||'',
        title:a.title||'', content:a.content||'', amount:a.amount||'',
        createdAt:new Date().toISOString() });
      addedActs++;
    }
  } else if(pdfActivities.length && !targetId){
    alert('í™œë™ì„ ì—°ê²°í•  ì—°ë½ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤. ì—°ë½ì²˜ë¥¼ ë¨¼ì € ì²´í¬í•´ì£¼ì„¸ìš”.');
    return;
  }

  persist();
  closeModal('pdfModal');
  renderContacts();
  const msg = [addedContacts?`ì—°ë½ì²˜ ${addedContacts}ëª…`:'', addedActs?`í™œë™ ${addedActs}ê±´`:''].filter(Boolean).join(', ');
  if(msg) alert(`âœ… ${msg} ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
}


// â”€â”€ CSV ëŒ€ìš©ëŸ‰ ê°€ì ¸ì˜¤ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _csvRawRows = [];   // íŒŒì‹±ëœ ì „ì²´ í–‰ ë°°ì—´
let _csvHeaders = [];   // ì›ë³¸ í—¤ë”
let _csvMapping = {};   // CRMí•„ë“œ â†’ ì›ë³¸ì»¬ëŸ¼ëª…

// Outlook CSV ì»¬ëŸ¼ëª… ìë™ ë§¤í•‘ í…Œì´ë¸” (í•œê¸€/ì˜ë¬¸ ëª¨ë‘)
const CSV_AUTO_MAP = {
  last:     ['ì„±','Last Name','Lastname','ì„±(Last Name)','last_name'],
  first:    ['ì´ë¦„','First Name','Firstname','ì´ë¦„(First Name)','first_name'],
  company:  ['íšŒì‚¬','Company','íšŒì‚¬ ì´ë¦„','Company Name','organization'],
  dept:     ['ë¶€ì„œ','Department','Dept'],
  position: ['ì§í•¨','Job Title','Title','ì§ìœ„','Position'],
  email:    ['ì „ì ë©”ì¼ ì£¼ì†Œ','Email Address','Email','ì´ë©”ì¼','E-mail','email_1_value'],
  mobile:   ['íœ´ëŒ€í°','Mobile Phone','Mobile','Cell Phone','í•¸ë“œí°','phone_1_value'],
  office:   ['íšŒì‚¬ ì „í™”','Business Phone','Work Phone','ì§í†µ','ì‚¬ë¬´ì‹¤ ì „í™”','phone_2_value'],
  extra:    ['ê¸°íƒ€ ì „í™”','Other Phone','Home Phone','ì¶”ê°€ ì—°ë½ì²˜'],
  address:  ['íšŒì‚¬ ì£¼ì†Œ','Business Address','Address','ì£¼ì†Œ','Street'],
  memo:     ['ë©”ëª¨','Notes','Note','ë¹„ê³ '],
};
const CSV_FIELD_LABELS = {
  last:'ì„±', first:'ì´ë¦„', company:'íšŒì‚¬', dept:'ë¶€ì„œ', position:'ì§í•¨',
  email:'ì´ë©”ì¼', mobile:'í•¸ë“œí°', office:'ì§í†µ', extra:'ì¶”ê°€ì—°ë½ì²˜',
  address:'ì£¼ì†Œ', memo:'ë©”ëª¨',
};

// CSV ê´€ë ¨ ìƒíƒœ
let _csvFile = null;

function csvParse(){
  if(!_csvFile){ alert('íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
  // ë¶„ì„ ë²„íŠ¼ ì›ìƒë³µêµ¬ (ë‹¤ìŒ ë¹„CSV íŒŒì¼ì„ ìœ„í•´)
  const btn = document.getElementById('pdfAnalyzeBtn');
  if(btn){ btn.textContent = 'ğŸ” ë¶„ì„ ì‹œì‘'; btn.onclick = pdfAnalyze; }

  // ë¡œë”© í‘œì‹œ
  pdfShowStep(6);
  document.getElementById('csvProgressMsg').textContent = 'ğŸ“Š CSV íŒŒì¼ ì½ëŠ” ì¤‘...';
  document.getElementById('csvProgressBar').style.width = '10%';
  document.getElementById('csvProgressSub').textContent = `íŒŒì¼ í¬ê¸°: ${(_csvFile.size/1024/1024).toFixed(1)}MB`;

  const processText = text => {
    document.getElementById('csvProgressMsg').textContent = 'ğŸ“Š CSV íŒŒì‹± ì¤‘...';
    document.getElementById('csvProgressBar').style.width = '40%';
    setTimeout(()=>{
      try {
        const result = csvParseText(text);
        _csvHeaders = result.headers;
        _csvRawRows = result.rows;
        _csvMapping = csvAutoMap(_csvHeaders);
        document.getElementById('csvProgressBar').style.width = '100%';
        setTimeout(()=>{
          pdfShowStep(5);
          csvRenderMapping();
        }, 200);
      } catch(err){
        pdfShowStep(1);
        alert('CSV íŒŒì‹± ì˜¤ë¥˜: ' + err.message);
      }
    }, 50);
  };

  const reader = new FileReader();
  reader.onload = e => processText(e.target.result);
  reader.onerror = () => {
    const r2 = new FileReader();
    r2.onload = e2 => processText(e2.target.result);
    r2.onerror = () => { pdfShowStep(1); alert('íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); };
    r2.readAsText(_csvFile, 'EUC-KR');
  };
  reader.readAsText(_csvFile, 'UTF-8');
}

// ê°„ë‹¨í•˜ê³  ê²¬ê³ í•œ CSV íŒŒì„œ (ë”°ì˜´í‘œ ì²˜ë¦¬ í¬í•¨)
function csvParseText(text){
  // BOM ì œê±°
  if(text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
  const lines = [];
  let cur = '', inQ = false;
  for(let i=0; i<text.length; i++){
    const ch = text[i];
    if(ch==='"'){
      if(inQ && text[i+1]==='"'){ cur+='"'; i++; }
      else inQ = !inQ;
    } else if((ch==='\n'||ch==='\r') && !inQ){
      if(ch==='\r' && text[i+1]==='\n') i++;
      lines.push(cur); cur='';
    } else cur+=ch;
  }
  if(cur) lines.push(cur);

  const parseLine = line => {
    const cells=[]; let c='', iq=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch==='"'){
        if(iq && line[i+1]==='"'){c+='"';i++;}
        else iq=!iq;
      } else if(ch===',' && !iq){ cells.push(c.trim()); c=''; }
      else c+=ch;
    }
    cells.push(c.trim()); return cells;
  };

  if(!lines.length) throw new Error('ë¹ˆ íŒŒì¼ì…ë‹ˆë‹¤.');
  const headers = parseLine(lines[0]);
  const rows = [];
  for(let i=1;i<lines.length;i++){
    if(!lines[i].trim()) continue;
    const cells = parseLine(lines[i]);
    const row = {};
    headers.forEach((h,j)=>{ row[h] = cells[j]||''; });
    rows.push(row);
  }
  return {headers, rows};
}

// ì»¬ëŸ¼ëª… ìë™ ë§¤í•‘
function csvAutoMap(headers){
  const map = {};
  const lowers = headers.map(h=>h.toLowerCase().replace(/\s/g,''));
  Object.entries(CSV_AUTO_MAP).forEach(([field, candidates])=>{
    for(const c of candidates){
      const cl = c.toLowerCase().replace(/\s/g,'');
      const idx = lowers.findIndex(h=>h===cl || h.includes(cl) || cl.includes(h));
      if(idx>=0){ map[field] = headers[idx]; break; }
    }
  });
  return map;
}

// ë§¤í•‘ UI ë Œë”
function csvRenderMapping(){
  const area = document.getElementById('csvMappingArea');
  const previewInfo = document.getElementById('csvPreviewInfo');
  previewInfo.textContent = `ì´ ${_csvRawRows.length.toLocaleString()}í–‰ ê°ì§€ Â· ì•„ë˜ì—ì„œ ì»¬ëŸ¼ ë§¤í•‘ì„ í™•ì¸í•˜ì„¸ìš”.`;

  const opts = `<option value="">â€” ì‚¬ìš© ì•ˆ í•¨ â€”</option>`
    + _csvHeaders.map(h=>`<option value="${h.replace(/"/g,'&quot;')}">${h}</option>`).join('');

  let html = `<table style="width:100%;border-collapse:collapse;font-size:12px">
    <thead><tr>
      <th style="padding:6px 10px;text-align:left;background:var(--surface2);border-bottom:1px solid var(--border)">CRM í•„ë“œ</th>
      <th style="padding:6px 10px;text-align:left;background:var(--surface2);border-bottom:1px solid var(--border)">CSV ì»¬ëŸ¼ ë§¤í•‘</th>
      <th style="padding:6px 10px;text-align:left;background:var(--surface2);border-bottom:1px solid var(--border)">ë¯¸ë¦¬ë³´ê¸° (ì²« í–‰)</th>
    </tr></thead><tbody>`;

  Object.entries(CSV_FIELD_LABELS).forEach(([field, label])=>{
    const mapped = _csvMapping[field]||'';
    const preview = _csvRawRows[0]?.[mapped]||'';
    const sel = opts.replace(`value="${mapped}"`,`value="${mapped}" selected`);
    html += `<tr style="border-bottom:1px solid var(--border)">
      <td style="padding:6px 10px;font-weight:600;color:var(--accent);white-space:nowrap">${label}</td>
      <td style="padding:6px 10px">
        <select onchange="_csvMapping['${field}']=this.value;csvUpdatePreview()" style="background:var(--surface2);border:1px solid var(--border);border-radius:5px;color:var(--text);font-size:11px;padding:3px 6px;width:100%">
          ${sel}
        </select>
      </td>
      <td style="padding:6px 10px;color:var(--muted);font-size:11px;font-family:'IBM Plex Mono',monospace;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${preview||'â€”'}</td>
    </tr>`;
  });
  html += '</tbody></table>';
  area.innerHTML = html;
}

function csvUpdatePreview(){
  // ë¯¸ë¦¬ë³´ê¸° ê°’ë§Œ ê°±ì‹ 
  document.querySelectorAll('#csvMappingArea tbody tr').forEach((tr, idx)=>{
    const field = Object.keys(CSV_FIELD_LABELS)[idx];
    const mapped = _csvMapping[field]||'';
    const preview = _csvRawRows[0]?.[mapped]||'';
    const td = tr.querySelectorAll('td')[2];
    if(td) td.textContent = preview||'â€”';
  });
}

async function csvImport(){
  pdfShowStep(6);
  document.getElementById('csvProgressBar').style.width = '0%';
  document.getElementById('csvProgressMsg').textContent = 'ê°€ì ¸ì˜¤ëŠ” ì¤‘...';
  document.getElementById('csvProgressSub').textContent = `ì´ ${_csvRawRows.length.toLocaleString()}í–‰ ì²˜ë¦¬ ì‹œì‘`;
  await new Promise(r=>setTimeout(r,50));

  const total = _csvRawRows.length;
  let added = 0, skipped = 0, dupCount = 0;

  // ê¸°ì¡´ ì—°ë½ì²˜ ì´ë©”ì¼Â·ì´ë¦„ Set (ì¤‘ë³µ ê²€ì‚¬ìš©)
  const existEmails = new Set(contacts.map(c=>c.email||'').filter(Boolean).map(e=>e.toLowerCase()));
  const existNames  = new Set(contacts.map(c=>(c.last+c.first).replace(/\s/g,'')).filter(Boolean));

  const CHUNK = 500; // ë¸Œë¼ìš°ì € ë¸”ë¡œí‚¹ ë°©ì§€ìš© ì²­í¬
  for(let i=0; i<total; i++){
    const row = _csvRawRows[i];
    const get = field => {
      const col = _csvMapping[field];
      return col ? (row[col]||'').trim() : '';
    };

    // ì´ë¦„ ì²˜ë¦¬: ì„±/ì´ë¦„ ë¶„ë¦¬ or ì „ì²´ ì´ë¦„ì—ì„œ ë¶„ë¦¬
    let last  = get('last');
    let first = get('first');
    if(!last && !first){
      // full name ì»¬ëŸ¼ ì‹œë„
      const fullCols = ['Full Name','ì´ë¦„','Name','ì„±ëª…','DisplayName','display_name'];
      let full = '';
      for(const fc of fullCols){
        if(row[fc]){ full = row[fc].trim(); break; }
      }
      if(full){
        const parts = full.split(/\s+/);
        if(parts.length>=2){ last=parts[0]; first=parts.slice(1).join(' '); }
        else { last=full; }
      }
    }

    const email   = get('email').toLowerCase();
    const company = get('company');
    const mobile  = get('mobile');
    const office  = get('office');

    // ì¤‘ë³µ ì²´í¬ (ì´ë©”ì¼ ë˜ëŠ” ì´ë¦„)
    const nameKey = (last+first).replace(/\s/g,'');
    if(email && existEmails.has(email)){ dupCount++; skipped++; continue; }
    if(!email && nameKey && existNames.has(nameKey)){ dupCount++; skipped++; continue; }
    if(!last && !first && !email && !mobile && !office){ skipped++; continue; }

    const newId = uid();
    const co = company.trim();
    contacts.push({
      id: newId,
      createdAt: new Date().toISOString(),
      company: co,
      dept:     get('dept'),
      position: get('position'),
      last:     last  || '',
      first:    first || '',
      email:    get('email'),
      office:   office,
      mobile:   mobile,
      extra:    get('extra'),
      address:  get('address'),
      memo:     get('memo'),
    });
    if(co && !companies[co]) companies[co] = {};
    if(email) existEmails.add(email);
    if(nameKey) existNames.add(nameKey);
    added++;

    // ì§„í–‰ë°” ì—…ë°ì´íŠ¸ (ë§¤ CHUNKë§ˆë‹¤ UI ì–‘ë³´)
    if(i % CHUNK === 0){
      const pct = Math.round((i/total)*100);
      document.getElementById('csvProgressBar').style.width = pct+'%';
      document.getElementById('csvProgressMsg').textContent = `ê°€ì ¸ì˜¤ëŠ” ì¤‘... (${i.toLocaleString()} / ${total.toLocaleString()})`;
      document.getElementById('csvProgressSub').textContent = `ì¶”ê°€: ${added.toLocaleString()}ëª… Â· ì¤‘ë³µ ê±´ë„ˆëœ€: ${dupCount.toLocaleString()}ê±´`;
      await new Promise(r=>setTimeout(r,0)); // UI ì—…ë°ì´íŠ¸ ì–‘ë³´
    }
  }

  // ì €ì¥
  document.getElementById('csvProgressBar').style.width = '100%';
  document.getElementById('csvProgressMsg').textContent = 'ì €ì¥ ì¤‘...';
  await new Promise(r=>setTimeout(r,30));
  persist();
  renderContacts();
  refreshTeamFilterBars();

  // ì™„ë£Œ í™”ë©´
  pdfShowStep(7);
  document.getElementById('csvDoneMsg').textContent = `${added.toLocaleString()}ëª… ì¶”ê°€ ì™„ë£Œ!`;
  document.getElementById('csvDoneSub').innerHTML =
    `ì „ì²´ ${total.toLocaleString()}í–‰ ì²˜ë¦¬<br>`
    + (dupCount ? `ì¤‘ë³µ ê±´ë„ˆëœ€: ${dupCount.toLocaleString()}ê±´<br>` : '')
    + (skipped-dupCount ? `ë¹ˆ í–‰ ê±´ë„ˆëœ€: ${(skipped-dupCount).toLocaleString()}ê±´<br>` : '')
    + `<br>Supabase ì—°ë™ì´ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ë™ê¸°í™”ë©ë‹ˆë‹¤.`;
}

// â”€â”€ TYPE MANAGER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEFAULT_TYPE_IDS = ['order','quote','visit','call','other'];
let _editTypes = [];

function openTypeModal(){
  _editTypes = actTypes.map(t=>({...t}));
  renderTypeList();
  document.getElementById('typeModal').classList.add('open');
}

function renderTypeList(){
  const div = document.getElementById('typeList');
  div.innerHTML = _editTypes.map((t,i)=>{
    const isDef = DEFAULT_TYPE_IDS.includes(t.id);
    return `<div style="display:grid;grid-template-columns:36px 60px 1fr 120px auto;gap:8px;align-items:center;margin-bottom:8px">
      <div style="display:flex;flex-direction:column;gap:2px">
        ${i>0?`<button onclick="_editTypes.splice(${i}-1,0,_editTypes.splice(${i},1)[0]);renderTypeList()" style="background:none;border:1px solid var(--border);border-radius:4px;color:var(--muted);cursor:pointer;font-size:10px;padding:1px 4px;line-height:1">â–²</button>`:'<span></span>'}
        ${i<_editTypes.length-1?`<button onclick="_editTypes.splice(${i}+1,0,_editTypes.splice(${i},1)[0]);renderTypeList()" style="background:none;border:1px solid var(--border);border-radius:4px;color:var(--muted);cursor:pointer;font-size:10px;padding:1px 4px;line-height:1">â–¼</button>`:'<span></span>'}
      </div>
      <input value="${t.emoji}" maxlength="2" ${isDef?'readonly':''} onchange="_editTypes[${i}].emoji=this.value" style="padding:6px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:16px;text-align:center;outline:none;width:100%;${isDef?'opacity:.6':''}">
      <input value="${t.label}" ${isDef?'readonly':''} onchange="_editTypes[${i}].label=this.value" style="padding:6px 9px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:13px;font-family:inherit;outline:none;width:100%;${isDef?'opacity:.6':''}">
      <div style="display:flex;align-items:center;gap:6px">
        <input type="color" value="${t.color||'#7986cb'}" onchange="_editTypes[${i}].color=this.value" style="width:32px;height:28px;border:1px solid var(--border);border-radius:5px;background:var(--bg);cursor:pointer;padding:2px">
        <div style="width:20px;height:20px;border-radius:50%;background:${t.color||'#7986cb'}"></div>
      </div>
      ${isDef
        ? `<span style="font-size:11px;color:var(--muted);padding:0 8px">ê¸°ë³¸</span>`
        : `<button onclick="_editTypes.splice(${i},1);renderTypeList()" style="background:none;border:1px solid var(--border);border-radius:6px;color:var(--muted);cursor:pointer;font-size:13px;padding:4px 8px" onmouseover="this.style.borderColor='var(--danger)';this.style.color='var(--danger)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--muted)'">âœ•</button>`
      }
    </div>`;
  }).join('');
}

function addCustomType(){
  const emoji = document.getElementById('newTypeEmoji').value.trim()||'ğŸ”–';
  const label = document.getElementById('newTypeLabel').value.trim();
  const color = document.getElementById('newTypeColor').value;
  if(!label){ alert('ìœ í˜• ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  const id = 'custom_'+Date.now();
  _editTypes.push({id, label, emoji, color});
  document.getElementById('newTypeEmoji').value='';
  document.getElementById('newTypeLabel').value='';
  renderTypeList();
}

function saveTypes_modal(){
  actTypes = _editTypes;
  saveTypes(actTypes);
  rebuildTypeMaps();
  injectTypeStyles();
  refreshTypeSelect();
  refreshFilterBar();
  closeModal('typeModal');
  renderContacts();
}

function refreshTypeSelect(){
  const sel = document.getElementById('a_type');
  if(!sel) return;
  const cur = sel.value;
  sel.innerHTML = actTypes.map(t=>`<option value="${t.id}">${t.emoji} ${t.label}</option>`).join('');
  if(actTypes.find(t=>t.id===cur)) sel.value=cur;
}

function refreshFilterBar(){
  const bar = document.getElementById('actFilterBar');
  if(!bar) return;
  bar.innerHTML = `<button class="filter-chip${actFilter.size===0?' active':''}" data-val="all" onclick="setActFilter('all',this)">ì „ì²´</button>`
    + actTypes.map(t=>`<button class="filter-chip${actFilter.has(t.id)?' active':''}" data-val="${t.id}" onclick="setActFilter('${t.id}',this)">${t.emoji} ${t.label}</button>`).join('');
}

// â”€â”€ SUPABASE ì„¤ì • ëª¨ë‹¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openGsModal(){
  const urlIn  = document.getElementById('sbUrlInput');
  const keyIn  = document.getElementById('sbKeyInput');
  const status = document.getElementById('sbCurrentStatus');
  const discBtn= document.getElementById('sbDisconnectBtn');
  const curUrl = document.getElementById('sbCurrentUrl');
  const lastSy = document.getElementById('sbLastSyncInfo');

  urlIn.value = sbUrl;
  keyIn.value = sbKey;

  if(sbIsConnected()){
    status.style.display  = '';
    discBtn.style.display = '';
    curUrl.textContent    = sbUrl;
    lastSy.textContent    = sbLastSync ? 'ë§ˆì§€ë§‰ ë™ê¸°í™”: ' + sbLastSync : 'ì•„ì§ ë™ê¸°í™” ì•ˆ ë¨';
  } else {
    status.style.display  = 'none';
    discBtn.style.display = 'none';
  }
  document.getElementById('sbStatusMsg').textContent = '';
  document.getElementById('gsModal').classList.add('open');
}

function sbSaveSettings(){
  const url = document.getElementById('sbUrlInput').value.trim().replace(/\/$/,'');
  const key = document.getElementById('sbKeyInput').value.trim();
  const msg = document.getElementById('sbStatusMsg');

  if(!url || !key){
    msg.style.color = 'var(--accent2)';
    msg.textContent = 'âš  URLê³¼ API Keyë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.';
    return;
  }
  if(!url.includes('supabase.co')){
    msg.style.color = 'var(--accent2)';
    msg.textContent = 'âš  Supabase Project URLì´ ì•„ë‹Œ ê²ƒ ê°™ìŠµë‹ˆë‹¤.';
    return;
  }

  sbUrl = url;
  sbKey = key;
  localStorage.setItem('crm_sb_url', sbUrl);
  localStorage.setItem('crm_sb_key', sbKey);
  msg.style.color = 'var(--accent3)';
  msg.textContent = 'âœ… ì €ì¥ëìŠµë‹ˆë‹¤. Supabaseì—ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
  setTimeout(()=>{ closeModal('gsModal'); sbLoad(); }, 800);
}

function sbDisconnect(){
  sbUrl = ''; sbKey = '';
  localStorage.removeItem('crm_sb_url');
  localStorage.removeItem('crm_sb_key');
  sbUpdateStatus('offline', 'ë¡œì»¬ ì €ì¥ ëª¨ë“œ');
  closeModal('gsModal');
}

function sbManualLoad(){
  if(!sbUrl || !sbKey){
    document.getElementById('sbStatusMsg').textContent = 'ë¨¼ì € URLê³¼ Keyë¥¼ ì…ë ¥í•˜ê³  ì €ì¥í•´ì£¼ì„¸ìš”.';
    return;
  }
  closeModal('gsModal');
  sbLoad();
}

// â”€â”€ ì—°ê²° ì§„ë‹¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sbDiagnose(){
  const msg = document.getElementById('sbStatusMsg');
  const url = (document.getElementById('sbUrlInput').value||'').trim().replace(/\/$/,'') || sbUrl;
  const key = (document.getElementById('sbKeyInput').value||'').trim() || sbKey;

  if(!url || !key){
    msg.style.color='var(--accent2)';
    msg.innerHTML='âš  URLê³¼ Keyë¥¼ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.';
    return;
  }
  msg.style.color='var(--muted)';
  msg.innerHTML='ğŸ” ì§„ë‹¨ ì¤‘...';

  const results = [];
  const h = { 'apikey': key, 'Authorization': 'Bearer ' + key };

  // 1. contacts ì½ê¸°
  try {
    const r = await fetch(`${url}/rest/v1/contacts?select=id&limit=1`, {headers:h});
    if(r.ok){ const d=await r.json(); results.push(`âœ… contacts ì—°ê²° ì„±ê³µ (DBë‚´ ${d.length}í–‰)`); }
    else { const t=await r.text(); results.push(`âŒ contacts ì‹¤íŒ¨ (${r.status}): ${t.slice(0,100)}`); }
  } catch(e){ results.push(`âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${e.message}`); }

  // 2. activities ì½ê¸°
  try {
    const r = await fetch(`${url}/rest/v1/activities?select=id&limit=1`, {headers:h});
    if(r.ok){ const d=await r.json(); results.push(`âœ… activities ì—°ê²° ì„±ê³µ (DBë‚´ ${d.length}í–‰)`); }
    else { const t=await r.text(); results.push(`âŒ activities ì‹¤íŒ¨ (${r.status}): ${t.slice(0,100)}`); }
  } catch(e){ results.push(`âŒ activities ì˜¤ë¥˜: ${e.message}`); }

  // 3. ì“°ê¸° í…ŒìŠ¤íŠ¸
  try {
    const testId = '__test__'+Date.now();
    const r = await fetch(`${url}/rest/v1/contacts`, {
      method:'POST',
      headers:{...h,'Content-Type':'application/json','Prefer':'return=minimal'},
      body: JSON.stringify([{id:testId,company:'__ì§„ë‹¨__',last:'í…Œ',first:'ìŠ¤íŠ¸',dept:'',position:'',email:'',office:'',mobile:'',extra:'',address:'',memo:'',created_at:new Date().toISOString()}])
    });
    if(r.ok||r.status===201){
      results.push('âœ… ì“°ê¸° ê¶Œí•œ í™•ì¸');
      await fetch(`${url}/rest/v1/contacts?id=eq.${testId}`,{method:'DELETE',headers:{...h,'Prefer':'return=minimal'}});
    } else {
      const t=await r.text();
      results.push(`âŒ ì“°ê¸° ê¶Œí•œ ì—†ìŒ (${r.status}): ${t.slice(0,100)}`);
      results.push('â†’ Supabase SQL Editorì—ì„œ SQLì„ ë‹¤ì‹œ ì‹¤í–‰í•´ì£¼ì„¸ìš”');
    }
  } catch(e){ results.push(`âŒ ì“°ê¸° í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ${e.message}`); }

  msg.style.color = results.every(r=>r.startsWith('âœ…')) ? 'var(--accent3)' : 'var(--accent2)';
  msg.innerHTML = results.join('<br>');
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
injectTypeStyles();
refreshTypeSelect();
refreshFilterBar();
refreshTeamFilterBars();
renderStats();
renderContacts();

// Supabase ì—°ë™ ì‹œ ìë™ ë™ê¸°í™”
if(sbIsConnected()){
  sbUpdateStatus('syncing', 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
  sbLoad();
} else {
  sbUpdateStatus('offline', 'ë¡œì»¬ ì €ì¥ ëª¨ë“œ Â· ğŸ—„ í´ë¦­í•´ì„œ Supabase ì—°ë™');
}
</script>
</body>
</html>
